# v0.8.0 — GitLab CI/CD Platform

> **Release:** v0.8.0
> **Phase:** 4.6
> **Goal:** Deploy self-hosted GitLab with Runner, Container Registry, and CI/CD pipelines
> **Prerequisite:** [v0.7.0-cloudflare.md](v0.7.0-cloudflare.md) completed

---

## Overview

This release deploys a complete CI/CD platform:
- **GitLab CE v18.8.2** — Self-hosted Git + CI/CD
- **GitLab Runner** — Kubernetes executor for CI jobs
- **Container Registry** — Private Docker registry
- **Gateway API exposure** — HTTPRoutes for web and registry

**Security:** INTERNAL ACCESS ONLY — No Cloudflare Tunnel route. Access via home network or Tailscale.

---

## Important: Deployment Context

> **This is a LEARNING/POC deployment, NOT production-ready.**
>
> The GitLab Helm chart's default configuration deploys all components (PostgreSQL, Redis,
> Gitaly) inside the cluster. This is explicitly NOT supported for production.
>
> **For Production:** PostgreSQL, Redis, and Gitaly must run OUTSIDE the cluster.
>
> **For this homelab:** In-cluster deployment is acceptable for learning Kubernetes concepts,
> CI/CD workflows, and Helm chart management.

---

## Prerequisites

### 1Password Items Required

Create this item in the **Kubernetes** vault:

| Item Name | Type | Fields |
|-----------|------|--------|
| GitLab | Login | username (`git@rommelporras.com`), password, postgresql-password, runner-token (add after install) |

Generate passwords:
```bash
ROOT_PASS=$(openssl rand -base64 24)
PG_PASS=$(openssl rand -base64 24)
echo "Root password: $ROOT_PASS"
echo "PostgreSQL password: $PG_PASS"
# Add both to 1Password GitLab item
```

### Resource Requirements

| Component | CPU Request | Memory Request | Storage |
|-----------|-------------|----------------|---------|
| PostgreSQL | 250m | 512Mi | 15Gi |
| Redis | 100m | 256Mi | 5Gi |
| Gitaly | 250m | 512Mi | 50Gi |
| Webservice | 500m | 1.5Gi | - |
| Sidekiq | 250m | 512Mi | - |
| Registry | 100m | 256Mi | 20Gi |
| **Total** | ~1.5 CPU | ~3.5Gi requests | ~90Gi |

**Actual usage:** Plan for ~8-10GB RAM available across cluster.

---

## Step 1: Prerequisites

```bash
# Verify cluster resources
kubectl-homelab top nodes

# Check Longhorn capacity (need ~100GB)
kubectl-homelab -n longhorn-system get nodes.longhorn.io \
  -o custom-columns=NAME:.metadata.name,AVAIL:.status.diskStatus.default-disk.storageAvailable

# Add GitLab Helm repo
helm-homelab repo add gitlab https://charts.gitlab.io --force-update
helm-homelab repo update gitlab

# Check available versions
helm-homelab search repo gitlab/gitlab --versions | head -10
# Chart 9.8.2 = GitLab v18.8.2

# Create namespaces
kubectl-homelab create namespace gitlab
kubectl-homelab label namespace gitlab pod-security.kubernetes.io/enforce=privileged

kubectl-homelab create namespace gitlab-runner
kubectl-homelab label namespace gitlab-runner pod-security.kubernetes.io/enforce=privileged
```

---

## Step 2: Create Secrets

```bash
# Root password secret
kubectl-homelab create secret generic gitlab-root-password \
  --from-literal=password="$(op read 'op://Kubernetes/GitLab/password')" \
  -n gitlab

# PostgreSQL password secret
kubectl-homelab create secret generic gitlab-postgresql-password \
  --from-literal=postgresql-password="$(op read 'op://Kubernetes/GitLab/postgresql-password')" \
  -n gitlab
```

**Verify:**
```bash
kubectl-homelab get secrets -n gitlab
kubectl-homelab get secret gitlab-root-password -n gitlab -o jsonpath='{.data}' | jq 'keys'
# Should show: ["password"]
```

---

## Step 3: Create Helm Values

**helm/gitlab/values.yaml:**

```yaml
# GitLab Helm Chart Configuration for Homelab
# Chart version: 9.8.2 (GitLab v18.8.2)

global:
  edition: ce

  hosts:
    domain: k8s.rommelporras.com
    gitlab:
      name: gitlab.k8s.rommelporras.com
      https: true
    registry:
      name: registry.k8s.rommelporras.com
      https: true
    externalIP: null

  # Disable ingress (we use Cilium Gateway API)
  ingress:
    enabled: false
    configureCertmanager: false

  # Secrets
  initialRootPassword:
    secret: gitlab-root-password
    key: password

  psql:
    password:
      secret: gitlab-postgresql-password
      key: postgresql-password

  shell:
    port: 22

  time_zone: America/Los_Angeles

# Disable bundled components we don't need
nginx-ingress:
  enabled: false

certmanager:
  install: false

prometheus:
  install: false

gitlab-runner:
  install: false

# In-cluster stateful components
postgresql:
  install: true
  persistence:
    storageClass: longhorn
    size: 15Gi
  primary:
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi

redis:
  install: true
  persistence:
    storageClass: longhorn
    size: 5Gi
  master:
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

# GitLab core components
gitlab:
  gitaly:
    persistence:
      storageClass: longhorn
      size: 50Gi
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1.5Gi

  webservice:
    minReplicas: 1
    maxReplicas: 2
    resources:
      requests:
        cpu: 500m
        memory: 1.5Gi
      limits:
        cpu: 2000m
        memory: 3Gi
    workhorse:
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi

  sidekiq:
    minReplicas: 1
    maxReplicas: 2
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1.5Gi

  gitlab-shell:
    minReplicas: 1
    maxReplicas: 2

  toolbox:
    enabled: true

  migrations:
    enabled: true

# Container Registry
registry:
  enabled: true
  storage:
    secret: null
  persistence:
    enabled: true
    storageClass: longhorn
    size: 20Gi
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
```

---

## Step 4: Install GitLab

```bash
helm-homelab install gitlab gitlab/gitlab \
  --namespace gitlab \
  --version 9.8.2 \
  --values helm/gitlab/values.yaml \
  --timeout 15m
```

**Monitor installation:**
```bash
# Watch pods
kubectl-homelab get pods -n gitlab -w

# Wait for critical components
kubectl-homelab wait --for=condition=ready pod -l app.kubernetes.io/name=postgresql \
  -n gitlab --timeout=300s && echo "✓ PostgreSQL ready"

kubectl-homelab wait --for=condition=ready pod -l app.kubernetes.io/name=redis \
  -n gitlab --timeout=300s && echo "✓ Redis ready"

kubectl-homelab wait --for=condition=ready pod -l app=gitaly \
  -n gitlab --timeout=300s && echo "✓ Gitaly ready"

kubectl-homelab wait --for=condition=ready pod -l app=webservice \
  -n gitlab --timeout=600s && echo "✓ Webservice ready"
```

**Verify StatefulSets:**
```bash
kubectl-homelab get statefulsets -n gitlab
# gitlab-gitaly, gitlab-postgresql, gitlab-redis-master should all be ready
```

---

## Step 5: Create HTTPRoutes

### 5.1 GitLab Web (manifests/gateway/routes/gitlab.yaml)

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: gitlab
  namespace: gitlab
spec:
  parentRefs:
    - name: homelab-gateway
      namespace: default
  hostnames:
    - "gitlab.k8s.rommelporras.com"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: gitlab-webservice-default
          port: 8181
```

### 5.2 Container Registry (manifests/gateway/routes/gitlab-registry.yaml)

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: gitlab-registry
  namespace: gitlab
spec:
  parentRefs:
    - name: homelab-gateway
      namespace: default
  hostnames:
    - "registry.k8s.rommelporras.com"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: gitlab-registry
          port: 5000
```

**Apply:**
```bash
kubectl-homelab apply -f manifests/gateway/routes/gitlab.yaml
kubectl-homelab apply -f manifests/gateway/routes/gitlab-registry.yaml

# Verify
kubectl-homelab get httproute -n gitlab
```

### 5.3 Configure DNS (AdGuard)

Add DNS rewrites in AdGuard:
```
gitlab.k8s.rommelporras.com → 10.10.30.20
registry.k8s.rommelporras.com → 10.10.30.20
```

---

## Step 6: Configure GitLab Shell (SSH Access)

For git+ssh access, create a LoadBalancer service:

**manifests/gitlab/gitlab-shell-lb.yaml:**
```yaml
apiVersion: v1
kind: Service
metadata:
  name: gitlab-shell-lb
  namespace: gitlab
  annotations:
    lbipam.cilium.io/ips: "10.10.30.56"
spec:
  type: LoadBalancer
  selector:
    app: gitlab-shell
  ports:
    - name: ssh
      port: 22
      targetPort: 2222
      protocol: TCP
```

```bash
kubectl-homelab apply -f manifests/gitlab/gitlab-shell-lb.yaml
```

Configure SSH in `~/.ssh/config`:
```
Host gitlab.k8s.rommelporras.com
    HostName 10.10.30.56
    User git
    Port 22
```

---

## Step 7: Verify GitLab Access

```bash
# Test DNS
nslookup gitlab.k8s.rommelporras.com

# Test HTTP
curl -I https://gitlab.k8s.rommelporras.com
```

**Access GitLab Web UI:**
```
https://gitlab.k8s.rommelporras.com
Login: git@rommelporras.com / (password from 1Password)
```

**First login tasks:**
1. Enable 2FA (Profile → Edit Profile → Two-factor Authentication)
2. Set email in Admin Area → Settings → General

---

## Step 8: Install GitLab Runner

### 8.1 Create Runner in GitLab UI

```
1. Admin Area → CI/CD → Runners
2. Click "New instance runner"
3. Configure:
   - Tags: kubernetes, homelab
   - Run untagged jobs: ✓
   - Protected: ✗
4. Click "Create runner"
5. Copy authentication token (starts with glrt-)
```

### 8.2 Store Token and Create Secret

```bash
# Add glrt-xxx token to 1Password GitLab item as 'runner-token'

# Create secret
kubectl-homelab create secret generic gitlab-runner-token \
  --from-literal=runner-token="$(op read 'op://Kubernetes/GitLab/runner-token')" \
  -n gitlab-runner
```

### 8.3 Create Runner Values

**helm/gitlab-runner/values.yaml:**
```yaml
# GitLab Runner with Kubernetes Executor
# Chart version: 0.85.0 (Runner 18.8.0)

gitlabUrl: https://gitlab.k8s.rommelporras.com

runners:
  secret: gitlab-runner-token

  config: |
    [[runners]]
      [runners.kubernetes]
        namespace = "gitlab-runner"
        image = "alpine:latest"
        privileged = true  # Required for Docker-in-Docker

        cpu_limit = "2"
        cpu_request = "500m"
        memory_limit = "2Gi"
        memory_request = "512Mi"

        helper_cpu_limit = "500m"
        helper_cpu_request = "100m"
        helper_memory_limit = "256Mi"
        helper_memory_request = "128Mi"

        pull_policy = ["if-not-present"]

        [runners.kubernetes.pod_labels]
          "gitlab-runner" = "true"

rbac:
  create: true
  clusterWideAccess: true

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 256Mi
```

### 8.4 Install Runner

```bash
helm-homelab install gitlab-runner gitlab/gitlab-runner \
  --namespace gitlab-runner \
  --version 0.85.0 \
  --values helm/gitlab-runner/values.yaml
```

### 8.5 Verify Runner

```bash
# Check pod
kubectl-homelab get pods -n gitlab-runner

# Check logs
kubectl-homelab logs -n gitlab-runner -l app=gitlab-runner --tail=50

# Verify in GitLab UI: Admin Area → CI/CD → Runners (should show "online")
```

---

## Step 9: Test CI/CD Pipeline

### 9.1 Create Test Project

```
GitLab → New Project → Create blank project
Name: ci-test
Initialize with README: ✓
```

### 9.2 Add .gitlab-ci.yml

```yaml
stages:
  - test

test-job:
  stage: test
  image: alpine:latest
  script:
    - echo "Hello from GitLab CI!"
    - echo "Runner is working correctly"
    - cat /etc/os-release
```

### 9.3 Verify Pipeline

1. Commit the file
2. Go to CI/CD → Pipelines
3. Watch pipeline execute
4. Verify job completes successfully

---

## Step 10: Test Container Registry

```bash
# Login
docker login registry.k8s.rommelporras.com
# Username: git@rommelporras.com
# Password: your GitLab password

# Test push
docker pull alpine:latest
docker tag alpine:latest registry.k8s.rommelporras.com/test/alpine:latest
docker push registry.k8s.rommelporras.com/test/alpine:latest

# Test pull
docker rmi registry.k8s.rommelporras.com/test/alpine:latest
docker pull registry.k8s.rommelporras.com/test/alpine:latest
```

---

## CI/CD for Next.js Projects

### Dockerfile (multi-stage)

```dockerfile
FROM node:20-alpine AS deps
WORKDIR /app
COPY package.json package-lock.json* ./
RUN npm ci --only=production

FROM node:20-alpine AS builder
WORKDIR /app
COPY package.json package-lock.json* ./
RUN npm ci
COPY . .
ENV NEXT_TELEMETRY_DISABLED=1
RUN npm run build

FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
USER nextjs
EXPOSE 3000
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"
CMD ["node", "server.js"]
```

Requires `output: 'standalone'` in `next.config.js`.

### .gitlab-ci.yml for Docker Build

```yaml
stages:
  - build
  - deploy

variables:
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
  IMAGE_LATEST: ${CI_REGISTRY_IMAGE}:latest

build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
    - docker push $IMAGE_TAG
    - docker push $IMAGE_LATEST
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

deploy:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl set image deployment/${CI_PROJECT_NAME} app=$IMAGE_TAG -n ${CI_PROJECT_NAME}
    - kubectl rollout status deployment/${CI_PROJECT_NAME} -n ${CI_PROJECT_NAME} --timeout=300s
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
```

---

## Verification Checklist

- [ ] Namespace `gitlab` exists with privileged PSS
- [ ] Namespace `gitlab-runner` exists with privileged PSS
- [ ] All GitLab pods running: `kubectl-homelab get pods -n gitlab`
- [ ] StatefulSets healthy: postgresql, redis, gitaly
- [ ] PVCs bound: `kubectl-homelab get pvc -n gitlab`
- [ ] HTTPRoutes accepted: `kubectl-homelab get httproute -n gitlab`
- [ ] DNS resolves: `nslookup gitlab.k8s.rommelporras.com`
- [ ] GitLab web UI accessible
- [ ] Can login as git@rommelporras.com
- [ ] 2FA configured for root account
- [ ] Container registry accessible
- [ ] Docker login to registry works
- [ ] GitLab Runner showing "online" in Admin → CI/CD → Runners
- [ ] Test pipeline runs successfully
- [ ] SSH access works: `ssh -T git@gitlab.k8s.rommelporras.com`
- [ ] 1Password items created (username, password, postgresql-password, runner-token)

---

## Troubleshooting

### GitLab pods stuck in Pending

```bash
# Check PVCs
kubectl-homelab get pvc -n gitlab

# Check Longhorn
kubectl-homelab -n longhorn-system get volumes
```

### GitLab web UI returns 502

```bash
# Check webservice pod
kubectl-homelab logs -n gitlab -l app=webservice --tail=100

# GitLab takes 10-15 minutes to fully initialize after pods are "Ready"
```

### Runner not registering (410 Gone error)

```bash
# This means you're using OLD registration token workflow
# Need to use NEW authentication token (glrt-xxx)

# Verify secret has correct key
kubectl-homelab get secret gitlab-runner-token -n gitlab-runner -o yaml
# Should have key: runner-token

# Verify token format
kubectl-homelab get secret gitlab-runner-token -n gitlab-runner \
  -o jsonpath='{.data.runner-token}' | base64 -d | head -c 5
# Should show: glrt-
```

### Registry push/pull fails

```bash
# Test registry connectivity
curl -v https://registry.k8s.rommelporras.com/v2/

# Check registry pod
kubectl-homelab logs -n gitlab -l app=registry --tail=50
```

---

## Rollback

```bash
# Partial cleanup (keeps PVCs)
helm-homelab uninstall gitlab -n gitlab

# Complete uninstall (WARNING: deletes all data)
helm-homelab uninstall gitlab -n gitlab
kubectl-homelab delete pvc --all -n gitlab
kubectl-homelab delete namespace gitlab

# Clean up runner
helm-homelab uninstall gitlab-runner -n gitlab-runner
kubectl-homelab delete namespace gitlab-runner
```

---

## Files Reference

| File | Purpose |
|------|---------|
| `helm/gitlab/values.yaml` | GitLab Helm values |
| `helm/gitlab-runner/values.yaml` | Runner Helm values |
| `manifests/gateway/routes/gitlab.yaml` | GitLab HTTPRoute |
| `manifests/gateway/routes/gitlab-registry.yaml` | Registry HTTPRoute |
| `manifests/gitlab/gitlab-shell-lb.yaml` | SSH LoadBalancer |

---

## Backup Strategy

### Longhorn Snapshots

```bash
kubectl-homelab -n longhorn-system get volumes | grep gitlab
# Use Longhorn UI to create snapshots before upgrades
```

### GitLab Backup Task

```bash
kubectl-homelab exec -n gitlab -it $(kubectl-homelab get pods -n gitlab -l app=toolbox -o name) \
  -- backup-utility --skip registry
```

---

## Next Steps

- Import repositories from GitHub
- Configure CI/CD for your Next.js projects
- Set up deploy tokens for K8s image pull secrets
- Consider ArgoCD/FluxCD for GitOps workflows
