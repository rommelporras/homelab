# v0.7.0 — Cloudflare Tunnel Migration

> **Release:** v0.7.0
> **Phase:** 4.5
> **Goal:** Migrate cloudflared from LXC to K8s for HA external access
> **Prerequisite:** [v0.6.0-home-services.md](v0.6.0-home-services.md) completed

---

## Overview

This release migrates Cloudflare Tunnel from LXC to Kubernetes:
- **2 cloudflared pods** — Running on separate nodes for HA
- **Zero-trust networking** — No port forwarding required
- **Security isolation** — CiliumNetworkPolicy restricts tunnel to public services only
- **Prometheus monitoring** — ServiceMonitor for tunnel metrics

**Result:** 8 QUIC connections to Cloudflare Edge, automatic failover on node failure.

---

## Prerequisites

### 1Password Items Required

Create this item in the **Kubernetes** vault:

| Item Name | Type | Fields |
|-----------|------|--------|
| Cloudflare Tunnel | Login | token (tunnel authentication token from Cloudflare dashboard) |

### Get Tunnel Token

```
1. Go to: https://one.dash.cloudflare.com/
2. Zero Trust → Networks → Tunnels
3. Select your tunnel → Configure
4. Click "Token" tab → Copy token
```

---

## Step 1: Create Cloudflare Namespace

```bash
kubectl-homelab create namespace cloudflare
kubectl-homelab label namespace cloudflare pod-security.kubernetes.io/enforce=restricted
```

> **Note:** Using `restricted` PSS (strictest) because cloudflared runs as non-root.

---

## Step 2: Create Tunnel Secret

```bash
# Store token in 1Password first, then:
kubectl-homelab create secret generic cloudflared-token \
  --from-literal=token="$(op read 'op://Kubernetes/Cloudflare Tunnel/token')" \
  -n cloudflare
```

**Verify:**
```bash
kubectl-homelab get secret cloudflared-token -n cloudflare
```

---

## Step 3: Create Manifests

### 3.1 Manifests Structure

```
manifests/cloudflare/
├── deployment.yaml       # 2 replicas, anti-affinity, probes
├── pdb.yaml              # PodDisruptionBudget (minAvailable: 1)
├── service.yaml          # Metrics endpoint for Prometheus
├── servicemonitor.yaml   # Prometheus scraping
└── networkpolicy.yaml    # CiliumNetworkPolicy (security isolation)
```

### 3.2 Deployment (manifests/cloudflare/deployment.yaml)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloudflared
  namespace: cloudflare
  labels:
    app: cloudflared
spec:
  replicas: 2
  selector:
    matchLabels:
      app: cloudflared
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  template:
    metadata:
      labels:
        app: cloudflared
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "2000"
        prometheus.io/path: "/metrics"
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65532
        runAsGroup: 65532
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
        sysctls:
        - name: net.ipv4.ping_group_range
          value: "65532 65532"
      containers:
      - name: cloudflared
        image: cloudflare/cloudflared:2026.1.1
        args:
          - tunnel
          - --no-autoupdate
          - --loglevel
          - info
          - --metrics
          - 0.0.0.0:2000
          - run
          - --token
          - $(TUNNEL_TOKEN)
        env:
        - name: TUNNEL_TOKEN
          valueFrom:
            secretKeyRef:
              name: cloudflared-token
              key: token
        ports:
        - name: metrics
          containerPort: 2000
          protocol: TCP
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL
        livenessProbe:
          httpGet:
            path: /ready
            port: 2000
          initialDelaySeconds: 10
          periodSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /ready
            port: 2000
          initialDelaySeconds: 5
          periodSeconds: 5
          failureThreshold: 2
      # REQUIRED anti-affinity: pods MUST be on different nodes
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app: cloudflared
            topologyKey: kubernetes.io/hostname
```

### 3.3 PodDisruptionBudget (manifests/cloudflare/pdb.yaml)

```yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: cloudflared
  namespace: cloudflare
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: cloudflared
```

### 3.4 Service (manifests/cloudflare/service.yaml)

```yaml
apiVersion: v1
kind: Service
metadata:
  name: cloudflared
  namespace: cloudflare
  labels:
    app: cloudflared
spec:
  selector:
    app: cloudflared
  ports:
  - name: metrics
    port: 2000
    targetPort: 2000
    protocol: TCP
```

### 3.5 ServiceMonitor (manifests/cloudflare/servicemonitor.yaml)

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: cloudflared
  namespace: cloudflare
  labels:
    app: cloudflared
    release: prometheus
spec:
  selector:
    matchLabels:
      app: cloudflared
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
```

### 3.6 CiliumNetworkPolicy (manifests/cloudflare/networkpolicy.yaml)

**Critical:** This policy restricts cloudflared to only reach public-facing services.

```yaml
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: cloudflared-egress
  namespace: cloudflare
spec:
  endpointSelector:
    matchLabels:
      app: cloudflared
  egress:
  # 1. Allow DNS
  - toEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: kube-system
        k8s-app: kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP

  # 2. Allow Cloudflare Edge ONLY (block all private ranges)
  - toCIDRSet:
    - cidr: 0.0.0.0/0
      except:
      - 10.0.0.0/8      # Block all private 10.x.x.x
      - 172.16.0.0/12   # Block private 172.16-31.x.x
      - 192.168.0.0/16  # Block private 192.168.x.x
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
      - port: "7844"
        protocol: TCP
      - port: "7844"
        protocol: UDP

  # 3. Allow portfolio namespace (www.rommelporras.com)
  - toEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: portfolio
    toPorts:
    - ports:
      - port: "80"
        protocol: TCP

  # 4. Allow invoicetron namespace
  - toEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: invoicetron
    toPorts:
    - ports:
      - port: "3000"
        protocol: TCP

  # IMPLICIT DENY: Everything else blocked
  # - Cannot reach gitlab namespace
  # - Cannot reach monitoring namespace (grafana, prometheus)
  # - Cannot reach longhorn-system
  # - Cannot reach NAS (10.10.30.4)
```

---

## Step 4: Deploy

```bash
kubectl-homelab apply -f manifests/cloudflare/
```

**Verify:**
```bash
# Wait for pods
kubectl-homelab rollout status deployment/cloudflared -n cloudflare --timeout=120s

# Verify pods on different nodes
kubectl-homelab get pods -n cloudflare -o wide

# Check logs
kubectl-homelab logs -n cloudflare -l app=cloudflared --tail=20
# Look for: "Connection registered" or "Registered tunnel connection"

# Verify PDB
kubectl-homelab get pdb -n cloudflare
# ALLOWED DISRUPTIONS = 1, MIN AVAILABLE = 1
```

---

## Step 5: Configure Tunnel Routes (Cloudflare Dashboard)

Routes are configured in Cloudflare dashboard, not K8s manifests.

```
https://one.dash.cloudflare.com/
→ Zero Trust → Networks → Tunnels
→ Select your tunnel → Public Hostname tab
```

**Verify:**
- Status: Healthy
- Connectors: 2 (one per K8s pod)

**Route examples:**
| Public Hostname | Service |
|-----------------|---------|
| www.rommelporras.com | http://portfolio.portfolio.svc.cluster.local:80 |
| invoicetron.rommelporras.com | http://invoicetron.invoicetron.svc.cluster.local:3000 |

**NOT exposed via tunnel (internal only):**
- gitlab.k8s.home.rommelporras.com
- grafana.k8s.home.rommelporras.com
- adguard.k8s.home.rommelporras.com
- longhorn.k8s.home.rommelporras.com

---

## Step 6: Security Validation Testing

**Critical:** Run the penetration test script to verify NetworkPolicy works.

```bash
./scripts/test-cloudflare-networkpolicy.sh
```

**Expected Results (37 tests):**
```
Passed:   37
Failed:   0
Warnings: 1 (UDP test inconclusive - expected)

✅ SECURITY VALIDATION PASSED
```

### Manual Test Commands

If running manually, exec into a test pod:

```bash
kubectl-homelab run netpol-test \
  --namespace=cloudflare \
  --labels="app=cloudflared" \
  --image=nicolaka/netshoot \
  --rm -it --restart=Never \
  -- /bin/bash
```

**Test BLOCKED connections (must timeout):**
```bash
# NAS (MUST FAIL)
nc -zv 10.10.30.4 443 -w 5

# Grafana (MUST FAIL)
nc -zv prometheus-grafana.monitoring.svc.cluster.local 80 -w 5

# K8s API (MUST FAIL)
nc -zv kubernetes.default.svc.cluster.local 443 -w 5
```

---

## Step 7: Migrate from LXC

**Strategy:** Run K8s alongside LXC briefly, then cut over.

### 7.1 Verify Both Endpoints Active

Check Cloudflare dashboard shows 3 connectors:
- 1 from LXC (existing)
- 2 from K8s (new)

### 7.2 Stop LXC cloudflared

```bash
ssh pve "pct stop <cloudflared-lxc-id>"
```

### 7.3 Verify No Downtime

- Cloudflare dashboard: 2 connectors, Healthy
- Test public hostnames still work

### 7.4 Delete LXC (after 1 week stable)

```bash
ssh pve "pct destroy <cloudflared-lxc-id>"
```

---

## Verification Checklist

- [ ] Namespace `cloudflare` exists with restricted PSS
- [ ] Secret `cloudflared-token` created
- [ ] 2 cloudflared pods running on **different nodes**
- [ ] Pods running as non-root (UID 65532)
- [ ] PodDisruptionBudget created (minAvailable: 1)
- [ ] CiliumNetworkPolicy `cloudflared-egress` applied
- [ ] Cloudflare dashboard shows tunnel "Healthy" with 2 connectors
- [ ] Public hostnames accessible from external network
- [ ] ServiceMonitor created and Prometheus scraping metrics
- [ ] **Security tests passed** (37/37)
- [ ] LXC cloudflared stopped
- [ ] No downtime during migration

---

## Prometheus Metrics

Key metrics available:
- `cloudflared_tunnel_total_requests`
- `cloudflared_tunnel_request_errors`
- `cloudflared_tunnel_response_by_code`
- `cloudflared_tunnel_concurrent_requests_per_tunnel`

---

## Rollback

If issues after stopping LXC:

```bash
# 1. Restart LXC (immediate recovery)
ssh pve "pct start <cloudflared-lxc-id>"

# 2. Debug K8s deployment
kubectl-homelab logs -n cloudflare -l app=cloudflared
kubectl-homelab describe pods -n cloudflare

# 3. If needed, delete and recreate:
kubectl-homelab delete deployment cloudflared -n cloudflare
kubectl-homelab apply -f manifests/cloudflare/deployment.yaml
```

---

## Troubleshooting

### Tunnel shows "Degraded" or "Down"

```bash
# Check pod status
kubectl-homelab get pods -n cloudflare

# Check logs for connection errors
kubectl-homelab logs -n cloudflare -l app=cloudflared | grep -i error

# Common issues:
# - Invalid token → recreate secret from 1Password
# - Network issues → check Cilium connectivity
```

### Only 1 connector in Cloudflare

```bash
# Check if both pods running
kubectl-homelab get pods -n cloudflare -o wide

# With required anti-affinity, if only 1 pod:
# - Check if a node is down/drained
kubectl-homelab get nodes

# Check pod events
kubectl-homelab describe pods -n cloudflare | grep -A10 Events
```

### Routes not working (502 Bad Gateway)

```bash
# Verify target service exists
kubectl-homelab get svc -A | grep <service-name>
kubectl-homelab get endpoints <service-name> -n <namespace>

# Test from inside cluster
kubectl-homelab run test --rm -it --image=curlimages/curl -- \
  curl -v http://SERVICE.NAMESPACE.svc.cluster.local:PORT
```

---

## Files Reference

| File | Purpose |
|------|---------|
| `manifests/cloudflare/deployment.yaml` | cloudflared deployment |
| `manifests/cloudflare/pdb.yaml` | PodDisruptionBudget |
| `manifests/cloudflare/service.yaml` | Metrics service |
| `manifests/cloudflare/servicemonitor.yaml` | Prometheus scraping |
| `manifests/cloudflare/networkpolicy.yaml` | Security isolation |
| `scripts/test-cloudflare-networkpolicy.sh` | Security validation tests |

---

## Security Features

| Feature | Implementation |
|---------|----------------|
| Non-root execution | `runAsUser: 65532` |
| Read-only filesystem | `readOnlyRootFilesystem: true` |
| No privilege escalation | `allowPrivilegeEscalation: false` |
| Minimal capabilities | `capabilities.drop: ["ALL"]` |
| Seccomp profile | `seccompProfile.type: RuntimeDefault` |
| Pod Security Standard | `restricted` namespace label |
| Network isolation | CiliumNetworkPolicy (egress-only) |
| Required anti-affinity | Guaranteed HA across nodes |

---

## Next Steps

- [v0.8.0-gitlab.md](v0.8.0-gitlab.md) — GitLab CI/CD platform with Runner and Registry
