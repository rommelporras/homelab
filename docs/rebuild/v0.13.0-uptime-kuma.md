# v0.13.0 ‚Äî Uptime Kuma Monitoring

> **Release:** v0.13.0
> **Phase:** 4.14
> **Goal:** Self-hosted endpoint monitoring with public status page
> **Prerequisite:** [v0.12.0-domain-migration.md](v0.12.0-domain-migration.md) completed

---

## Overview

This release deploys Uptime Kuma for endpoint monitoring. It monitors personal websites, homelab services, and infrastructure via HTTP(s) checks with Discord notifications. A public status page is exposed via Cloudflare Tunnel with Access policies blocking admin routes.

**Version:** Uptime Kuma v2.0.2 (rootless ‚Äî includes Chromium for browser-engine monitors)

**Architecture:**
```
uptime-kuma namespace
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ StatefulSet (1 replica)           ‚îÇ
‚îÇ - Image: 2.0.2-rootless           ‚îÇ
‚îÇ - SQLite on Longhorn PVC (1Gi)   ‚îÇ
‚îÇ - Non-root (UID 1000)            ‚îÇ
‚îÇ - Startup/liveness/readiness     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ          ‚îÇ          ‚îÇ
  Headless   ClusterIP   HTTPRoute
  Service    Service     uptime.k8s.rommelporras.com
                          ‚îÇ
               Cloudflare Tunnel
               status.rommelporras.com/status/homelab
```

**Access:**

| Environment | URL | Access |
|-------------|-----|--------|
| Admin | https://uptime.k8s.rommelporras.com | Internal only (HTTPRoute) |
| Status Page | https://status.rommelporras.com/status/homelab | Public (Cloudflare Tunnel) |

---

## Step 1: Create Namespace

```bash
kubectl-homelab apply -f manifests/uptime-kuma/namespace.yaml
```

**manifests/uptime-kuma/namespace.yaml:**
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: uptime-kuma
  labels:
    app.kubernetes.io/part-of: uptime-kuma
    pod-security.kubernetes.io/enforce: baseline
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
```

Verify:
```bash
kubectl-homelab get namespace uptime-kuma -o yaml | grep -A5 labels
```

---

## Step 2: Deploy Manifests

```bash
kubectl-homelab apply -f manifests/uptime-kuma/
```

This applies:
- **statefulset.yaml** ‚Äî 1 replica, rootless image, Longhorn PVC via volumeClaimTemplates
- **service.yaml** ‚Äî Headless service (StatefulSet identity) + ClusterIP (HTTPRoute backend)
- **httproute.yaml** ‚Äî Gateway API route for `uptime.k8s.rommelporras.com`
- **networkpolicy.yaml** ‚Äî CiliumNetworkPolicy for egress control

Verify:
```bash
kubectl-homelab rollout status statefulset/uptime-kuma -n uptime-kuma --timeout=300s
kubectl-homelab get pvc -n uptime-kuma
kubectl-homelab logs -n uptime-kuma -l app=uptime-kuma --tail=20
kubectl-homelab exec -n uptime-kuma uptime-kuma-0 -- id
# Should show: uid=1000(node) gid=1000(node)
```

---

## Step 3: Configure DNS

Add DNS rewrite in AdGuard Home (both instances):
```
uptime.k8s.rommelporras.com ‚Üí 10.10.30.20
```

Verify:
```bash
nslookup uptime.k8s.rommelporras.com 10.10.30.53
```

---

## Step 4: Initial Setup (UI)

1. Access https://uptime.k8s.rommelporras.com
2. Select **SQLite** as database
3. Create admin account
4. Store credentials in 1Password:
   ```bash
   op item create \
     --category=login \
     --vault="Kubernetes" \
     --title="Uptime Kuma" \
     --url="https://uptime.k8s.rommelporras.com" \
     "username=<your-username>" \
     "password=<your-password>"
   ```
5. Settings ‚Üí General:
   - Primary Base URL: `https://uptime.k8s.rommelporras.com`
   - Check update: Disabled
   - Enable NSCD: Disabled (not needed for homelab)
   - Chrome/Chromium Executable: auto-detected (rootless image includes Chromium)

---

## Step 5: Configure Notifications (UI)

Settings ‚Üí Notifications ‚Üí Setup Notification:

| Field | Value |
|-------|-------|
| Notification Type | Discord |
| Friendly Name | Discord Incidents |
| Discord Webhook URL | from 1Password (`op read "op://Kubernetes/Discord Webhook Incidents/credential"`) |
| Bot Display Name | Uptime Kuma |
| Prefix Custom Message | *(leave empty)* |
| Select message type | Send to channel |
| Default enabled | **Checked** (auto-enables for new monitors) |
| Apply on all existing monitors | **Checked** |

Click **Test** ‚Äî verify "Discord Incidents Testing" appears in #incidents channel, then **Save**.

---

## Step 6: Add Monitors (UI)

### Create Tags

Add ‚Üí Tag for each tag (used to categorize monitors across groups):

| Tag | Color |
|-----|-------|
| Kubernetes | Blue |
| Proxmox | Orange |
| Network | Purple |
| Storage | Pink |
| Public | Green |

### Create Groups

Add Monitor ‚Üí Monitor Type: **Group** for each group:
1. **Website**
2. **Apps**
3. **Infrastructure**
4. **DNS**

### Create Monitors

Add Monitor ‚Üí Monitor Type: **HTTP(s)** for each monitor. Set the **Parent Monitor** field to assign it to a group.

**Default settings for all monitors:**
- Heartbeat Interval: 60 seconds
- Heartbeat Retry Interval: 60 seconds
- Request Timeout: 48 seconds
- Resend Notification: 0 (disabled ‚Äî you get DOWN and UP notifications, no repeats)
- Max Redirects: 10
- Accepted Status Codes: 200-299 (unless noted otherwise)

| Friendly Name | Group | URL | Retries |
|---|---|---|---|
| rommelporras.com | Website | https://rommelporras.com | 1 |
| rommelporras.com (Staging) | Website | https://beta.rommelporras.com | 3 |
| Blog (Prod) | Website | https://blog.rommelporras.com | 1 |
| Blog (Dev) | Website | https://blog.dev.k8s.rommelporras.com | 3 |
| Grafana | Apps | https://grafana.k8s.rommelporras.com | 3 |
| Homepage Dashboard | Apps | https://portal.k8s.rommelporras.com | 3 |
| Longhorn Storage | Apps | https://longhorn.k8s.rommelporras.com | 3 |
| Immich | Apps | https://immich.home.rommelporras.com | 3 |
| Karakeep | Apps | https://karakeep.home.rommelporras.com | 3 |
| MySpeed | Apps | https://myspeed.home.rommelporras.com | 3 |
| Homepage (Proxmox) | Apps | https://portal.home.rommelporras.com | 3 |
| Proxmox (PVE) | Infrastructure | https://pve.home.rommelporras.com | 3 |
| Proxmox (Firewall) | Infrastructure | https://firewall.home.rommelporras.com | 3 |
| OPNsense | Infrastructure | https://10.10.10.1 | 1 |
| OpenMediaVault (NAS) | Infrastructure | https://omv.home.rommelporras.com | 3 |
| NAS Glances | Infrastructure | http://10.10.30.4:61208 | 3 |
| AdGuard DNS (Primary) | DNS | https://adguard.k8s.rommelporras.com | 1 |
| AdGuard DNS (Failover) | DNS | https://adguard.home.rommelporras.com | 1 |

**Monitor-specific settings:**
- OPNsense: Enable "Ignore TLS/SSL errors" (self-signed cert)
- NAS Glances: Set accepted status codes to `200-299, 401` (returns 401 for unauthenticated, but proves service is running)

**Tag assignments:** Apply tags to each monitor based on where it runs:
- Kubernetes services (Grafana, Homepage Dashboard, Longhorn, AdGuard Primary, Blog, etc.) ‚Üí **Kubernetes**
- Proxmox-hosted services (Proxmox PVE, Proxmox Firewall, Homepage Proxmox) ‚Üí **Proxmox**
- Network devices (OPNsense, AdGuard Primary, AdGuard Failover) ‚Üí **Network**
- Storage services (Longhorn, OpenMediaVault, NAS Glances) ‚Üí **Storage**
- Publicly accessible services (rommelporras.com, Blog Prod, Staging) ‚Üí **Public**
- Monitors can have multiple tags (e.g., rommelporras.com = Kubernetes + Public)

---

## Step 7: Create Status Page (UI)

Status Pages ‚Üí New Status Page:
- Name: **Rommel Porras Services** (this becomes the page title)
- Slug: **homelab** (URL becomes `/status/homelab`)

Click Save, then edit the status page:
- Description: Real-time status for personal and homelab services.
- Footer: `Monitored from a 3-node Kubernetes cluster üè†`
- Refresh Interval: 300 (default)
- Theme: Auto
- Show Tags: **Unchecked** (tags aren't meaningful to public visitors)
- Show Powered By: **Checked**
- Show Certificate Expiry: **Checked**
- Domain Names: `status.rommelporras.com` (add after Cloudflare Tunnel is configured in Step 8)

### Add Groups to Status Page

Click **Add Group** for each group. Drag to reorder by importance:

1. **Website** ‚Äî Add monitors: rommelporras.com, Blog Prod, rommelporras.com (Staging), Blog Dev
2. **DNS** ‚Äî Add monitors: AdGuard Primary, AdGuard Failover
3. **Apps** ‚Äî Add monitors: Grafana, Longhorn Storage, Homepage Dashboard, Immich, Karakeep, MySpeed, Homepage (Proxmox)
4. **Infrastructure** ‚Äî Add monitors: OPNsense, Proxmox PVE, Proxmox Firewall, OpenMediaVault, NAS Glances

Click **Save** after adding all groups and monitors.

**Note:** Status page groups are independent from dashboard groups. You select which monitors appear on the status page and in what order.

---

## Step 8: Cloudflare Tunnel & Access

### 8a: Add Tunnel Route

1. Cloudflare Zero Trust ‚Üí Networks ‚Üí Tunnels
2. Click the **homelab** tunnel ‚Üí **Public Hostname** tab
3. Click **Add a public hostname**
4. Fill in:
   - Subdomain: `status`
   - Domain: `rommelporras.com`
   - Type: HTTP
   - URL: `uptime-kuma.uptime-kuma.svc.cluster.local:3001`
5. Click **Save hostname**

### 8b: Update cloudflared Network Policy

Already included in `manifests/cloudflare/networkpolicy.yaml` (applied in Step 2):
```yaml
# Uptime Kuma namespace (status.rommelporras.com)
- toEndpoints:
  - matchLabels:
      k8s:io.kubernetes.pod.namespace: uptime-kuma
  toPorts:
  - ports:
    - port: "3001"
      protocol: TCP
```

If not already applied:
```bash
kubectl-homelab apply -f manifests/cloudflare/networkpolicy.yaml
```

### 8c: Cloudflare Access ‚Äî Block Admin Routes

This blocks admin UI paths while keeping the status page publicly accessible. We use a **block-admin** approach (block specific paths) instead of an allowlist (allow specific paths) because Uptime Kuma is an SPA that loads JS/CSS/API from various paths ‚Äî an allowlist approach causes CORS errors when the SPA tries to load `/assets/`, `/api/status-page/heartbeat/`, `/socket.io/`, etc.

**First, create the reusable policy:**

1. Cloudflare Zero Trust ‚Üí Access ‚Üí Policies ‚Üí **Add a policy**
2. Policy name: **Block Public**
3. Action: **Block**
4. Include: **Everyone**
5. Save

**Then, create the application:**

1. Access ‚Üí Applications ‚Üí **Add an application** ‚Üí **Self-hosted**
2. Application Configuration:
   - Application name: **Uptime Kuma Block Admin**
   - Session Duration: 24 hours (default)
3. Application domain ‚Äî click **Add public hostname** for each:
   - Subdomain: `status`, Domain: `rommelporras.com`, Path: `dashboard`
   - Subdomain: `status`, Domain: `rommelporras.com`, Path: `manage-status-page`
   - Subdomain: `status`, Domain: `rommelporras.com`, Path: `settings`
4. Attach the **Block Public** policy
5. Click **Next** through Experience and Advanced settings (defaults are fine)
6. Click **Save**

**Optional ‚Äî Allow admin access via email OTP:**

To access the Uptime Kuma dashboard through `status.rommelporras.com` (instead of internal URL):

1. Edit **Uptime Kuma Block Admin** ‚Üí Policies
2. Add a new policy:
   - Policy name: **Allow Admin**
   - Action: **Allow**
   - Include: Selector **Emails**, Value: `your-email@example.com`
3. Ensure order is: **Allow Admin** (#1) ‚Üí **Block Public** (#2)
   - Cloudflare evaluates top-to-bottom; if Block is first, it blocks everyone including you

### 8d: Verify

```bash
# Status page should load (public)
curl -sI https://status.rommelporras.com/status/homelab | head -5
# Should return 200

# Admin paths should be blocked by Cloudflare Access
curl -sI https://status.rommelporras.com/dashboard | head -5
# Should return 403 (Cloudflare Access block page)
```

Also verify in browser:
- `status.rommelporras.com/status/homelab` ‚Üí loads status page
- `status.rommelporras.com/dashboard` ‚Üí Cloudflare Access block page

---

## Step 9: Prometheus Probe

```bash
kubectl-homelab apply -f manifests/monitoring/uptime-kuma-probe.yaml
```

Verify in Prometheus targets (port-forward 9090).

---

## 1Password Items

| Item | Fields | Vault |
|------|--------|-------|
| Uptime Kuma | `username`, `password`, `website` | Kubernetes |

---

## Verification Checklist

- [ ] Namespace `uptime-kuma` with baseline PSS enforce
- [ ] PVC `data-uptime-kuma-0` bound to Longhorn
- [ ] StatefulSet running (1 replica, rootless, UID 1000)
- [ ] HTTPRoute accessible: https://uptime.k8s.rommelporras.com
- [ ] Admin account stored in 1Password
- [ ] Discord notification configured and tested
- [ ] All monitors UP
- [ ] Status page at status.rommelporras.com/status/homelab
- [ ] Admin paths blocked via Cloudflare Access
- [ ] Prometheus blackbox probe target UP

---

## Rollback

```bash
kubectl-homelab delete namespace uptime-kuma
kubectl-homelab delete probe uptime-kuma -n monitoring
# Remove Cloudflare Tunnel route and Access application manually
# Remove DNS rewrite from AdGuard
```

---

## Files Reference

| File | Purpose |
|------|---------|
| manifests/uptime-kuma/namespace.yaml | Namespace with PSS labels |
| manifests/uptime-kuma/statefulset.yaml | StatefulSet with volumeClaimTemplates |
| manifests/uptime-kuma/service.yaml | Headless + ClusterIP services |
| manifests/uptime-kuma/httproute.yaml | Gateway API HTTPRoute |
| manifests/uptime-kuma/networkpolicy.yaml | CiliumNetworkPolicy (egress) |
| manifests/monitoring/uptime-kuma-probe.yaml | Blackbox HTTP probe |
| manifests/cloudflare/networkpolicy.yaml | Updated cloudflared egress |

---

## Key Learnings

| Topic | Lesson |
|-------|--------|
| StatefulSet vs Deployment | StatefulSet for stable identity + persistent storage (SQLite) |
| volumeClaimTemplates | Auto-creates PVC per pod ‚Äî no separate PVC manifest needed |
| Headless Service | `clusterIP: None` gives pods stable DNS names |
| CiliumNetworkPolicy ports | Uses pod ports, not service ports (e.g., Grafana service:80 ‚Üí pod:3000) |
| Hairpin routing | Cilium Gateway returns 403 for pod-to-VIP-to-pod traffic; resolved after network policy updates |
| Cloudflare Access allowlist | Bypass `/status/homelab` + Block everything causes CORS ‚Äî SPA loads JS/CSS/API from many paths |
| Cloudflare Access block-admin | Block only `/dashboard`, `/manage-status-page`, `/settings` ‚Äî simpler, SPA-compatible |
| Cloudflare Access policy order | Top-to-bottom evaluation; Allow must be above Block or it's unreachable |
| Cloudflare Zero Trust free plan | Requires payment method (anti-abuse), $0/month, 50 seat limit |
| Image variants | rootless = non-root + Chromium; slim-rootless = no Chromium |
| Monitor retries | 1 for production/critical (fast alerting), 3 for internal/dev (tolerance for blips) |
| Accepted status codes | NAS Glances returns 401 (auth required) ‚Äî add to accepted codes to confirm service is UP |
