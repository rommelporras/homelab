# v0.21.0 — Karakeep Migration

> **Release:** v0.21.0
> **Phase:** 4.24 (Karakeep Migration)
> **Goal:** Migrate Karakeep bookmark manager from Proxmox to Kubernetes with Ollama AI tagging
> **Prerequisite:** [v0.20.0-ollama.md](v0.20.0-ollama.md) completed (Ollama running in `ai` namespace)

---

## Overview

Deploys Karakeep 0.30.0 bookmark manager with three services:
- **Karakeep AIO** — Next.js 15 web + workers (s6-overlay), SQLite database
- **Chrome** — Headless browser for page crawling and screenshots
- **Meilisearch** — Full-text search engine

Connected to Ollama (Phase 4.23) for AI-powered bookmark tagging:
- **qwen2.5:3b** — Text classification/tagging
- **moondream** — Vision model for image tagging

Includes 6 CiliumNetworkPolicies, Blackbox HTTP probe, and PrometheusRule alerts.

---

## Step 1: Pull qwen2.5:3b Model

```bash
# Pull text model for Karakeep (qwen3 is incompatible with structured output)
kubectl-homelab exec -n ai deploy/ollama -- ollama pull qwen2.5:3b

# Verify
kubectl-homelab exec -n ai deploy/ollama -- ollama list
```

## Step 2: Create 1Password Secrets

```bash
# Create Karakeep item with auth secrets
op item create \
  --vault "Kubernetes" \
  --category "Login" \
  --title "Karakeep" \
  --field "nextauth-secret=$(openssl rand -base64 36)" \
  --field "meili-master-key=$(openssl rand -base64 36)"
```

## Step 3: Apply Namespace and Create Secret

```bash
# Create namespace first (secret must go into an existing namespace)
kubectl-homelab apply -f manifests/karakeep/namespace.yaml

# Create K8s secret from 1Password
kubectl-homelab create secret generic karakeep-secrets \
  -n karakeep \
  --from-literal=nextauth-secret="$(op read 'op://Kubernetes/Karakeep/nextauth-secret')" \
  --from-literal=meili-master-key="$(op read 'op://Kubernetes/Karakeep/meili-master-key')"
```

## Step 4: Apply Manifests

```bash
# Deploy all services (namespace already exists from Step 3)
kubectl-homelab apply -f manifests/karakeep/

# Apply monitoring
kubectl-homelab apply \
  -f manifests/monitoring/karakeep-probe.yaml \
  -f manifests/monitoring/karakeep-alerts.yaml

# Expected PSS warnings (s6-overlay runs as root during init):
# Warning: would violate PodSecurity "restricted:latest": runAsNonRoot != true
```

## Step 5: Wait for Pods Ready

```bash
# Karakeep startupProbe allows up to 310s (Next.js compile + s6-overlay init)
kubectl-homelab -n karakeep wait --for=condition=Ready pod -l app=karakeep --timeout=300s
kubectl-homelab -n karakeep wait --for=condition=Ready pod -l app=chrome --timeout=60s
kubectl-homelab -n karakeep wait --for=condition=Ready pod -l app=meilisearch --timeout=60s
```

## Step 6: Create User Account

The committed manifest has `DISABLE_SIGNUPS=true`. On a fresh rebuild with no existing data, you must temporarily allow signups:

1. Edit `manifests/karakeep/karakeep-deployment.yaml` — change `DISABLE_SIGNUPS` to `"false"`
2. Re-apply: `kubectl-homelab apply -f manifests/karakeep/karakeep-deployment.yaml`
3. Open https://karakeep.k8s.rommelporras.com and create first user account
4. Revert `DISABLE_SIGNUPS` back to `"true"` and re-apply
5. Do NOT commit the temporary change

## Step 7: Generate API Key

1. In Karakeep UI → Settings → API Keys → Generate
2. Save to 1Password:
   ```bash
   op item edit "Karakeep" --vault "Kubernetes" \
     "api-key[text]=<generated-api-key>"
   ```

## Step 8: Update Homepage Widget

1. Add API key to Homepage secrets:
   ```bash
   kubectl-homelab patch secret homepage-secrets -n home \
     -p "{\"stringData\":{\"HOMEPAGE_VAR_KARAKEEP_KEY\":\"$(op read 'op://Kubernetes/Karakeep/api-key')\"}}"
   ```
2. Homepage config already points to `karakeep.k8s.rommelporras.com`
3. Restart Homepage to pick up new secret:
   ```bash
   kubectl-homelab rollout restart deployment homepage -n home
   ```

## Step 9: Migrate Data (Optional — only during soak period)

> **Note:** This only works while the source Proxmox instance is still running.
> After decommission, this step is no longer available. Use Karakeep's
> built-in export/import (Settings → Export → JSON) as an alternative.

```bash
# Server-to-server migration using karakeep-cli
# --api-key = source (Proxmox) API key
# --dest-api-key = destination (K8s) API key
docker run --rm -it ghcr.io/karakeep-app/karakeep-cli:release \
  --server-addr https://karakeep.home.rommelporras.com \
  --api-key "<proxmox-instance-api-key>" \
  migrate \
  --dest-server https://karakeep.k8s.rommelporras.com \
  --dest-api-key "$(op read 'op://Kubernetes/Karakeep/api-key')" \
  --batch-size 50
```

Note: Use `-it` flag — the CLI has an interactive confirmation prompt.

After migration completes, rebuild the search index:
1. In Karakeep UI → Admin Settings → Reindex all bookmarks

## Step 10: Verify

```bash
# All pods running
kubectl-homelab get pods -n karakeep

# Test bookmark pipeline: save a URL, verify:
# 1. Page crawled (screenshot appears) — Chrome working
# 2. AI tags appear within 30-120s — Ollama connection working
# 3. Bookmark searchable — Meilisearch working

# Check Blackbox probe
kubectl-homelab get probe karakeep -n monitoring

# Check resource usage
kubectl-homelab top pod -n karakeep
kubectl-homelab top pod -n ai
```

---

## Architecture

```
┌──────────────────────────────────────────────────────────┐
│  karakeep namespace                                      │
│                                                          │
│  ┌─────────────────────┐  ┌───────────────────────────┐ │
│  │ Karakeep (AIO)      │  │ Chrome                    │ │
│  │ web + workers        │─→│ Headless browser          │ │
│  │ Port: 3000           │  │ Port: 9222                │ │
│  │ PVC: /data (2Gi)     │  │ (no persistent storage)   │ │
│  └──────────┬───────────┘  └───────────────────────────┘ │
│             │                                            │
│  ┌──────────▼───────────┐                                │
│  │ Meilisearch          │                                │
│  │ Full-text search      │                                │
│  │ Port: 7700            │                                │
│  │ PVC: /meili_data (1Gi)│                                │
│  └──────────────────────┘                                │
└──────────────┬───────────────────────────────────────────┘
               │ Cross-namespace (CiliumNetworkPolicy)
               ▼
┌──────────────────────────────────────────────────────────┐
│  ai namespace (Phase 4.23)                               │
│  Ollama → ollama.ai.svc.cluster.local:11434              │
│  Models: qwen2.5:3b (text), moondream (vision)           │
└──────────────────────────────────────────────────────────┘
```

## Manifest Files

| File | Purpose |
|------|---------|
| manifests/karakeep/namespace.yaml | Namespace (PSS baseline enforce) |
| manifests/karakeep/karakeep-deployment.yaml | Karakeep AIO Deployment + PVC |
| manifests/karakeep/karakeep-service.yaml | ClusterIP port 3000 |
| manifests/karakeep/httproute.yaml | HTTPRoute (karakeep.k8s.rommelporras.com) |
| manifests/karakeep/chrome-deployment.yaml | Headless Chrome Deployment |
| manifests/karakeep/chrome-service.yaml | ClusterIP port 9222 |
| manifests/karakeep/meilisearch-deployment.yaml | Meilisearch Deployment + PVC |
| manifests/karakeep/meilisearch-service.yaml | ClusterIP port 7700 |
| manifests/karakeep/networkpolicy.yaml | 6 CiliumNetworkPolicies |
| manifests/monitoring/karakeep-probe.yaml | Blackbox HTTP probe |
| manifests/monitoring/karakeep-alerts.yaml | PrometheusRule (2 alerts) |

## Rollback

```bash
kubectl-homelab delete namespace karakeep
kubectl-homelab delete probe karakeep -n monitoring
kubectl-homelab delete prometheusrule karakeep-alerts -n monitoring
# Ollama (Phase 4.23) stays — it's independent
```
