# v0.6.0 — Home Services & Dead Man's Switch

> **Release:** v0.6.0
> **Phases:** 4.1-4.4 (Stateless Workloads), 3.10 (Dead Man's Switch)
> **Goal:** Deploy AdGuard Home, Homepage dashboard, metrics-server, and dead man's switch
> **Prerequisite:** [v0.5.0-alerting.md](v0.5.0-alerting.md) completed

---

## Overview

This release deploys home services and monitoring enhancements:
- **AdGuard Home** — DNS ad-blocking on LoadBalancer IP (primary DNS for all VLANs)
- **Homepage** — Dashboard with widgets for all cluster services
- **Metrics Server** — Enables `kubectl top` and Homepage K8s widget
- **Glances on OMV** — System monitoring for NAS integration
- **Dead Man's Switch** — healthchecks.io integration for Alertmanager health

---

## Prerequisites

### 1Password Items Required

Create these items in the **Kubernetes** vault before starting:

| Item Name | Type | Fields |
|-----------|------|--------|
| Homepage | Login | proxmox-pve-user, proxmox-pve-token, proxmox-fw-user, proxmox-fw-token, opnsense-username, opnsense-password, immich-key, omv-user, omv-pass, glances-pass, karakeep-key, adguard-user, adguard-pass, adguard-fw-user, adguard-fw-pass, tailscale-device, tailscale-key, openwrt-user, openwrt-pass, weather-key, grafana-user, grafana-pass |
| Healthchecks Ping URL | API Credential | url (https://hc-ping.com/xxxxxxxx-...) |

### External Service Setup

**healthchecks.io:**
1. Create account at https://healthchecks.io
2. Create check: "K8s Alertmanager", Period: 1 minute, Grace: 5 minutes
3. Configure Discord integration (same webhook as Alertmanager)
4. Copy ping URL to 1Password

---

## Step 1: Create Home Namespace

```bash
kubectl-homelab create namespace home
kubectl-homelab label namespace home \
  pod-security.kubernetes.io/enforce=baseline \
  pod-security.kubernetes.io/audit=restricted \
  pod-security.kubernetes.io/warn=restricted
```

---

## Step 2: Deploy AdGuard Home

### 2.1 Manifests Structure

```
manifests/home/adguard/
├── configmap.yaml      # Full sanitized config
├── deployment.yaml     # v0.107.71, init container, security context
├── httproute.yaml      # adguard.k8s.home.rommelporras.com
├── pvc.yaml            # 5Gi Longhorn storage
└── service.yaml        # LoadBalancer (DNS) + ClusterIP (HTTP)
```

### 2.2 Key Configuration

**Service (LoadBalancer for DNS):**
```yaml
apiVersion: v1
kind: Service
metadata:
  name: adguard-dns
  namespace: home
  annotations:
    lbipam.cilium.io/ips: "10.10.30.55"
spec:
  type: LoadBalancer
  selector:
    app: adguard-home
  ports:
    - name: dns-tcp
      port: 53
      targetPort: 53
      protocol: TCP
    - name: dns-udp
      port: 53
      targetPort: 53
      protocol: UDP
```

**Security Context (important):**
```yaml
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop: ["ALL"]
    add: ["NET_BIND_SERVICE"]  # Required for port 53
```

### 2.3 Deploy

```bash
kubectl-homelab apply -f manifests/home/adguard/
```

### 2.4 Verify DNS

```bash
dig @10.10.30.55 google.com
dig @10.10.30.55 homepage.k8s.home.rommelporras.com
```

### 2.5 Update DHCP (OPNsense)

After verification, update OPNsense DHCP for all VLANs:
- Primary DNS: 10.10.30.55 (K8s AdGuard)
- Secondary DNS: 10.10.30.54 (FW LXC failover)

---

## Step 3: Install Metrics Server

Homepage's Kubernetes widget requires metrics-server for CPU/memory stats.

```bash
helm-homelab repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
helm-homelab install metrics-server metrics-server/metrics-server \
  --namespace kube-system \
  --version 3.13.0 \
  -f helm/metrics-server/values.yaml
```

**helm/metrics-server/values.yaml:**
```yaml
args:
  - --kubelet-insecure-tls  # Required for kubeadm clusters
  - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
  - --kubelet-use-node-status-port
  - --metric-resolution=15s
resources:
  requests:
    cpu: 100m
    memory: 200Mi
```

**Verify:**
```bash
kubectl-homelab top nodes
kubectl-homelab top pods -n home
```

---

## Step 4: Setup Glances on OMV (NAS)

Prerequisite for Homepage's Glances widget.

```bash
# SSH to OMV
ssh root@10.10.30.4

# Install Glances
apt update && apt install -y glances python3-bottle

# Create systemd service
cat > /etc/systemd/system/glances.service << 'EOF'
[Unit]
Description=Glances monitoring web server (authenticated)
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/glances -w -B 10.10.30.4 --password
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now glances

# Set password (interactive)
systemctl stop glances
glances -w --password  # Enter password when prompted, Ctrl+C after saved
systemctl start glances
```

Save the password to 1Password: `Homepage` item, `glances-pass` field.

---

## Step 5: Deploy Homepage Dashboard

### 5.1 Manifests Structure (Kustomize)

```
manifests/home/homepage/
├── kustomization.yaml    # configMapGenerator for config files
├── config/
│   ├── bookmarks.yaml
│   ├── custom.css
│   ├── custom.js
│   ├── docker.yaml
│   ├── kubernetes.yaml   # mode: cluster, gateway: false
│   ├── services.yaml     # {{HOMEPAGE_VAR_XXX}} placeholders
│   ├── settings.yaml
│   └── widgets.yaml
├── deployment.yaml       # v1.9.0, envFrom secretRef
├── httproute.yaml
├── rbac.yaml             # Includes metrics.k8s.io access
├── secret.yaml           # Template only (not applied)
└── service.yaml
```

### 5.2 Create Secret from 1Password

```bash
kubectl-homelab create secret generic homepage-secrets -n home \
  --from-literal=HOMEPAGE_VAR_PROXMOX_PVE_USER="$(op read 'op://Kubernetes/Homepage/proxmox-pve-user')" \
  --from-literal=HOMEPAGE_VAR_PROXMOX_PVE_TOKEN="$(op read 'op://Kubernetes/Homepage/proxmox-pve-token')" \
  --from-literal=HOMEPAGE_VAR_PROXMOX_FW_USER="$(op read 'op://Kubernetes/Homepage/proxmox-fw-user')" \
  --from-literal=HOMEPAGE_VAR_PROXMOX_FW_TOKEN="$(op read 'op://Kubernetes/Homepage/proxmox-fw-token')" \
  --from-literal=HOMEPAGE_VAR_OPNSENSE_USER="$(op read 'op://Kubernetes/Homepage/opnsense-username')" \
  --from-literal=HOMEPAGE_VAR_OPNSENSE_PASS="$(op read 'op://Kubernetes/Homepage/opnsense-password')" \
  --from-literal=HOMEPAGE_VAR_IMMICH_KEY="$(op read 'op://Kubernetes/Homepage/immich-key')" \
  --from-literal=HOMEPAGE_VAR_OMV_USER="$(op read 'op://Kubernetes/Homepage/omv-user')" \
  --from-literal=HOMEPAGE_VAR_OMV_PASS="$(op read 'op://Kubernetes/Homepage/omv-pass')" \
  --from-literal=HOMEPAGE_VAR_GLANCES_PASS="$(op read 'op://Kubernetes/Homepage/glances-pass')" \
  --from-literal=HOMEPAGE_VAR_ADGUARD_USER="$(op read 'op://Kubernetes/Homepage/adguard-user')" \
  --from-literal=HOMEPAGE_VAR_ADGUARD_PASS="$(op read 'op://Kubernetes/Homepage/adguard-pass')" \
  --from-literal=HOMEPAGE_VAR_GRAFANA_USER="$(op read 'op://Kubernetes/Homepage/grafana-user')" \
  --from-literal=HOMEPAGE_VAR_GRAFANA_PASS="$(op read 'op://Kubernetes/Homepage/grafana-pass')" \
  --from-literal=HOMEPAGE_VAR_WEATHER_KEY="$(op read 'op://Kubernetes/Homepage/weather-key')"
```

### 5.3 Deploy via Kustomize

```bash
kubectl-homelab apply -k manifests/home/homepage/
```

### 5.4 Verify

```bash
curl -I https://homepage.k8s.home.rommelporras.com
```

---

## Step 6: Expose Longhorn UI (for Homepage Widget)

Homepage's Longhorn widget needs HTTPRoute access to Longhorn UI.

```yaml
# manifests/storage/longhorn/httproute.yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: longhorn
  namespace: longhorn-system
spec:
  parentRefs:
    - name: homelab-gateway
      namespace: default
  hostnames:
    - "longhorn.k8s.home.rommelporras.com"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: longhorn-frontend
          port: 80
```

```bash
kubectl-homelab apply -f manifests/storage/longhorn/httproute.yaml
```

---

## Step 7: Configure Dead Man's Switch

### 7.1 Update Prometheus Values

**Re-enable Watchdog** (remove from disabled list in `helm/prometheus/values.yaml`):
```yaml
defaultRules:
  disabled:
    InfoInhibitor: true
    # Watchdog: true  ← DELETE THIS LINE
```

**Add healthchecks-heartbeat receiver:**
```yaml
# In alertmanager.config.receivers:
- name: 'healthchecks-heartbeat'
  webhook_configs:
    - url: 'SET_VIA_HELM'  # Injected from 1Password at runtime
      send_resolved: false
```

**Add Watchdog route:**
```yaml
# In alertmanager.config.route.routes (before severity routes):
- match:
    alertname: Watchdog
  receiver: 'healthchecks-heartbeat'
  repeat_interval: 1m
  continue: false
```

### 7.2 Update Upgrade Script

Add to `scripts/upgrade-prometheus.sh`:
```bash
HEALTHCHECKS_PING_URL=$(op read "op://Kubernetes/Healthchecks Ping URL/url")
```

And add the receiver to the temp secrets file with the actual URL.

### 7.3 Apply

```bash
./scripts/upgrade-prometheus.sh
```

### 7.4 Verify Dead Man's Switch

```bash
# Check Watchdog is firing
kubectl-homelab -n monitoring exec -it \
  $(kubectl-homelab -n monitoring get pod -l app.kubernetes.io/name=alertmanager -o name | head -1) \
  -- amtool alert query alertname=Watchdog

# Check healthchecks.io dashboard - should show green "Up" status
```

**Critical Test:**
```bash
# Scale Alertmanager to 0
kubectl-homelab -n monitoring scale statefulset alertmanager-prometheus-kube-prometheus-alertmanager --replicas=0

# Wait 5+ minutes, verify healthchecks.io marks DOWN and Discord notification received

# Restore
kubectl-homelab -n monitoring scale statefulset alertmanager-prometheus-kube-prometheus-alertmanager --replicas=1
```

---

## Verification Checklist

- [ ] Namespace `home` exists with baseline PSS
- [ ] AdGuard Home pod running: `kubectl-homelab get pods -n home -l app=adguard-home`
- [ ] AdGuard DNS resolving: `dig @10.10.30.55 google.com`
- [ ] AdGuard web UI: https://adguard.k8s.home.rommelporras.com
- [ ] Homepage pods running (2 replicas): `kubectl-homelab get pods -n home -l app=homepage`
- [ ] Homepage accessible: https://homepage.k8s.home.rommelporras.com
- [ ] All Homepage widgets working (K8s, Longhorn, weather, etc.)
- [ ] Metrics server working: `kubectl-homelab top nodes`
- [ ] Glances running on OMV: `curl http://10.10.30.4:61208`
- [ ] Longhorn UI accessible: https://longhorn.k8s.home.rommelporras.com
- [ ] Watchdog alert firing
- [ ] healthchecks.io showing regular pings
- [ ] Dead man's switch test passed

---

## Key Learnings

1. **Security Context for DNS:** AdGuard needs `NET_BIND_SERVICE` capability for port 53, but can still drop all other capabilities.

2. **Homepage runs as root:** The image doesn't support `runAsNonRoot: true`. Use seccomp and drop capabilities instead.

3. **Kustomize secret exclusion:** Remove secret.yaml from resources list - manage secrets imperatively via 1Password CLI.

4. **Glances version:** OMV apt installs v3.x, use `version: 3` in Homepage widget config.

5. **Variable substitution:** `{{HOMEPAGE_VAR_*}}` works in services.yaml but NOT in settings.yaml providers section.

---

## Files Reference

| File | Purpose |
|------|---------|
| `manifests/home/adguard/` | AdGuard Home deployment |
| `manifests/home/homepage/` | Homepage dashboard (Kustomize) |
| `manifests/storage/longhorn/httproute.yaml` | Longhorn UI exposure |
| `helm/metrics-server/values.yaml` | Metrics Server config |
| `helm/prometheus/values.yaml` | Dead man's switch config |
| `scripts/upgrade-prometheus.sh` | Prometheus upgrade with secrets |

---

## Troubleshooting

### AdGuard DNS not responding

```bash
# Check LoadBalancer IP assigned
kubectl-homelab get svc -n home adguard-dns

# Verify Cilium LB-IPAM pool
kubectl-homelab get ciliumloadbalancerippool -o yaml
# IP must be in range (10.10.30.20-99)
```

### Homepage widgets showing errors

```bash
# Check pod logs
kubectl-homelab logs -n home -l app=homepage --tail=50

# Verify secret has all required fields
kubectl-homelab get secret homepage-secrets -n home -o jsonpath='{.data}' | jq 'keys'

# Common issues:
# - Wrong Glances version (use version: 3, not 4)
# - Missing RBAC for metrics.k8s.io
```

### healthchecks.io not receiving pings

```bash
# Check Alertmanager config
kubectl-homelab -n monitoring get secret alertmanager-prometheus-kube-prometheus-alertmanager \
  -o jsonpath='{.data.alertmanager\.yaml}' | base64 -d | grep -A3 healthchecks

# Test ping URL manually
curl -fsS -m 10 "$(op read 'op://Kubernetes/Healthchecks Ping URL/url')" && echo "OK"
```

---

## Next Steps

- [v0.7.0-cloudflare.md](v0.7.0-cloudflare.md) — Cloudflare Tunnel migration for external access
