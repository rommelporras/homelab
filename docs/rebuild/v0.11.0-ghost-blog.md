# v0.11.0 — Ghost Blog Platform

> **Release:** v0.11.0
> **Phase:** 4.12
> **Goal:** Self-hosted Ghost CMS with dev and prod environments
> **Prerequisite:** [v0.10.0-portfolio-cicd.md](v0.10.0-portfolio-cicd.md) completed

---

## Overview

This release deploys Ghost CMS to Kubernetes with two fully isolated environments. Each environment has its own Ghost instance, MySQL database, and content storage. Theme development uses a separate GitLab repo with CI/CD that deploys via the Ghost Admin API.

**Versions:**
- Ghost 6.14.0 (Debian Bookworm — not Alpine, glibc required for Sharp)
- MySQL 8.4.8 LTS (utf8mb4 charset, caching_sha2_password default)

**Architecture:**
```
ghost-dev namespace                    ghost-prod namespace
┌──────────────────────┐              ┌──────────────────────┐
│ Ghost (Deployment)   │              │ Ghost (Deployment)   │
│ - 1 replica          │              │ - 1 replica          │
│ - Content PVC (5Gi)  │              │ - Content PVC (5Gi)  │
└──────────┬───────────┘              └──────────┬───────────┘
           │                                     │
┌──────────▼───────────┐              ┌──────────▼───────────┐
│ MySQL (StatefulSet)  │              │ MySQL (StatefulSet)  │
│ - Data PVC (10Gi)    │              │ - Data PVC (10Gi)    │
└──────────────────────┘              └──────────────────────┘

HTTPRoute (internal)                  HTTPRoute + Cloudflare Tunnel
blog-dev.k8s.home...                  blog.rommelporras.com
```

**Access:**

| Environment | URL | Access |
|-------------|-----|--------|
| Dev | blog.dev.k8s.rommelporras.com | Internal only (HTTPRoute) |
| Prod | blog.rommelporras.com | Public (Cloudflare Tunnel) |
| Prod (internal) | blog.k8s.rommelporras.com | Internal (HTTPRoute) |

---

## Step 1: Create Namespaces

```bash
kubectl-homelab apply -f manifests/ghost-dev/namespace.yaml
kubectl-homelab apply -f manifests/ghost-prod/namespace.yaml
```

**manifests/ghost-dev/namespace.yaml:**
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: ghost-dev
  labels:
    app.kubernetes.io/part-of: ghost
    pod-security.kubernetes.io/enforce: baseline
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
```

**manifests/ghost-prod/namespace.yaml:** Same structure with `name: ghost-prod`.

---

## Step 2: Create Secrets from 1Password

### 2.1 Create 1Password Items

Create these items in the `Kubernetes` vault:

| Item | Fields |
|------|--------|
| Ghost Dev MySQL | `root-password`, `user-password` (generate with `openssl rand -hex 32`) |
| Ghost Prod MySQL | `root-password`, `user-password` (generate with `openssl rand -hex 32`) |
| Ghost Mail | Reuse `iCloud SMTP` — `smtp-host`, `smtp-user`, `smtp-password`, `from-address` |

### 2.2 Create Kubernetes Secrets

```bash
eval $(op signin)

# Dev MySQL + Mail
kubectl-homelab create secret generic ghost-mysql \
  --namespace ghost-dev \
  --from-literal=root-password="$(op read 'op://Kubernetes/Ghost Dev MySQL/root-password')" \
  --from-literal=user-password="$(op read 'op://Kubernetes/Ghost Dev MySQL/user-password')"

kubectl-homelab create secret generic ghost-mail \
  --namespace ghost-dev \
  --from-literal=smtp-host="$(op read 'op://Kubernetes/iCloud SMTP/server')" \
  --from-literal=smtp-user="$(op read 'op://Kubernetes/iCloud SMTP/username')" \
  --from-literal=smtp-password="$(op read 'op://Kubernetes/iCloud SMTP/password')" \
  --from-literal=from-address="noreply@rommelporras.com"

# Prod MySQL + Mail
kubectl-homelab create secret generic ghost-mysql \
  --namespace ghost-prod \
  --from-literal=root-password="$(op read 'op://Kubernetes/Ghost Prod MySQL/root-password')" \
  --from-literal=user-password="$(op read 'op://Kubernetes/Ghost Prod MySQL/user-password')"

kubectl-homelab create secret generic ghost-mail \
  --namespace ghost-prod \
  --from-literal=smtp-host="$(op read 'op://Kubernetes/iCloud SMTP/server')" \
  --from-literal=smtp-user="$(op read 'op://Kubernetes/iCloud SMTP/username')" \
  --from-literal=smtp-password="$(op read 'op://Kubernetes/iCloud SMTP/password')" \
  --from-literal=from-address="noreply@rommelporras.com"
```

> **Note:** Secrets are created imperatively (not stored in manifests). The `secret.yaml` files in each namespace directory are documentation-only reminders.

---

## Step 3: Deploy MySQL StatefulSets

**manifests/ghost-dev/mysql-statefulset.yaml:**

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ghost-mysql
  namespace: ghost-dev
spec:
  serviceName: ghost-mysql
  replicas: 1
  selector:
    matchLabels:
      app: ghost-mysql
  template:
    metadata:
      labels:
        app: ghost-mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.4.8
        args:
          - --character-set-server=utf8mb4
          - --collation-server=utf8mb4_0900_ai_ci
        ports:
        - containerPort: 3306
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ghost-mysql
              key: root-password
        - name: MYSQL_DATABASE
          value: ghost
        - name: MYSQL_USER
          value: ghost
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ghost-mysql
              key: user-password
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        resources:
          requests:
            memory: "512Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          exec:
            command: ["mysqladmin", "ping", "-h", "localhost"]
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          exec:
            command: ["mysqladmin", "ping", "-h", "localhost"]
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: longhorn
      resources:
        requests:
          storage: 10Gi
```

**manifests/ghost-dev/mysql-service.yaml:**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: ghost-mysql
  namespace: ghost-dev
spec:
  selector:
    app: ghost-mysql
  ports:
  - port: 3306
    targetPort: 3306
  clusterIP: None
```

Prod manifests are identical with `namespace: ghost-prod`.

```bash
kubectl-homelab apply -f manifests/ghost-dev/mysql-statefulset.yaml
kubectl-homelab apply -f manifests/ghost-dev/mysql-service.yaml
kubectl-homelab apply -f manifests/ghost-prod/mysql-statefulset.yaml
kubectl-homelab apply -f manifests/ghost-prod/mysql-service.yaml

# Verify
kubectl-homelab get pods -n ghost-dev -l app=ghost-mysql
kubectl-homelab get pods -n ghost-prod -l app=ghost-mysql
```

> **Important:** Wait for MySQL pods to be Running and Ready before deploying Ghost. The init container handles this, but MySQL must be fully initialized first.

---

## Step 4: Deploy Ghost

### 4.1 Create Content PVCs

**manifests/ghost-dev/ghost-pvc.yaml:**

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ghost-content
  namespace: ghost-dev
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: longhorn
  resources:
    requests:
      storage: 5Gi
```

### 4.2 Create Ghost Deployment

**manifests/ghost-dev/ghost-deployment.yaml:**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ghost
  namespace: ghost-dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ghost
  template:
    metadata:
      labels:
        app: ghost
    spec:
      initContainers:
      - name: wait-for-mysql
        image: busybox:1.36
        command: ['sh', '-c', 'until nc -z ghost-mysql 3306; do echo "Waiting for MySQL..."; sleep 2; done; echo "MySQL is ready!"']
      containers:
      - name: ghost
        image: ghost:6.14.0
        ports:
        - containerPort: 2368
        env:
        - name: url
          value: https://blog.dev.k8s.rommelporras.com
        - name: database__client
          value: mysql
        - name: database__connection__host
          value: ghost-mysql
        - name: database__connection__port
          value: "3306"
        - name: database__connection__user
          value: ghost
        - name: database__connection__password
          valueFrom:
            secretKeyRef:
              name: ghost-mysql
              key: user-password
        - name: database__connection__database
          value: ghost
        - name: database__connection__charset
          value: utf8mb4
        - name: mail__transport
          value: SMTP
        - name: mail__options__host
          valueFrom:
            secretKeyRef:
              name: ghost-mail
              key: smtp-host
        - name: mail__options__port
          value: "587"
        - name: mail__options__secure
          value: "false"
        - name: mail__options__auth__user
          valueFrom:
            secretKeyRef:
              name: ghost-mail
              key: smtp-user
        - name: mail__options__auth__pass
          valueFrom:
            secretKeyRef:
              name: ghost-mail
              key: smtp-password
        - name: mail__from
          valueFrom:
            secretKeyRef:
              name: ghost-mail
              key: from-address
        - name: logging__level
          value: info
        - name: logging__transports
          value: '["stdout"]'
        volumeMounts:
        - name: ghost-content
          mountPath: /var/lib/ghost/content
        resources:
          requests:
            memory: "512Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /ghost/api/admin/site/
            port: 2368
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /ghost/api/admin/site/
            port: 2368
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
      volumes:
      - name: ghost-content
        persistentVolumeClaim:
          claimName: ghost-content
```

**manifests/ghost-dev/ghost-service.yaml:**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: ghost
  namespace: ghost-dev
spec:
  selector:
    app: ghost
  ports:
  - port: 2368
    targetPort: 2368
```

Prod manifests are identical except:
- `namespace: ghost-prod`
- `url: https://blog.rommelporras.com`

```bash
kubectl-homelab apply -f manifests/ghost-dev/
kubectl-homelab apply -f manifests/ghost-prod/

# Verify
kubectl-homelab get pods -n ghost-dev
kubectl-homelab get pods -n ghost-prod
```

---

## Step 5: Create HTTPRoutes

**manifests/ghost-dev/httproute.yaml:**

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: ghost
  namespace: ghost-dev
spec:
  parentRefs:
  - name: homelab-gateway
    namespace: kube-system
  hostnames:
  - blog.dev.k8s.rommelporras.com
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: ghost
      port: 2368
```

**manifests/ghost-prod/httproute.yaml:** Same with `namespace: ghost-prod` and hostname `blog.k8s.rommelporras.com`.

```bash
kubectl-homelab apply -f manifests/ghost-dev/httproute.yaml
kubectl-homelab apply -f manifests/ghost-prod/httproute.yaml
```

---

## Step 6: Configure Cloudflare Tunnel + WAF

### 6.1 Add Tunnel Route

```
Cloudflare Zero Trust → Networks → Tunnels → homelab → Public Hostname

Subdomain: blog
Domain: rommelporras.com
Type: HTTP
URL: ghost.ghost-prod.svc.cluster.local:2368
```

Add DNS record:

```
Type: CNAME
Name: blog
Target: <tunnel-id>.cfargotunnel.com
Proxy: ON
```

Update CiliumNetworkPolicy for tunnel egress to ghost-prod:

```yaml
# In manifests/cloudflare/networkpolicy.yaml, add:
- toEndpoints:
  - matchLabels:
      k8s:io.kubernetes.pod.namespace: ghost-prod
  toPorts:
  - ports:
    - port: "2368"
      protocol: TCP
```

```bash
kubectl-homelab apply -f manifests/cloudflare/networkpolicy.yaml
```

### 6.2 WAF Rules — Block Public `/ghost` Admin

Create two WAF Custom Rules in Cloudflare Dashboard (Security → WAF → Custom Rules) **in this exact order**:

**Rule 1: Ghost - Allow Content API** (must be ABOVE Rule 2)

```
Expression: (http.host eq "blog.rommelporras.com" and
             starts_with(http.request.uri.path, "/ghost/api/content"))
Action: Skip → Skip all remaining custom rules
```

Why: Ghost's Sodo Search widget calls `/ghost/api/content/` from the browser. This is read-only and requires a public API key parameter.

**Rule 2: Ghost - Block Admin** (must be BELOW Rule 1)

```
Expression: (http.host eq "blog.rommelporras.com" and
             starts_with(http.request.uri.path, "/ghost"))
Action: Block
```

Why: Blocks `/ghost/` (admin panel), `/ghost/api/admin/` (Admin API), and all `/ghost/*` paths. Content API traffic never reaches this rule because Rule 1 skips it.

Verify:

```bash
# Blocked (403)
curl -sI https://blog.rommelporras.com/ghost/ | head -5

# Allowed (200)
curl -s https://blog.rommelporras.com/ghost/api/content/settings/?key=placeholder | head -5

# Public blog works
curl -sI https://blog.rommelporras.com/ | head -5

# Internal admin still works (bypasses Cloudflare)
curl -sI https://blog.k8s.rommelporras.com/ghost/ | head -5
```

---

## Step 7: Complete Ghost Setup

Access Ghost Admin for first-time setup:

```
Dev:  https://blog.dev.k8s.rommelporras.com/ghost/
Prod: https://blog.k8s.rommelporras.com/ghost/   (internal URL, bypasses WAF)

1. Create admin account
2. Set site title and description
3. Upload theme if needed
```

---

## Step 8: Set Up Theme CI/CD

### 8.1 Create Theme Repository

```bash
# Theme repo: gitlab.k8s.rommelporras.com/0xwsh/eventually-consistent
# Public mirror: github.com/rommelporras/eventually-consistent
cd ~/personal/eventually-consistent
git remote add origin git@ssh.gitlab.k8s.rommelporras.com:0xwsh/eventually-consistent.git
git remote add github git@github.com:rommelporras/eventually-consistent.git
```

### 8.2 Create Ghost Admin API Integrations

In Ghost Admin (both dev and prod):

```
Settings → Integrations → Add custom integration → "GitLab CI/CD"
Copy Admin API Key (format: id:secret)

Store in 1Password:
  Item: Ghost Dev Admin API  → key field
  Item: Ghost Prod Admin API → key field
```

### 8.3 Add GitLab CI/CD Variables

```
Settings → CI/CD → Variables:

GHOST_DEV_URL = https://blog.dev.k8s.rommelporras.com
GHOST_DEV_ADMIN_API_KEY = (from 1Password)
GHOST_PROD_URL = https://blog.rommelporras.com
GHOST_PROD_ADMIN_API_KEY = (from 1Password)
```

> **Important:** Ghost Admin API requires JWT authentication. The pipeline generates a JWT token from the `id:secret` format key using HMAC-SHA256. Raw API keys do NOT work.

---

## Step 9: Database Sync Scripts

**scripts/sync-ghost-prod-to-dev.sh** — Syncs prod database and content to dev:

1. Dumps prod MySQL database
2. Copies prod Ghost content (images, themes)
3. Scales down dev Ghost
4. Imports database to dev MySQL
5. Updates site URL in dev database
6. Scales up dev Ghost and copies content
7. Restarts dev Ghost

**scripts/sync-ghost-prod-to-local.sh** — Dumps prod database for local docker-compose development.

```bash
chmod +x scripts/sync-ghost-prod-to-dev.sh
chmod +x scripts/sync-ghost-prod-to-local.sh
```

---

## Verification Checklist

- [ ] `ghost-dev` and `ghost-prod` namespaces exist
- [ ] MySQL StatefulSets running (1 pod each, PVCs bound)
- [ ] Ghost Deployments running (1 pod each, PVCs bound)
- [ ] HTTPRoutes resolving internally
- [ ] Cloudflare Tunnel routing `blog.rommelporras.com` to prod
- [ ] WAF rules: `/ghost/` blocked (403), `/ghost/api/content/` allowed (200)
- [ ] Ghost Admin accessible and setup complete (both environments)
- [ ] Theme repo exists in GitLab with CI/CD variables
- [ ] Theme deploys on push to develop branch
- [ ] GitHub mirror syncing
- [ ] Mail delivery working

---

## Rollback

```bash
# 1. Scale down Ghost (stops traffic)
kubectl-homelab scale deployment ghost -n ghost-dev --replicas=0
kubectl-homelab scale deployment ghost -n ghost-prod --replicas=0

# 2. Delete Ghost resources (preserves PVCs with data)
kubectl-homelab delete -f manifests/ghost-dev/ghost-deployment.yaml
kubectl-homelab delete -f manifests/ghost-prod/ghost-deployment.yaml

# 3. Full teardown (removes everything including data)
kubectl-homelab delete namespace ghost-dev
kubectl-homelab delete namespace ghost-prod
# Also remove Cloudflare Tunnel route and WAF rules
```

---

## Files Reference

| File | Purpose |
|------|---------|
| `manifests/ghost-dev/namespace.yaml` | Namespace with pod security labels |
| `manifests/ghost-dev/secret.yaml` | Documentation for imperative secret creation |
| `manifests/ghost-dev/mysql-statefulset.yaml` | MySQL 8.4.8 StatefulSet with Longhorn PVC |
| `manifests/ghost-dev/mysql-service.yaml` | Headless Service for MySQL |
| `manifests/ghost-dev/ghost-pvc.yaml` | 5Gi content PVC |
| `manifests/ghost-dev/ghost-deployment.yaml` | Ghost 6.14.0 with init container, env vars |
| `manifests/ghost-dev/ghost-service.yaml` | ClusterIP Service on port 2368 |
| `manifests/ghost-dev/httproute.yaml` | Internal HTTPRoute |
| `manifests/ghost-prod/*` | Same structure for prod namespace |
| `manifests/cloudflare/networkpolicy.yaml` | Updated with ghost-prod egress |
| `scripts/sync-ghost-prod-to-dev.sh` | Database sync: prod → dev |
| `scripts/sync-ghost-prod-to-local.sh` | Database sync: prod → local |

---

## 1Password Items

| Item | Vault | Fields |
|------|-------|--------|
| Ghost Dev MySQL | Kubernetes | `root-password`, `user-password` |
| Ghost Prod MySQL | Kubernetes | `root-password`, `user-password` |
| Ghost Dev Admin API | Kubernetes | `key` |
| Ghost Prod Admin API | Kubernetes | `key` |
| iCloud SMTP | Kubernetes | `username`, `password`, `server`, `port` (reused) |

---

## Key Learnings

| Topic | Lesson |
|-------|--------|
| StatefulSet vs Deployment | MySQL uses StatefulSet for stable network identity and persistent storage |
| Headless Service | `clusterIP: None` gives stable DNS for StatefulSet pods |
| utf8mb4 charset | Required for emoji/unicode — must be set in both MySQL args and Ghost env |
| MySQL 8.4 LTS | Uses `caching_sha2_password` by default (8.0 `mysql_native_password` deprecated) |
| Ghost health endpoint | `/ghost/api/admin/site/` — not `/` or `/health` |
| Init containers | `wait-for-mysql` ensures Ghost doesn't crash during MySQL startup |
| WAF rule ordering | Cloudflare WAF evaluates in strict order — allow Content API before blocking `/ghost` |
| Ghost Admin API | Requires JWT (HMAC-SHA256) — raw API keys don't work |
| Debian over Alpine | Ghost + Sharp works better with glibc (only 22MB larger) |

---

## Next Steps

- Deploy Uptime Kuma for endpoint monitoring (Phase 4.11)
- Migrate Invoicetron to K8s (Phase 4.9)
- Deploy Tailscale Operator for mobile access (Phase 4.10)
