# v0.18.0 — Containerized Firefox Browser

> **Release:** v0.18.0
> **Phase:** 4.21 (Firefox Browser)
> **Goal:** Deploy persistent Firefox browser accessible from any LAN device
> **Prerequisite:** [v0.4.0-observability.md](v0.4.0-observability.md) completed (Gateway API + Longhorn running)

---

## Overview

Deploys a persistent Firefox browser via KasmVNC, accessible at `browser.k8s.rommelporras.com`. Close the tab on one device, open the URL on another — same session, same tabs. Firefox profile (bookmarks, cookies, extensions) persists on Longhorn PVC.

- **Image:** `lscr.io/linuxserver/firefox:latest` (always pull for security patches)
- **Port:** 3000/TCP (KasmVNC web UI)
- **Storage:** 2Gi Longhorn PVC at `/config`
- **Auth:** Basic HTTP auth (CUSTOM_USER + PASSWORD from 1Password)
- **DNS:** AdGuard primary (10.10.30.53) + failover (10.10.30.54)
- **Namespace:** `browser`
- **Access:** LAN-only — do NOT expose via Cloudflare Tunnel

---

## Step 1: Create 1Password Item

```bash
op item create \
  --vault "Kubernetes" \
  --category login \
  --title "Firefox Browser" \
  --generate-password="20,letters,digits,symbols" \
  username=admin
```

Verify:
```bash
op read "op://Kubernetes/Firefox Browser/username"
op read "op://Kubernetes/Firefox Browser/password"
```

---

## Step 2: Apply Manifests

```bash
# Create namespace and all resources
kubectl-homelab apply -f manifests/browser/
```

This creates:
- `browser` namespace with baseline PSS enforcement
- Longhorn PVC (2Gi) for Firefox profile
- Firefox Deployment with KasmVNC
- ClusterIP Service (port 3000)
- HTTPRoute for `browser.k8s.rommelporras.com`

---

## Step 3: Create Secret

```bash
kubectl-homelab create secret generic firefox-auth \
  --from-literal=username="$(op read 'op://Kubernetes/Firefox Browser/username')" \
  --from-literal=password="$(op read 'op://Kubernetes/Firefox Browser/password')" \
  -n browser
```

---

## Step 4: Verify Deployment

```bash
# Pod should be 1/1 Running
kubectl-homelab get pods -n browser

# Check logs for clean startup
kubectl-homelab logs -n browser -l app=firefox --tail=20

# Verify HTTPRoute
kubectl-homelab get httproute -n browser
```

Access `https://browser.k8s.rommelporras.com` — should show KasmVNC login page.

---

## Step 5: Add DNS Rewrite (if needed)

If `*.k8s.rommelporras.com` wildcard exists in AdGuard, no action needed. Otherwise:

```
browser.k8s.rommelporras.com → 10.10.30.20
```

---

## Step 6: Homepage Integration

Homepage services config is applied via Kustomize:

```bash
kubectl-homelab apply -k manifests/home/homepage/
```

Firefox Browser appears in the **Apps** section.

---

## Step 7: Uptime Kuma Monitor

Add manually in Uptime Kuma UI:
- **Type:** TCP
- **Host:** `firefox.browser.svc.cluster.local`
- **Port:** `3000`
- **Name:** Firefox Browser

---

## Verification Checklist

- [ ] Firefox pod running (1/1) in `browser` namespace
- [ ] `browser.k8s.rommelporras.com` loads KasmVNC login page
- [ ] Login works with 1Password credentials
- [ ] Firefox session persists across tab close + reopen
- [ ] Session accessible from different device (same tabs visible)
- [ ] Homepage entry shows Firefox Browser
- [ ] Uptime Kuma monitoring active

---

## Rollback

```bash
kubectl-homelab delete namespace browser
```

This removes all resources (Deployment, PVC, Service, HTTPRoute, Secret).

---

## Architecture Notes

### Security Layers

| Layer | Protection |
|-------|-----------|
| Auth | CUSTOM_USER + PASSWORD (basic auth) |
| Network | LAN-only, no Cloudflare Tunnel |
| Container | allowPrivilegeEscalation: false, drop ALL caps + add minimum |
| Seccomp | RuntimeDefault profile |
| PSS | Baseline enforce, restricted audit/warn |
| DNS | AdGuard (ad-blocking + tracker blocking) |

### Why TCP Probes

KasmVNC's basic auth returns HTTP 401 on unauthenticated requests. HTTP probes would fail every check, causing a restart loop. TCP probes just verify the port is listening.

### Linux Capabilities

LinuxServer images use s6-overlay init system which needs specific capabilities:

| Capability | Reason |
|-----------|--------|
| CHOWN | s6 init chowns /config, /run, nginx dirs |
| SETUID | s6 switches to PUID user |
| SETGID | s6 sets supplementary groups |
| DAC_OVERRIDE | nginx writes to root-owned log dirs |
| FOWNER | s6 chmods /config files |
