# v0.12.0 — Domain Migration

> **Release:** v0.12.0
> **Phase:** 4.13
> **Goal:** Migrate all K8s services from `*.k8s.home.rommelporras.com` to `*.k8s.rommelporras.com` with tiered wildcards
> **Prerequisite:** [v0.11.0-ghost-blog.md](v0.11.0-ghost-blog.md) completed

---

## Overview

This release migrates all Kubernetes service domains from `*.k8s.home.rommelporras.com` to a shorter, corporate-style `*.k8s.rommelporras.com` with environment tiers. The migration is zero-downtime: old and new domains coexist during cutover, and old domains are removed only after full verification.

**Domain Tiers:**

| Tier | Wildcard | Purpose |
|------|----------|---------|
| Base | `*.k8s.rommelporras.com` | Infrastructure + production apps |
| Dev | `*.dev.k8s.rommelporras.com` | Development environments |
| Stg | `*.stg.k8s.rommelporras.com` | Staging environments |

**Convention:** Production is the default — no environment qualifier. Non-production gets `dev` or `stg`.

**Boundary:** `*.home.rommelporras.com` stays for Proxmox/legacy services (OMV, OPNsense, failover AdGuard LXC).

**Complete Domain Mapping:**

| Service | Old Domain | New Domain |
|---------|-----------|------------|
| Homepage | portal.k8s.home.rommelporras.com | portal.k8s.rommelporras.com |
| Grafana | grafana.k8s.home.rommelporras.com | grafana.k8s.rommelporras.com |
| AdGuard | adguard.k8s.home.rommelporras.com | adguard.k8s.rommelporras.com |
| Longhorn | longhorn.k8s.home.rommelporras.com | longhorn.k8s.rommelporras.com |
| GitLab | gitlab.k8s.home.rommelporras.com | gitlab.k8s.rommelporras.com |
| Registry | registry.k8s.home.rommelporras.com | registry.k8s.rommelporras.com |
| Blog Prod | blog.k8s.home.rommelporras.com | blog.k8s.rommelporras.com |
| Portfolio Prod | portfolio-prod.k8s.home.rommelporras.com | portfolio.k8s.rommelporras.com |
| Blog Dev | blog-dev.k8s.home.rommelporras.com | blog.dev.k8s.rommelporras.com |
| Portfolio Dev | portfolio-dev.k8s.home.rommelporras.com | portfolio.dev.k8s.rommelporras.com |
| Portfolio Stg | portfolio-staging.k8s.home.rommelporras.com | portfolio.stg.k8s.rommelporras.com |
| K8s API | k8s-api.home.rommelporras.com | api.k8s.rommelporras.com |
| Blog Public | blog.rommelporras.com | blog.rommelporras.com (no change) |

---

## Step 1: Pre-flight — Failover DNS

> **WHY FIRST:** If K8s AdGuard restarts during migration, all clients fall back to the LXC at
> 10.10.30.54. Without new rewrites there, new domains won't resolve.

### 1.1 Update Failover AdGuard LXC (web UI)

Add these DNS rewrites in the LXC AdGuard web UI (`http://10.10.30.54:3000`):

```
*.k8s.rommelporras.com        → 10.10.30.20
*.dev.k8s.rommelporras.com    → 10.10.30.20
*.stg.k8s.rommelporras.com    → 10.10.30.20
api.k8s.rommelporras.com      → 10.10.30.10
cp1.k8s.rommelporras.com      → 10.10.30.11
cp2.k8s.rommelporras.com      → 10.10.30.12
cp3.k8s.rommelporras.com      → 10.10.30.13
```

> **Do NOT remove old rewrites yet.** Both old and new must coexist.

### 1.2 Verify Failover DNS

```bash
nslookup portal.k8s.rommelporras.com 10.10.30.54
nslookup api.k8s.rommelporras.com 10.10.30.54
nslookup blog.dev.k8s.rommelporras.com 10.10.30.54
```

---

## Step 2: Update K8s AdGuard DNS (additive)

### 2.1 Update AdGuard ConfigMap

Edit `manifests/home/adguard/configmap.yaml` — add new rewrites **alongside** existing ones:

```yaml
rewrites:
  # NPM (Nginx Proxy Manager) - legacy *.home services
  - domain: '*.home.rommelporras.com'
    answer: 10.10.30.80

  # OLD K8s services (keep during migration, remove in cleanup)
  - domain: '*.k8s.home.rommelporras.com'
    answer: 10.10.30.20

  # NEW K8s services — Gateway VIP
  - domain: '*.k8s.rommelporras.com'
    answer: 10.10.30.20
  - domain: '*.dev.k8s.rommelporras.com'
    answer: 10.10.30.20
  - domain: '*.stg.k8s.rommelporras.com'
    answer: 10.10.30.20

  # NEW API server — explicit override (VIP, NOT Gateway)
  - domain: api.k8s.rommelporras.com
    answer: 10.10.30.10

  # NEW node hostnames
  - domain: cp1.k8s.rommelporras.com
    answer: 10.10.30.11
  - domain: cp2.k8s.rommelporras.com
    answer: 10.10.30.12
  - domain: cp3.k8s.rommelporras.com
    answer: 10.10.30.13

  # OLD node hostnames (keep during migration)
  - domain: k8s-cp1.home.rommelporras.com
    answer: 10.10.30.11
  # ... etc
```

### 2.2 Apply and Restart

```bash
kubectl-homelab apply -f manifests/home/adguard/configmap.yaml
kubectl-homelab -n home rollout restart deployment adguard
kubectl-homelab -n home rollout status deployment adguard
```

### 2.3 Verify Both Old and New DNS

```bash
# New domains
nslookup portal.k8s.rommelporras.com 10.10.30.53
nslookup api.k8s.rommelporras.com 10.10.30.53

# Old domains still work
nslookup portal.k8s.home.rommelporras.com 10.10.30.53
```

---

## Step 3: Add New Gateway Listeners

> **Strategy:** Keep old listener as `https` (existing HTTPRoutes stay working), add new listeners alongside it.

### 3.1 Update Gateway Manifest

Edit `manifests/gateway/homelab-gateway.yaml` — add 3 new listeners:

```yaml
listeners:
  - name: http
    protocol: HTTP
    port: 80
    allowedRoutes:
      namespaces:
        from: All

  # OLD listener — keep so existing HTTPRoutes still work
  - name: https
    protocol: HTTPS
    port: 443
    hostname: "*.k8s.home.rommelporras.com"
    tls:
      certificateRefs:
        - name: wildcard-k8s-home-tls

  # NEW: Base (infra + production)
  - name: https-base
    protocol: HTTPS
    port: 443
    hostname: "*.k8s.rommelporras.com"
    tls:
      certificateRefs:
        - name: wildcard-k8s-tls

  # NEW: Development
  - name: https-dev
    protocol: HTTPS
    port: 443
    hostname: "*.dev.k8s.rommelporras.com"
    tls:
      certificateRefs:
        - name: wildcard-dev-k8s-tls

  # NEW: Staging
  - name: https-stg
    protocol: HTTPS
    port: 443
    hostname: "*.stg.k8s.rommelporras.com"
    tls:
      certificateRefs:
        - name: wildcard-stg-k8s-tls
```

### 3.2 Apply and Wait for Certs

```bash
kubectl-homelab apply -f manifests/gateway/homelab-gateway.yaml

# Wait for all 3 new certificates to reach Ready
kubectl-homelab get certificate -A -w
```

Wait until `wildcard-k8s-tls`, `wildcard-dev-k8s-tls`, `wildcard-stg-k8s-tls` all show `Ready: True`. DNS-01 challenges take 1-5 minutes each.

> **DO NOT proceed until all 3 are Ready.** If a cert fails, check cert-manager logs:
> `kubectl-homelab -n cert-manager logs -l app=cert-manager --tail=50`

### 3.3 Verify Existing Services Unchanged

```bash
curl -sk https://portal.k8s.home.rommelporras.com | head -5
curl -sk https://grafana.k8s.home.rommelporras.com/api/health
```

---

## Step 4: Renew API Server Certificate

> **WHY:** The API server cert only has `k8s-api.home.rommelporras.com` as a SAN.
> We need to add `api.k8s.rommelporras.com` before updating kubeconfig.

### 4.1 Update kubeadm ClusterConfiguration ConfigMap

```bash
kubectl-homelab -n kube-system get cm kubeadm-config -o yaml > /tmp/kubeadm-config-backup.yaml

kubectl-homelab -n kube-system edit cm kubeadm-config
# In ClusterConfiguration, add apiServer.certSANs:
#   apiServer:
#     certSANs:
#       - api.k8s.rommelporras.com
#       - k8s-api.home.rommelporras.com   (keep for rollback)
```

### 4.2 Renew on Each Node (one at a time)

```bash
# k8s-cp1
ssh wawashi@10.10.30.11
sudo kubeadm certs renew apiserver
sudo crictl pods --name kube-apiserver -q | xargs sudo crictl stopp
sleep 15
sudo openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text | grep "api.k8s.rommelporras.com"

# Verify cluster health before next node
kubectl-homelab get nodes   # all 3 must show Ready
```

Repeat for k8s-cp2 (10.10.30.12) and k8s-cp3 (10.10.30.13).

### 4.3 Update Local Kubeconfig

```bash
# Edit ~/.kube/homelab.yaml
# Change: server: https://k8s-api.home.rommelporras.com:6443
# To:     server: https://api.k8s.rommelporras.com:6443
```

### 4.4 Verify

```bash
kubectl-homelab get nodes
kubectl-homelab cluster-info
```

---

## Step 5: Cutover — GitLab (first, registry dependency)

> **WHY FIRST:** Portfolio pulls container images from registry. Registry must work on new domain first.

### 5.1 Update GitLab Helm Values

Edit `helm/gitlab/values.yaml`:

```yaml
global:
  hosts:
    domain: k8s.rommelporras.com
    gitlab:
      name: gitlab.k8s.rommelporras.com
    registry:
      name: registry.k8s.rommelporras.com
```

### 5.2 Update HTTPRoutes

Edit `manifests/gateway/routes/gitlab.yaml`:
```yaml
hostnames: ["gitlab.k8s.rommelporras.com"]
parentRefs:
  - name: homelab-gateway
    namespace: default
    sectionName: https-base    # temporary, becomes https after cleanup
```

Edit `manifests/gateway/routes/gitlab-registry.yaml`:
```yaml
hostnames: ["registry.k8s.rommelporras.com"]
parentRefs:
  - name: homelab-gateway
    namespace: default
    sectionName: https-base
```

### 5.3 Apply

```bash
kubectl-homelab apply -f manifests/gateway/routes/gitlab.yaml
kubectl-homelab apply -f manifests/gateway/routes/gitlab-registry.yaml

helm-homelab upgrade gitlab gitlab/gitlab \
  -n gitlab \
  -f helm/gitlab/values.yaml \
  --timeout 10m

curl -sk https://gitlab.k8s.rommelporras.com/users/sign_in | grep "GitLab"
curl -sk https://registry.k8s.rommelporras.com/v2/ | head -5
```

### 5.4 Update GitLab Runner

Edit `helm/gitlab-runner/values.yaml`:
```yaml
gitlabUrl: https://gitlab.k8s.rommelporras.com
```

```bash
helm-homelab upgrade gitlab-runner gitlab/gitlab-runner \
  -n gitlab-runner \
  -f helm/gitlab-runner/values.yaml
```

---

## Step 6: Cutover — Portfolio

Edit `manifests/gateway/routes/portfolio-prod.yaml`:
```yaml
hostnames: ["portfolio.k8s.rommelporras.com"]
sectionName: https-base
```

Edit `manifests/gateway/routes/portfolio-dev.yaml`:
```yaml
hostnames: ["portfolio.dev.k8s.rommelporras.com"]
sectionName: https-dev
```

Edit `manifests/gateway/routes/portfolio-staging.yaml`:
```yaml
hostnames: ["portfolio.stg.k8s.rommelporras.com"]
sectionName: https-stg
```

```bash
kubectl-homelab apply -f manifests/gateway/routes/portfolio-prod.yaml
kubectl-homelab apply -f manifests/gateway/routes/portfolio-dev.yaml
kubectl-homelab apply -f manifests/gateway/routes/portfolio-staging.yaml
```

---

## Step 7: Cutover — Grafana

Edit `manifests/monitoring/grafana-httproute.yaml`:
```yaml
hostnames: [grafana.k8s.rommelporras.com]
sectionName: https-base
```

Edit `helm/prometheus/values.yaml`:
```yaml
grafana:
  grafana.ini:
    server:
      root_url: https://grafana.k8s.rommelporras.com
```

```bash
kubectl-homelab apply -f manifests/monitoring/grafana-httproute.yaml
./scripts/upgrade-prometheus.sh

curl -sk https://grafana.k8s.rommelporras.com/api/health
```

> **Lesson Learned:** Grafana uses a Longhorn RWO PVC. If the Helm upgrade triggers a new ReplicaSet with RollingUpdate strategy, the new pod may schedule on a different node than where the volume is attached. This causes a deadlock (old pod won't terminate until new is ready, new pod can't start without volume). Fix: `kubectl-homelab -n monitoring scale deployment prometheus-grafana --replicas=0` then `--replicas=1`.

---

## Step 8: Cutover — Longhorn, AdGuard, Ghost

These are independent — order doesn't matter.

### 8.1 Longhorn

Edit `manifests/storage/longhorn/httproute.yaml`:
```yaml
hostnames: [longhorn.k8s.rommelporras.com]
sectionName: https-base
```

### 8.2 AdGuard

Edit `manifests/home/adguard/httproute.yaml`:
```yaml
hostnames: [adguard.k8s.rommelporras.com]
sectionName: https-base
```

### 8.3 Ghost Dev

Edit `manifests/ghost-dev/httproute.yaml`:
```yaml
hostnames: [blog.dev.k8s.rommelporras.com]
sectionName: https-dev
```

Edit `manifests/ghost-dev/ghost-deployment.yaml`:
```yaml
env:
  - name: url
    value: "https://blog.dev.k8s.rommelporras.com"
```

```bash
kubectl-homelab -n ghost-dev rollout restart deployment ghost
```

### 8.4 Ghost Prod

Edit `manifests/ghost-prod/httproute.yaml`:
```yaml
hostnames: [blog.k8s.rommelporras.com]
sectionName: https-base
```

> Ghost prod `url` env is `https://blog.rommelporras.com` (Cloudflare Tunnel) — no change needed.

---

## Step 9: Cutover — Homepage (last)

> **WHY LAST:** Homepage has ~33 bookmark URLs. All services must be on new domains first.

### 9.1 Update HTTPRoute

Edit `manifests/home/homepage/httproute.yaml`:
```yaml
hostnames: [portal.k8s.rommelporras.com]
sectionName: https-base
```

### 9.2 Update HOMEPAGE_ALLOWED_HOSTS

Edit `manifests/home/homepage/deployment.yaml`:
```yaml
env:
  - name: HOMEPAGE_ALLOWED_HOSTS
    value: "portal.k8s.rommelporras.com"
```

### 9.3 Update Bookmark URLs

Edit `manifests/home/homepage/config/services.yaml`:

> **DANGER: This file has BOTH `k8s.home.rommelporras.com` (K8s) AND `home.rommelporras.com`
> (Proxmox/legacy) URLs. DO NOT blindly find-replace.**

**Only change K8s domains:**
- `grafana.k8s.home.rommelporras.com` → `grafana.k8s.rommelporras.com`
- `adguard.k8s.home.rommelporras.com` → `adguard.k8s.rommelporras.com`
- `longhorn.k8s.home.rommelporras.com` → `longhorn.k8s.rommelporras.com`
- `blog-dev.k8s.home.rommelporras.com` → `blog.dev.k8s.rommelporras.com`
- `homepage.k8s.home.rommelporras.com` → `portal.k8s.rommelporras.com`

**DO NOT change Proxmox/legacy domains** (`pve.home`, `firewall.home`, `omv.home`, etc.)

### 9.4 Apply

```bash
kubectl-homelab apply -f manifests/home/homepage/httproute.yaml
kubectl-homelab apply -f manifests/home/homepage/deployment.yaml
kubectl-homelab apply -f manifests/home/homepage/config/services.yaml \
                       -f manifests/home/homepage/config/settings.yaml
kubectl-homelab -n home rollout restart deployment homepage
```

---

## Step 10: Remaining Items

### 10.1 Update Ansible Group Vars

Edit `ansible/group_vars/all.yml`:
```yaml
vip_hostname: "api.k8s.rommelporras.com"
```

Edit `ansible/group_vars/control_plane.yml`:
```yaml
cert_sans:
  - "api.k8s.rommelporras.com"
  - "10.10.30.10"
  - "10.10.30.11"
  - "10.10.30.12"
  - "10.10.30.13"
```

### 10.2 Update Local SSH Config

Edit `~/.ssh/config`:
```
Host gitlab.k8s.rommelporras.com
HostName ssh.gitlab.k8s.rommelporras.com
User git
```

### 10.3 Update Ghost Sync Script

Edit `scripts/sync-ghost-prod-to-dev.sh` — update URL to `https://blog.dev.k8s.rommelporras.com`.

---

## Step 11: Full Verification

| Service | URL | Expected |
|---------|-----|----------|
| Homepage | `https://portal.k8s.rommelporras.com` | Dashboard |
| Grafana | `https://grafana.k8s.rommelporras.com` | Login page |
| AdGuard | `https://adguard.k8s.rommelporras.com` | Admin UI |
| Longhorn | `https://longhorn.k8s.rommelporras.com` | Dashboard |
| GitLab | `https://gitlab.k8s.rommelporras.com` | Login page |
| Registry | `https://registry.k8s.rommelporras.com/v2/` | `{}` or auth |
| Blog Prod | `https://blog.k8s.rommelporras.com` | Ghost blog |
| Blog Public | `https://blog.rommelporras.com` | Ghost blog (tunnel) |
| Portfolio Prod | `https://portfolio.k8s.rommelporras.com` | Portfolio |
| Portfolio Dev | `https://portfolio.dev.k8s.rommelporras.com` | Portfolio |
| Portfolio Stg | `https://portfolio.stg.k8s.rommelporras.com` | Portfolio |
| Blog Dev | `https://blog.dev.k8s.rommelporras.com` | Ghost blog |
| K8s API | `kubectl-homelab get nodes` | 3 nodes Ready |
| GitLab SSH | `ssh -T git@gitlab.k8s.rommelporras.com` | Welcome |

---

## Step 12: Cleanup — Remove Legacy Domain

> **Only after full verification. This is the point of no return.**

### 12.1 Remove Old Gateway Listener and Rename

Edit `manifests/gateway/homelab-gateway.yaml`:
- Remove the `https` listener (old `*.k8s.home.rommelporras.com`)
- Rename `https-base` → `https`

### 12.2 Update All HTTPRoute sectionNames

All HTTPRoutes referencing `sectionName: https-base` → change to `sectionName: https`.

```bash
kubectl-homelab apply -f manifests/gateway/homelab-gateway.yaml
kubectl-homelab apply -f manifests/gateway/routes/
kubectl-homelab apply -f manifests/monitoring/grafana-httproute.yaml
kubectl-homelab apply -f manifests/storage/longhorn/httproute.yaml
kubectl-homelab apply -f manifests/home/adguard/httproute.yaml
kubectl-homelab apply -f manifests/home/homepage/httproute.yaml
kubectl-homelab apply -f manifests/ghost-dev/httproute.yaml
kubectl-homelab apply -f manifests/ghost-prod/httproute.yaml
```

### 12.3 Remove Old AdGuard DNS Rewrites

Edit `manifests/home/adguard/configmap.yaml` — remove old `*.k8s.home.rommelporras.com` and old node hostname rewrites.

Also add `ssh.gitlab.k8s.rommelporras.com → 10.10.30.21` if not already present.

Remove old rewrites from both K8s AdGuard (web UI) and failover AdGuard LXC (web UI).

### 12.4 Delete Orphaned TLS Secret

```bash
kubectl-homelab delete secret wildcard-k8s-home-tls -n default
```

### 12.5 Verify Cleanup

```bash
# All services still work
curl -sk https://portal.k8s.rommelporras.com | head -5
curl -sk https://grafana.k8s.rommelporras.com/api/health

# Old domains get TLS handshake failure (no listener)
curl -sk https://portal.k8s.home.rommelporras.com
# Expected: exit code 35 (SSL connect error)
```

---

## Verification Checklist

- [ ] All 11 services accessible on new `*.k8s.rommelporras.com` domains
- [ ] Dev services on `*.dev.k8s.rommelporras.com`
- [ ] Staging services on `*.stg.k8s.rommelporras.com`
- [ ] `kubectl-homelab get nodes` works via `api.k8s.rommelporras.com`
- [ ] GitLab SSH works via `ssh -T git@gitlab.k8s.rommelporras.com`
- [ ] Blog public via `blog.rommelporras.com` (Cloudflare Tunnel)
- [ ] Old `*.k8s.home.rommelporras.com` rejected (TLS handshake failure)
- [ ] No alerts firing in Discord #status
- [ ] Failover AdGuard LXC updated
- [ ] Cloudflare Tunnel routes use service names (not old domains)

---

## Rollback

### During migration (old domain still active):
- **Per-service:** Revert single HTTPRoute + config, re-apply
- **Full rollback:** `git checkout manifests/ helm/ scripts/ ansible/` and re-apply all
- **Kubeconfig:** Revert `~/.kube/homelab.yaml` to `k8s-api.home.rommelporras.com`

### After cleanup (point of no return):
- Old DNS rewrites must be re-added manually in AdGuard
- Old Gateway listener must be re-added to manifest
- Old TLS secret: cert-manager recreates if listener is re-added

### Emergency (lost all access):
- SSH to nodes uses IPs directly (10.10.30.11/12/13) — not affected by DNS
- kubeconfig can use IP: `server: https://10.10.30.10:6443`

---

## Files Reference

| File | Purpose |
|------|---------|
| `manifests/gateway/homelab-gateway.yaml` | Gateway with 4 listeners |
| `manifests/gateway/routes/*.yaml` | HTTPRoutes (gitlab, registry, portfolio) |
| `manifests/monitoring/grafana-httproute.yaml` | Grafana HTTPRoute |
| `manifests/storage/longhorn/httproute.yaml` | Longhorn HTTPRoute |
| `manifests/home/adguard/httproute.yaml` | AdGuard HTTPRoute |
| `manifests/home/adguard/configmap.yaml` | DNS rewrites (rebuild template) |
| `manifests/home/homepage/httproute.yaml` | Homepage HTTPRoute |
| `manifests/home/homepage/deployment.yaml` | HOMEPAGE_ALLOWED_HOSTS |
| `manifests/home/homepage/config/services.yaml` | Bookmark URLs |
| `manifests/ghost-dev/httproute.yaml` | Ghost dev HTTPRoute |
| `manifests/ghost-dev/ghost-deployment.yaml` | Ghost dev URL env |
| `manifests/ghost-prod/httproute.yaml` | Ghost prod HTTPRoute |
| `helm/gitlab/values.yaml` | GitLab domain config |
| `helm/gitlab-runner/values.yaml` | Runner gitlabUrl |
| `helm/prometheus/values.yaml` | Grafana root_url |
| `ansible/group_vars/all.yml` | VIP hostname |
| `ansible/group_vars/control_plane.yml` | API server cert SANs |
| `scripts/sync-ghost-prod-to-dev.sh` | Ghost sync URL |

---

## Key Learnings

| Topic | Lesson |
|-------|--------|
| Multi-listener Gateway | One Gateway can have multiple HTTPS listeners on port 443, differentiated by hostname |
| Wildcard cert hierarchy | `*.k8s.rommelporras.com` does NOT cover `*.dev.k8s.rommelporras.com` — each level needs its own cert |
| sectionName routing | HTTPRoutes use `sectionName` to bind to specific Gateway listeners |
| DNS-01 challenges | cert-manager + Cloudflare API token handles ACME DNS-01 for wildcard certs automatically |
| kubeadm cert SANs | Update ConfigMap first, then `kubeadm certs renew apiserver` on each node — one at a time |
| RWO PVC deadlock | RollingUpdate + Longhorn RWO volume = deadlock if new pod schedules on wrong node. Fix: scale 0→1 |
| Additive migration | Add new alongside old, cutover service by service, verify, then cleanup old |
| AdGuard configmap vs live | ConfigMap is rebuild template only. Live changes require web UI (AdGuard manages own config on PVC) |
| Cloudflare Tunnel | Tunnel routes use K8s service names, not domains — unaffected by domain migration |

---

## Next Steps

- Deploy Uptime Kuma for endpoint monitoring (Phase 4.11)
- Migrate Invoicetron to K8s (Phase 4.9)
- Deploy Tailscale Operator for mobile access (Phase 4.10)
