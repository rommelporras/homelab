# v0.23.0 — ARR Media Stack

> **Release:** v0.23.0
> **Phase:** 4.25 (ARR Media Stack)
> **Goal:** Deploy self-hosted media automation (Prowlarr, Sonarr, Radarr, qBittorrent, Jellyfin, Bazarr)
> **Prerequisite:** [v0.22.0-tailscale-operator.md](v0.22.0-tailscale-operator.md) completed, NFS storage on OMV NAS operational

---

## Overview

Deploys 6 media automation apps to the `arr-stack` namespace with shared NFS storage for hardlink support. Media files live on NFS (OMV NAS), app config on Longhorn PVCs (2Gi each, 5Gi for Jellyfin).

```
Prowlarr (indexers) → Sonarr/Radarr (media managers) → qBittorrent (downloads)
                                                              ↓
                                              NFS: /data/torrents/ → /data/media/ (hardlinks)
                                                              ↓
                                                     Jellyfin (media server)
                                                     Bazarr (subtitles)
```

**Deployment order:** Deploy all 6 apps first (Steps 3-8), then configure cross-app integrations (Step 9). Prowlarr needs Sonarr/Radarr API keys, and Sonarr/Radarr need the Jellyfin API key for auto library refresh — these are configured after all apps are running.

---

## Step 1: Create NFS Directory on NAS

SSH to NAS and create the media directory structure:

```bash
ssh wawashi@omv.home.rommelporras.com

sudo mkdir -p /export/Kubernetes/Media/{torrents/{movies,series,music},media/{movies,series,music}}
sudo chown -R 1000:1000 /export/Kubernetes/Media
```

No new NFS export needed — uses existing `/export/Kubernetes` export.

> **Note:** `music/` directories are created for future use (Lidarr). Not used in this phase.

---

## Step 2: Apply Namespace and Storage

```bash
kubectl-homelab apply -f manifests/arr-stack/namespace.yaml
kubectl-homelab apply -f manifests/arr-stack/nfs-pv-pvc.yaml
kubectl-homelab apply -f manifests/arr-stack/networkpolicy.yaml

# Verify
kubectl-homelab get ns arr-stack
kubectl-homelab get pv arr-data-nfs
kubectl-homelab get pvc -n arr-stack
```

> **Note:** `arr-api-keys-secret.yaml` also exists in `manifests/arr-stack/` as a documentation placeholder — the actual secret is created by `scripts/apply-arr-secrets.sh` in Step 10.

---

## Step 3: Deploy Prowlarr

Prowlarr is an indexer — it doesn't read/write media files, so it doesn't mount the shared NFS volume (only its config PVC).

```bash
kubectl-homelab apply -f manifests/arr-stack/prowlarr/
kubectl-homelab -n arr-stack rollout status deploy/prowlarr

# Verify
curl -skI https://prowlarr.k8s.rommelporras.com
```

### Prowlarr UI Setup

1. **Authentication:** Settings → General → Authentication → Forms (Login Page), Authentication Required → Disabled for Local Addresses
2. **Set credentials** from 1Password `ARR Stack` item (username/password)
3. **Add indexers:** Indexers → Add → search each:
   - EZTV, YTS, Nyaa.si (all public, no account needed)
   - Skip: 1337x (Cloudflare DDoS protection blocks Prowlarr), TheRARBG (removed from Prowlarr index)
4. **API Key:** Settings → General → API Key → copy and store in 1Password `ARR Stack` > `prowlarr-api-key`

> **Note:** Sonarr/Radarr app integrations are configured in Step 9 after all apps are deployed.

---

## Step 4: Deploy qBittorrent

```bash
kubectl-homelab apply -f manifests/arr-stack/qbittorrent/
kubectl-homelab -n arr-stack rollout status deploy/qbittorrent
```

### qBittorrent UI Setup

1. **Get temporary password:**
   ```bash
   kubectl-homelab logs -n arr-stack deploy/qbittorrent | grep "temporary password"
   ```
2. **Login** at https://qbit.k8s.rommelporras.com with `admin` / temporary password
3. **Change credentials:** Options → Web UI → Authentication → set username/password from 1Password `ARR Stack`
4. **Default Torrent Management Mode:** Options → Downloads → set to `Automatic`
5. **Default Save Path:** `/data/torrents`
6. **Categories:** Add `movies` (save path: empty) and `series` (save path: empty) — Automatic mode appends category name to default save path (`/data/torrents/movies/`, `/data/torrents/series/`)
7. **Seeding Limits:** Options → BitTorrent → When ratio reaches `0` → then `Stop torrent`
8. **NFS Tuning:** Options → Advanced:
   - Asynchronous I/O threads: `64`
   - Disk IO type: `Simple pread/pwrite`
   - Disk queue size: `65536` KiB (64 MiB)
   - (Disk IO type change requires pod restart)

---

## Step 5: Deploy Sonarr

```bash
kubectl-homelab apply -f manifests/arr-stack/sonarr/
kubectl-homelab -n arr-stack rollout status deploy/sonarr
```

### Sonarr UI Setup

1. **Authentication:** Settings → General → Authentication → Forms, Authentication Required → Disabled for Local Addresses
2. **Set credentials** from 1Password `ARR Stack` item
3. **Download Client:** Settings → Download Clients → Add → qBittorrent:
   - Host: `qbittorrent.arr-stack.svc.cluster.local`, Port: `8080`
   - Username/Password from 1Password `ARR Stack`
   - Category: `series`
4. **Root Folder:** Settings → Media Management → Add Root Folder → `/data/media/series/`
5. **API Key:** Settings → General → API Key → copy and store in 1Password `ARR Stack` > `sonarr-api-key`

---

## Step 6: Deploy Radarr

```bash
kubectl-homelab apply -f manifests/arr-stack/radarr/
kubectl-homelab -n arr-stack rollout status deploy/radarr
```

### Radarr UI Setup

1. **Authentication:** Settings → General → Authentication → Forms, Authentication Required → Disabled for Local Addresses
2. **Set credentials** from 1Password `ARR Stack` item
3. **Download Client:** Settings → Download Clients → Add → qBittorrent:
   - Host: `qbittorrent.arr-stack.svc.cluster.local`, Port: `8080`
   - Username/Password from 1Password `ARR Stack`
   - Category: `movies`
4. **Root Folder:** Settings → Media Management → Add Root Folder → `/data/media/movies/`
5. **API Key:** Settings → General → API Key → copy and store in 1Password `ARR Stack` > `radarr-api-key`

---

## Step 7: Deploy Jellyfin

```bash
kubectl-homelab apply -f manifests/arr-stack/jellyfin/
kubectl-homelab -n arr-stack rollout status deploy/jellyfin
```

### Jellyfin Setup Wizard

1. **Language:** English
2. **Admin account:** Create with credentials from 1Password
3. **Media Libraries:**
   - Movies: Content type `Movies`, Folder `/data/media/movies/`, uncheck Nfo metadata saver
   - Shows: Content type `Shows`, Display name `Series`, Folder `/data/media/series/`, uncheck Nfo metadata saver
4. **Remote Access:** Enable remote connections, keep default port
5. **API Key:** Administration → API Keys → Create (`Homepage`), store in 1Password `ARR Stack` > `jellyfin-api-key`

---

## Step 8: Deploy Bazarr

```bash
kubectl-homelab apply -f manifests/arr-stack/bazarr/
kubectl-homelab -n arr-stack rollout status deploy/bazarr
```

### Bazarr UI Setup

1. **Authentication:** Settings → General → Authentication → Forms, Authentication Required → Disabled for Local Addresses
2. **Sonarr connection:** Settings → Sonarr → Enabled, Host `sonarr.arr-stack.svc.cluster.local`, Port `8989`, API Key from 1Password
3. **Radarr connection:** Settings → Radarr → Enabled, Host `radarr.arr-stack.svc.cluster.local`, Port `7878`, API Key from 1Password
4. **Providers:** Settings → Providers → Add:
   - **OpenSubtitles.com:** username/password from 1Password `Opensubtitles`, uncheck AI-translated and Machine-translated, keep Use Hash
   - **Podnapisi:** keep Verify SSL certificate checked
5. **Languages:** Settings → Languages:
   - Create profile "English" — Language: English, Forced: Normal or hearing-impaired, Provider exclusion: Always
   - Set as default for both Series and Movies
6. **API Key:** Settings → General → Security → API Key → store in 1Password `ARR Stack` > `bazarr-api-key`

---

## Step 9: Configure Cross-App Integrations

Now that all apps are deployed and API keys are stored in 1Password, configure the inter-app connections.

### Prowlarr → Sonarr/Radarr

In Prowlarr UI (https://prowlarr.k8s.rommelporras.com):

1. **Add Apps:** Settings → Apps → Add:
   - **Sonarr:** Prowlarr Server = `http://prowlarr.arr-stack.svc.cluster.local:9696`, Sonarr Server = `http://sonarr.arr-stack.svc.cluster.local:8989`, API Key from Sonarr
   - **Radarr:** Same pattern, Radarr Server = `http://radarr.arr-stack.svc.cluster.local:7878`, API Key from Radarr
2. **Sync App Indexers:** After adding apps, click "Sync App Indexers" to push indexers

### Sonarr/Radarr → Jellyfin (Auto Library Refresh)

NFS doesn't support inotify, so Jellyfin can't detect new files automatically. Add a Connect integration in both Sonarr and Radarr to notify Jellyfin on import:

- Settings → Connect → Add → Emby / Jellyfin
- Host: `jellyfin.arr-stack.svc.cluster.local`, Port: `8096`
- API Key: from 1Password `ARR Stack` > `jellyfin-api-key`
- Triggers: On Import, On Upgrade

---

## Step 10: Create arr-api-keys Secret

For Phase 4.26 companion apps (Configarr, Scraparr, Unpackerr):

```bash
eval $(op signin)
./scripts/apply-arr-secrets.sh

# Verify
kubectl-homelab -n arr-stack get secret arr-api-keys
```

---

## Step 11: Homepage Widgets

Patch the Homepage secret with ARR API keys:

```bash
eval $(op signin)

kubectl-homelab -n home patch secret homepage-secrets --type merge -p "{\"stringData\":{
  \"HOMEPAGE_VAR_JELLYFIN_KEY\":\"$(op read 'op://Kubernetes/ARR Stack/jellyfin-api-key')\",
  \"HOMEPAGE_VAR_SONARR_API_KEY\":\"$(op read 'op://Kubernetes/ARR Stack/sonarr-api-key')\",
  \"HOMEPAGE_VAR_RADARR_API_KEY\":\"$(op read 'op://Kubernetes/ARR Stack/radarr-api-key')\",
  \"HOMEPAGE_VAR_PROWLARR_API_KEY\":\"$(op read 'op://Kubernetes/ARR Stack/prowlarr-api-key')\",
  \"HOMEPAGE_VAR_BAZARR_API_KEY\":\"$(op read 'op://Kubernetes/ARR Stack/bazarr-api-key')\",
  \"HOMEPAGE_VAR_QBIT_USER\":\"$(op read 'op://Kubernetes/ARR Stack/username')\",
  \"HOMEPAGE_VAR_QBIT_PASS\":\"$(op read 'op://Kubernetes/ARR Stack/password')\"}}"

kubectl-homelab apply -k manifests/home/homepage/
kubectl-homelab -n home rollout restart deploy/homepage
```

---

## Step 12: Uptime Kuma Monitors

Add 6 monitors under "Media" group with "Kubernetes" tag:

| Service | URL | Accepted Codes |
|---------|-----|---------------|
| Prowlarr | https://prowlarr.k8s.rommelporras.com | 200-299, 403 |
| Sonarr | https://sonarr.k8s.rommelporras.com | 200-299, 403 |
| Radarr | https://radarr.k8s.rommelporras.com | 200-299, 403 |
| qBittorrent | https://qbit.k8s.rommelporras.com | 200-299, 403 |
| Jellyfin | https://jellyfin.k8s.rommelporras.com | 200-299, 403 |
| Bazarr | https://bazarr.k8s.rommelporras.com | 200-299, 403 |

All return 403 from external monitoring due to auth + NetworkPolicy restrictions.

---

## Verification

```bash
# All pods running
kubectl-homelab -n arr-stack get pods

# All PVCs bound
kubectl-homelab -n arr-stack get pvc

# NFS mount working (use sonarr — prowlarr doesn't mount NFS)
kubectl-homelab -n arr-stack exec deploy/sonarr -- ls /data/torrents /data/media

# HTTPRoutes accepted
kubectl-homelab get httproute -n arr-stack

# NetworkPolicy applied
kubectl-homelab -n arr-stack get ciliumnetworkpolicy

# API keys secret exists
kubectl-homelab -n arr-stack get secret arr-api-keys

# Homepage widgets showing data
curl -sk https://portal.k8s.rommelporras.com | head -5
```

---

## Rollback

```bash
# Delete namespace (cascades all namespaced resources: pods, PVCs, services, secrets, HTTPRoutes, network policies)
kubectl-homelab delete ns arr-stack

# Delete cluster-scoped PV
kubectl-homelab delete pv arr-data-nfs

# NFS media data at /export/Kubernetes/Media persists on NAS (Retain policy)
# Longhorn config PVCs are deleted with the namespace
```
