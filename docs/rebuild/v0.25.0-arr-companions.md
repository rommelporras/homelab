# v0.25.0 — ARR Companions

> **Release:** v0.25.0
> **Phase:** 4.26 (ARR Companions)
> **Goal:** Deploy 7 companion apps for the ARR media stack — media requests, quality sync, archive extraction, metrics, library transcoding, AI recommendations, and Cloudflare bypass
> **Prerequisite:** [v0.24.0-intel-qsv.md](v0.24.0-intel-qsv.md) completed, ARR core stack + QSV running

---

## Overview

Adds companion apps to the existing ARR media stack in `arr-stack` namespace. All apps integrate with the core stack (Prowlarr, Sonarr, Radarr, qBittorrent, Jellyfin, Bazarr) deployed in Phase 4.25/4.25b.

```
arr-stack namespace
├── Core (Phase 4.25/4.25b)
│   ├── Prowlarr (indexer manager)
│   ├── Sonarr (TV) + Radarr (movies)
│   ├── qBittorrent (download client)
│   ├── Jellyfin (media server, QSV)
│   └── Bazarr (subtitles)
│
├── Companions (Phase 4.26 — this release)
│   ├── Seerr (media requests + discovery, replaces Overseerr)
│   ├── Configarr (TRaSH Guide quality sync, CronJob)
│   ├── Unpackerr (RAR extraction daemon)
│   ├── Scraparr (Prometheus metrics exporter)
│   ├── Tdarr (library transcoding, QSV internal node)
│   ├── Recommendarr (AI recommendations via Ollama)
│   └── Byparr (Cloudflare bypass for Prowlarr)
│
└── Shared Resources
    ├── arr-data PVC (NFS — /export/Kubernetes/Media)
    ├── arr-api-keys Secret (API keys from 1Password)
    └── CiliumNetworkPolicy (egress to NFS + ai namespace)
```

**Deployment order:** Seerr → Configarr → Unpackerr → Scraparr → Tdarr → Recommendarr → Byparr → NetworkPolicy → Dashboards → Alerts → NFS hardening → Homepage.

---

## Step 1: Update Shared Secret

Add `tdarr-api-key` to the `ARR Stack` item in 1Password, then run the updated apply script:

```bash
# Sign in to 1Password
eval $(op signin)

# Run the updated script (now includes TDARR_API_KEY)
./scripts/apply-arr-secrets.sh

# Verify
kubectl-homelab get secret arr-api-keys -n arr-stack -o jsonpath='{.data}' | jq 'keys'
# Expect: BAZARR_API_KEY, PROWLARR_API_KEY, RADARR_API_KEY, SONARR_API_KEY, TDARR_API_KEY
```

---

## Step 2: Deploy Seerr

```bash
kubectl-homelab apply -f manifests/arr-stack/seerr/

# Verify
kubectl-homelab -n arr-stack get pods -l app=seerr
curl -sI https://seerr.k8s.rommelporras.com | head -1
# Expect: HTTP/2 200
```

### Configure Seerr via UI

Navigate to https://seerr.k8s.rommelporras.com:

1. **Media server:** Select Jellyfin, authenticate with admin account
2. **Sonarr:** Add connection — URL: `http://sonarr.arr-stack.svc:8989`, API key, quality: WEB-1080p, Automatic Search: ON
3. **Radarr:** Add connection — URL: `http://radarr.arr-stack.svc:7878`, API key, quality: HD Bluray + WEB, Minimum Availability: Released, Automatic Search: ON
4. **TMDB:** Linked automatically for discovery/metadata

---

## Step 3: Deploy Configarr

```bash
kubectl-homelab apply -f manifests/arr-stack/configarr/

# Trigger manual test run
kubectl-homelab create job --from=cronjob/configarr configarr-test -n arr-stack
kubectl-homelab logs -n arr-stack job/configarr-test --follow
# Expect: "Finished" with synced profile names

# Verify quality profiles in Sonarr/Radarr UI — TRaSH profiles should appear
```

Configarr runs daily at 3 AM (node timezone: Asia/Manila). No web UI.

---

## Step 4: Deploy Unpackerr

```bash
kubectl-homelab apply -f manifests/arr-stack/unpackerr/deployment.yaml

# Verify connection to Sonarr/Radarr
kubectl-homelab logs -n arr-stack deploy/unpackerr | head -20
# Expect: "Sonarr: 1 server" and "Radarr: 1 server"
```

No web UI, no Service, no HTTPRoute. Daemon polls Sonarr/Radarr queues every 2 minutes.

---

## Step 5: Deploy Scraparr

```bash
kubectl-homelab apply -f manifests/arr-stack/scraparr/

# Verify metrics endpoint
kubectl-homelab -n arr-stack exec deploy/scraparr -- wget -qO- http://localhost:7100/metrics | head -5

# Verify Prometheus target
# Check in Prometheus UI: up{job="scraparr"} == 1
```

---

## Step 6: Deploy Tdarr

```bash
kubectl-homelab apply -f manifests/arr-stack/tdarr/

# Verify (startup takes ~2 min for server + internal node)
kubectl-homelab -n arr-stack get pods -l app=tdarr
curl -sI https://tdarr.k8s.rommelporras.com | head -1
# Expect: HTTP/2 200
```

### Configure Tdarr via UI

Navigate to https://tdarr.k8s.rommelporras.com:

1. **Library:** Create "Media" — source: `/media/media`, transcode cache: `/temp`, output: `/media/media` (in-place)
2. **Folder Watch:** OFF (NFS doesn't support inotify), Scan on Start: ON, Run hourly Scan: ON
3. **Classic Plugin Stack:** Migz Remove Image Formats → Lmg1 Reorder Streams → Boosh-Transcode Using QSV GPU & FFMPEG (hevc_qsv, mkv, target_bitrate_modifier 0.8, slow preset, reconvert_hevc=false) → New File Size Check
4. **Remove** default CPU and Nvidia GPU transcode plugins
5. **Schedule:** 2AM-8AM daily (off-hours to reduce GPU contention with Jellyfin)
6. **Health Check:** Thorough (FFmpeg frame-by-frame)
7. **InternalNode:** Transcode GPU=1, Health Check GPU=1, CPU workers=0
8. **Auto accept successful transcodes:** enabled

---

## Step 7: Deploy Recommendarr

```bash
kubectl-homelab apply -f manifests/arr-stack/recommendarr/

# Verify
curl -sI https://recommendarr.k8s.rommelporras.com | head -1
# Expect: HTTP/2 200
```

### Configure Recommendarr via UI

Navigate to https://recommendarr.k8s.rommelporras.com (default: admin / 1234):

1. **Change password** on first login
2. **Jellyfin:** `http://jellyfin.arr-stack.svc:8096` + API key
3. **Sonarr:** `http://sonarr.arr-stack.svc:8989` + API key
4. **Radarr:** `http://radarr.arr-stack.svc:7878` + API key
5. **Ollama:** `http://ollama.ai.svc.cluster.local:11434/v1` (OpenAI-compatible), model: `qwen2.5:3b`

---

## Step 8: Deploy Byparr

```bash
kubectl-homelab apply -f manifests/arr-stack/byparr/

# Verify health
kubectl-homelab -n arr-stack exec deploy/byparr -- wget -qO- http://localhost:8191/health
# Expect: {"msg":"Byparr is working!","version":"..."}
```

### Configure Prowlarr FlareSolverr Proxy

In Prowlarr UI (Settings > Indexers > Add > FlareSolverr):
1. **Host:** `http://byparr.arr-stack.svc:8191`
2. **Request Timeout:** 60 seconds
3. **Tag:** `flaresolverr`

### Add Prowlarr Indexers

Add the following indexers (Settings > Indexers > Add):

| Indexer | Type | Byparr Tag | Notes |
|---------|------|------------|-------|
| EZTV | Public (TV) | — | No account needed |
| Nyaa.si | Public (Anime) | — | No account needed |
| YTS | Public (Movies) | — | No account needed, lower quality fallback |
| Bitsearch | Public (General) | — | No account needed, no Cloudflare |
| 1337x | Public (General) | `flaresolverr` | Best general-purpose, needs Byparr |

---

## Step 9: Update NetworkPolicy

```bash
# arr-stack egress to ai namespace (Recommendarr → Ollama)
kubectl-homelab apply -f manifests/arr-stack/networkpolicy.yaml

# ai namespace ingress from arr-stack
kubectl-homelab apply -f manifests/ai/networkpolicy.yaml

# Verify Recommendarr can reach Ollama
kubectl-homelab exec -n arr-stack deploy/recommendarr -- wget -qO- http://ollama.ai.svc.cluster.local:11434/api/version
```

---

## Step 10: Apply Dashboards and Alerts

```bash
# Scraparr ARR metrics dashboard
kubectl-homelab apply -f manifests/monitoring/scraparr-dashboard-configmap.yaml

# Network throughput dashboard
kubectl-homelab apply -f manifests/monitoring/network-dashboard-configmap.yaml

# Updated ARR Stack dashboard (companion pod status panels)
kubectl-homelab apply -f manifests/monitoring/arr-stack-dashboard-configmap.yaml

# ARR alert rules
kubectl-homelab apply -f manifests/monitoring/arr-alerts.yaml

# Verify dashboards appear in Grafana (sidecar reloads within 60s)
# Verify alerts loaded: kubectl-homelab -n monitoring exec deploy/prometheus-kube-prometheus-prometheus -- promtool check rules /etc/prometheus/rules/
```

---

## Step 11: Harden NFS Mounts

```bash
# Jellyfin NFS mount → readOnly
kubectl-homelab apply -f manifests/arr-stack/jellyfin/deployment.yaml

# Verify Jellyfin still plays media
curl -sI https://jellyfin.k8s.rommelporras.com/health
```

---

## Step 12: Update Homepage

```bash
# Homepage uses kustomize
kubectl-homelab apply -k manifests/home/homepage/

# Patch homepage-secrets with Seerr API key
eval $(op signin)
kubectl-homelab -n home get secret homepage-secrets -o json | \
  jq --arg key "$(op read 'op://Kubernetes/Homepage/seerr-api-key')" \
  '.data["HOMEPAGE_VAR_SEERR_API_KEY"] = ($key | @base64)' | \
  kubectl-homelab apply -f -

# Verify Homepage loads with new layout
curl -sI https://portal.k8s.rommelporras.com | head -1
```

---

## Step 13: Configure Import Lists & Quality Settings (UI-Only)

### Radarr Quality Tuning (Settings > Profiles)

- **Minimum Custom Format Score:** -10000 (allows YTS fallback — scored -10000 by TRaSH CFs)
- **Upgrade Until Custom Format Score:** 10000 (auto-upgrades to better releases when available)

### Sonarr Quality Tuning (Settings > Profiles)

- **Minimum Custom Format Score:** -10000 (allows x265 anime from Nyaa.si — TRaSH `x265 (HD)` CF scores -10000)
- **Upgrade Until Custom Format Score:** 10000

### qBittorrent Settings (Options > Downloads/Connection)

- **Max active downloads:** 5
- **Max active torrents:** 10
- **Slow torrent thresholds:** 10 KiB/s download rate, 600s inactivity timeout
- **Seeding limits:** Ratio 0, time 1440 min (24h), then auto-remove torrent

### Radarr Import Lists (Settings > Lists)

1. **TMDB Popular:** Min vote avg 6, min votes 100, quality: HD Bluray + WEB, search on add: off
2. **Trakt Popular:** Rating 60-100, limit 25, quality: HD Bluray + WEB, search on add: off (OAuth)

### Sonarr Import Lists (Settings > Import Lists)

1. **Trakt Popular Shows:** Rating 60-100, limit 25, quality: WEB-1080p, monitor: First Season, search on add: off (OAuth)
2. **AniList:** Import Watching + Planning + Finished, quality: WEB-1080p, series type: Anime, monitor: First Season

### User Accounts (Optional)

Create additional Jellyfin users for household members:
- **Jellyfin:** Create user — media playback + transcoding enabled, admin/deletion/downloads disabled
- **Seerr:** Jellyfin auth auto-syncs users — set Auto-Approve Movies + Series permissions as needed

---

## Step 14: Configure Discord Notifications

1. Create `#arr` channel in Discord (under Notification group)
2. Create webhook, save URL to 1Password (`op://Kubernetes/ARR Stack/discord-webhook-url`)
3. **Sonarr** (Settings > Connect > Discord): Add webhook URL, enable: On Grab, File Import, File Upgrade, Import Complete, Health Issue, Health Restored, Manual Interaction Required
4. **Radarr:** Same configuration as Sonarr

---

## Verification

```bash
# All companion pods running
kubectl-homelab -n arr-stack get pods

# Expected pods (companions only):
# seerr-*          1/1 Running
# configarr-*      (CronJob — check via: kubectl get cronjob -n arr-stack)
# unpackerr-*      1/1 Running
# scraparr-*       1/1 Running
# tdarr-*          1/1 Running
# recommendarr-*   1/1 Running
# byparr-*         1/1 Running

# HTTPRoutes
kubectl-homelab get httproute -n arr-stack
# Expect: seerr, tdarr, recommendarr (+ existing prowlarr, sonarr, radarr, qbittorrent, jellyfin, bazarr)

# Scraparr metrics
kubectl-homelab -n arr-stack exec deploy/scraparr -- wget -qO- http://localhost:7100/metrics | grep -c "^sonarr_\|^radarr_\|^prowlarr_"

# Recommendarr → Ollama connectivity
kubectl-homelab exec -n arr-stack deploy/recommendarr -- wget -qO- http://ollama.ai.svc.cluster.local:11434/api/version
```
