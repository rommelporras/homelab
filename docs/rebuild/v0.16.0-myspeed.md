# v0.16.0 — MySpeed Internet Speed Tracker

> **Release:** v0.16.0
> **Phase:** 4.20 (MySpeed Migration)
> **Goal:** Migrate MySpeed from Proxmox LXC to Kubernetes
> **Prerequisite:** [v0.6.0-home-services.md](v0.6.0-home-services.md) completed (home namespace exists)

---

## Overview

Migrates the MySpeed internet speed test tracker from Proxmox LXC (10.10.30.6) to the Kubernetes cluster. MySpeed runs speed tests on a schedule, logs results to SQLite, and posts to Discord.

- **Image:** `germannewsmaker/myspeed:1.0.9` (Docker Hub)
- **Port:** 5216/TCP
- **Storage:** SQLite database on Longhorn PVC (1Gi)
- **Namespace:** `home` (alongside AdGuard + Homepage)
- **Timezone:** `Asia/Manila` (via `TZ` env var)
- **Strategy:** `Recreate` (required — RWO PVC can only attach to one pod at a time)

---

## Step 1: Apply Manifests

```bash
kubectl-homelab apply -f manifests/home/myspeed/
```

### Manifests Structure

```
manifests/home/myspeed/
├── deployment.yaml     # v1.0.9, security context, named ports
├── pvc.yaml            # 1Gi Longhorn RWO for SQLite
├── service.yaml        # ClusterIP (port 5216)
└── httproute.yaml      # myspeed.k8s.rommelporras.com
```

### Security Context

Pod-level:
- `fsGroup: 1000` — PVC files writable by container
- `seccompProfile: RuntimeDefault` — restrict dangerous syscalls

Container-level:
- `allowPrivilegeEscalation: false`
- `capabilities.drop: ALL`

> **Note:** `runAsNonRoot` is NOT compatible with this image — it needs root to create the data folder. `readOnlyRootFilesystem` also breaks the app.

---

## Step 2: Verify

```bash
# Check pod is running
kubectl-homelab get pods -n home -l app=myspeed

# Check PVC is bound
kubectl-homelab get pvc -n home myspeed-data

# Check HTTPRoute
kubectl-homelab get httproute -n home myspeed

# Test web UI
curl -I https://myspeed.k8s.rommelporras.com
```

---

## Step 3: Configure MySpeed

Access `https://myspeed.k8s.rommelporras.com` and configure:

1. **Speed test interval:** Set to desired frequency (e.g., every 1-3 hours)
2. **Discord webhook:** Configure integration to post results to `#status` channel (webhook URL stored in MySpeed's built-in settings, not K8s manifests)

---

## Step 4: Update Homepage Widget

The Homepage `services.yaml` should point to the K8s URL:

```yaml
- Speed Test:
    icon: myspeed.png
    href: https://myspeed.k8s.rommelporras.com
    description: Internet Speed History
    statusStyle: dot
    widget:
      type: myspeed
      url: https://myspeed.k8s.rommelporras.com
```

Apply via Kustomize (NOT `kubectl apply -f`):

```bash
kubectl-homelab apply -k manifests/home/homepage/
```

---

## Step 5: Update Uptime Kuma

Add or update monitor for `https://myspeed.k8s.rommelporras.com` in Uptime Kuma.

---

## Verification Checklist

- [ ] MySpeed pod running: `kubectl-homelab get pods -n home -l app=myspeed`
- [ ] PVC bound: `kubectl-homelab get pvc -n home myspeed-data`
- [ ] Web UI loads: `https://myspeed.k8s.rommelporras.com`
- [ ] Speed tests executing (check UI for results)
- [ ] Discord webhook posting to `#status`
- [ ] Homepage widget showing speed data
- [ ] Uptime Kuma monitoring active

---

## Resource Usage

| Metric | Value |
|--------|-------|
| Idle memory | ~43Mi |
| Peak memory (during speed test) | ~78Mi |
| Memory limit | 256Mi (3.3x headroom) |
| CPU requests/limits | 100m / 500m |
| Storage | 1Gi Longhorn RWO |

---

## Troubleshooting

### Image pull error (403 Forbidden)

The image is on **Docker Hub** (`germannewsmaker/myspeed`), NOT GitHub Container Registry. If using `ghcr.io/gnmyt/myspeed`, you'll get 403.

### Permission denied on data folder

If you see "Could not create the data folder", the `runAsUser` is set and the image can't write. Remove `runAsUser`, `runAsGroup`, and `runAsNonRoot` from the security context.

### Pod Security warning

The `restricted` PSS warning about `runAsNonRoot` is expected — it's a **warn** not **enforce**. The pod still runs.

### Homepage shows wrong data after config change

Always use `kubectl apply -k` for Homepage, not `kubectl apply -f`. Using `-f` overwrites the imperative secret with placeholder values.

---

## Rollback

```bash
kubectl-homelab delete -f manifests/home/myspeed/
# PVC is retained — delete manually if no longer needed:
# kubectl-homelab delete pvc -n home myspeed-data
```

---

## Next Steps

- [v0.17.0-ghost-analytics.md](v0.17.0-ghost-analytics.md) — Ghost web analytics with Tinybird
