# v0.14.0 — Invoicetron Migration

> **Release:** v0.14.0
> **Phase:** 4.9
> **Goal:** Migrate stateful application with database from Docker Compose to Kubernetes
> **Prerequisite:** [v0.13.0-uptime-kuma.md](v0.13.0-uptime-kuma.md) completed

---

## Overview

This release migrates Invoicetron (Next.js 16 + Bun 1.3.4 + PostgreSQL 18 + Prisma 7.2.0 + Better Auth 1.4.7) from Docker Compose on a DMZ VM to Kubernetes. Two environments (dev + prod) with GitLab CI/CD pipeline, Cloudflare Tunnel public access, and Cloudflare Access email OTP protection.

**Key difference from Ghost/Portfolio:** Invoicetron is a private GitLab project. The container registry inherits project visibility, so `imagePullSecrets` are required in every namespace.

**Versions:**
- Invoicetron: Next.js 16.1.0 (Bun 1.3.4 runtime)
- PostgreSQL: 18-alpine

**Architecture:**
```
┌─────────────────────────────────────────────────────────────────┐
│            invoicetron-prod namespace (same for -dev)            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  PostgreSQL 18         Invoicetron App                           │
│  StatefulSet    ◄────  Deployment (1 replica)                    │
│  (10Gi Longhorn) SQL   Next.js 16 + Bun                         │
│                                                                  │
│  Daily:                On deploy:                                │
│  pg_dump CronJob       Prisma Migrate Job                       │
│  → Longhorn PVC                                                 │
│                                                                  │
│  Secrets: database-url, better-auth-secret (1Password)          │
│  Registry: gitlab-registry imagePullSecret (deploy token)       │
└─────────────────────────────────────────────────────────────────┘
```

**Access:**

| Environment | Internal URL | Public URL |
|-------------|-------------|------------|
| Dev | invoicetron.dev.k8s.rommelporras.com | — |
| Prod | invoicetron.k8s.rommelporras.com | invoicetron.rommelporras.com (Cloudflare) |

---

## Step 1: Create Namespaces

```bash
kubectl-homelab create namespace invoicetron-dev
kubectl-homelab label namespace invoicetron-dev pod-security.kubernetes.io/enforce=baseline

kubectl-homelab create namespace invoicetron-prod
kubectl-homelab label namespace invoicetron-prod pod-security.kubernetes.io/enforce=baseline
```

Verify:
```bash
kubectl-homelab get namespace invoicetron-dev invoicetron-prod --show-labels
```

---

## Step 2: Create Secrets from 1Password

### 2.1 Create 1Password Items

Create these items in the `Kubernetes` vault:

| Item | Fields |
|------|--------|
| Invoicetron Dev | `postgres-password`, `better-auth-secret`, `database-url` |
| Invoicetron Prod | `postgres-password`, `better-auth-secret`, `database-url` |

Generate passwords with `openssl rand -hex 20` (hex-only — special characters break Prisma URL parsing).

The `database-url` format:
```
postgresql://invoicetron:<postgres-password>@invoicetron-db:5432/invoicetron
```

### 2.2 Create Kubernetes Secrets

```bash
eval $(op signin)

# Dev secrets
kubectl-homelab create secret generic invoicetron-db \
  --namespace invoicetron-dev \
  --from-literal=postgres-password="$(op read 'op://Kubernetes/Invoicetron Dev/postgres-password')"

kubectl-homelab create secret generic invoicetron-app \
  --namespace invoicetron-dev \
  --from-literal=database-url="$(op read 'op://Kubernetes/Invoicetron Dev/database-url')" \
  --from-literal=better-auth-secret="$(op read 'op://Kubernetes/Invoicetron Dev/better-auth-secret')"

# Prod secrets
kubectl-homelab create secret generic invoicetron-db \
  --namespace invoicetron-prod \
  --from-literal=postgres-password="$(op read 'op://Kubernetes/Invoicetron Prod/postgres-password')"

kubectl-homelab create secret generic invoicetron-app \
  --namespace invoicetron-prod \
  --from-literal=database-url="$(op read 'op://Kubernetes/Invoicetron Prod/database-url')" \
  --from-literal=better-auth-secret="$(op read 'op://Kubernetes/Invoicetron Prod/better-auth-secret')"
```

> **Important:** Verify secrets after creation. If `op read` returns empty (session expired), secrets will be empty and auth will fail silently.

### 2.3 Create Registry Pull Secret

Invoicetron is a private GitLab project. Create a deploy token in GitLab (Settings → Repository → Deploy tokens) with `read_registry` scope, then create the imagePullSecret in each namespace:

```bash
kubectl-homelab create secret docker-registry gitlab-registry \
  --namespace invoicetron-dev \
  --docker-server=registry.k8s.rommelporras.com \
  --docker-username="gitlab+deploy-token-1" \
  --docker-password="$(op read 'op://Kubernetes/Invoicetron Deploy Token/password')"

kubectl-homelab create secret docker-registry gitlab-registry \
  --namespace invoicetron-prod \
  --docker-server=registry.k8s.rommelporras.com \
  --docker-username="gitlab+deploy-token-1" \
  --docker-password="$(op read 'op://Kubernetes/Invoicetron Deploy Token/password')"
```

---

## Step 3: Deploy PostgreSQL

```bash
kubectl-homelab apply -f manifests/invoicetron/postgresql.yaml -n invoicetron-dev
kubectl-homelab apply -f manifests/invoicetron/postgresql.yaml -n invoicetron-prod
```

**manifests/invoicetron/postgresql.yaml** contains:
- StatefulSet with `postgres:18-alpine`, 10Gi Longhorn PVC via volumeClaimTemplates
- Headless Service (`clusterIP: None`) for stable StatefulSet DNS
- Password via `secretKeyRef` to `invoicetron-db/postgres-password`

> **Important:** Mount at `/var/lib/postgresql` (parent), not `/var/lib/postgresql/data`. PostgreSQL 18+ creates the `data` subdirectory itself. Wrong mount path causes CrashLoopBackOff.

Verify:
```bash
kubectl-homelab rollout status statefulset/invoicetron-db -n invoicetron-dev --timeout=120s
kubectl-homelab rollout status statefulset/invoicetron-db -n invoicetron-prod --timeout=120s
kubectl-homelab get pvc -n invoicetron-dev
kubectl-homelab get pvc -n invoicetron-prod
```

---

## Step 4: Deploy Invoicetron App

```bash
kubectl-homelab apply -f manifests/invoicetron/deployment.yaml -n invoicetron-dev
kubectl-homelab apply -f manifests/invoicetron/deployment.yaml -n invoicetron-prod
```

**manifests/invoicetron/deployment.yaml** contains:
- Deployment with init container (`wait-for-db` using busybox nc)
- `imagePullSecrets: gitlab-registry` (private project)
- Security context: `runAsNonRoot: true`, `runAsUser: 1001`, `capabilities.drop: ALL`
- Env vars via `secretKeyRef`: `DATABASE_URL`, `BETTER_AUTH_SECRET`
- `ADDITIONAL_TRUSTED_ORIGINS` for multi-URL auth (internal + public URLs)
- Liveness/readiness probes on `/api/health`
- ClusterIP Service on port 3000

> **Warning:** The manifest has a placeholder image. CI/CD sets the actual image via `kubectl set image`. Do NOT `kubectl apply` on a running deployment — it reverts the image to the placeholder.

Verify:
```bash
kubectl-homelab get pods -n invoicetron-dev
kubectl-homelab get pods -n invoicetron-prod
```

---

## Step 5: Deploy RBAC for CI/CD

```bash
kubectl-homelab apply -f manifests/invoicetron/rbac.yaml -n invoicetron-dev
kubectl-homelab apply -f manifests/invoicetron/rbac.yaml -n invoicetron-prod
```

**manifests/invoicetron/rbac.yaml** contains:
- ServiceAccount `gitlab-deploy`
- Role with permissions: Deployments (get/list/watch/patch/update), ReplicaSets (get/list/watch), Pods (get/list/watch), Jobs (get/list/watch/create/delete)
- RoleBinding and service account token Secret

Extract tokens for GitLab CI/CD variables:
```bash
# Dev token
kubectl-homelab get secret gitlab-deploy-token -n invoicetron-dev \
  -o jsonpath='{.data.token}' | base64 -d

# Prod token
kubectl-homelab get secret gitlab-deploy-token -n invoicetron-prod \
  -o jsonpath='{.data.token}' | base64 -d
```

---

## Step 6: Create HTTPRoutes

```bash
kubectl-homelab apply -f manifests/gateway/routes/invoicetron-dev.yaml
kubectl-homelab apply -f manifests/gateway/routes/invoicetron-prod.yaml
```

- **invoicetron-dev.yaml:** Routes `invoicetron.dev.k8s.rommelporras.com` → invoicetron:3000 (sectionName: `https-dev`)
- **invoicetron-prod.yaml:** Routes `invoicetron.k8s.rommelporras.com` → invoicetron:3000 (sectionName: `https`)

DNS is handled by existing AdGuard wildcards — no new rewrites needed.

Verify:
```bash
kubectl-homelab get httproute -A | grep invoicetron
```

---

## Step 7: Configure GitLab CI/CD

### 7.1 GitLab Project Setup

The invoicetron project lives at `gitlab.k8s.rommelporras.com/0xwsh/invoicetron` (private), push-mirrored to GitHub.

### 7.2 CI/CD Variables

In GitLab → Settings → CI/CD → Variables, create environment-scoped variables:

| Variable | Environment | Source |
|----------|-------------|--------|
| `KUBE_TOKEN` | development | From Step 5 (invoicetron-dev token) |
| `KUBE_TOKEN` | production | From Step 5 (invoicetron-prod token) |
| `KUBE_API_URL` | (all) | `https://api.k8s.rommelporras.com:6443` |

### 7.3 Pipeline Overview

```
develop → validate → test → build:dev → deploy:dev → verify:dev
main    → validate → test → build:prod → deploy:prod → verify:prod
```

- **validate:** type-check (tsc), lint, security-audit
- **test:** unit tests (vitest on node:22-slim)
- **build:** per-environment Docker image (NEXT_PUBLIC_APP_URL as build-arg)
- **deploy:** Prisma migration Job + `kubectl set image`
- **verify:** curl health check

> **Key:** NEXT_PUBLIC_APP_URL is baked at build time. Each environment builds its own image with the correct URL. You cannot promote the same artifact across environments.

---

## Step 8: Deploy Backup CronJob (Prod Only)

```bash
kubectl-homelab apply -f manifests/invoicetron/backup-cronjob.yaml -n invoicetron-prod
```

**manifests/invoicetron/backup-cronjob.yaml** contains:
- CronJob running daily at 3 AM
- `pg_dump` to `/backups/invoicetron_<timestamp>.sql`
- 7-day retention (deletes older backups)
- 2Gi Longhorn PVC for backup storage
- Password via `secretKeyRef`

Test manually:
```bash
kubectl-homelab create job --from=cronjob/invoicetron-db-backup \
  invoicetron-db-backup-test -n invoicetron-prod
kubectl-homelab logs -n invoicetron-prod job/invoicetron-db-backup-test
# Should show: Backup completed: /backups/invoicetron_<timestamp>.sql
```

---

## Step 9: Migrate Data

### 9.1 Generate Database Dump

From local development environment (or wherever the latest data lives):
```bash
pg_dump -Fc -U invoicetron -d invoicetron > invoicetron-full.dump
```

### 9.2 Restore to K8s PostgreSQL

```bash
for NS in invoicetron-dev invoicetron-prod; do
  kubectl-homelab cp invoicetron-full.dump $NS/invoicetron-db-0:/tmp/invoicetron-full.dump
  kubectl-homelab exec -n $NS invoicetron-db-0 -- \
    pg_restore --username=invoicetron --dbname=invoicetron \
      --clean --if-exists --no-owner --no-privileges --verbose \
      /tmp/invoicetron-full.dump
done
```

> **Note:** `pg_restore` shows errors like "does not exist" for `--clean` on first restore. These are safe to ignore — it tries to drop objects that don't exist yet.

### 9.3 Verify Data

```bash
for NS in invoicetron-dev invoicetron-prod; do
  echo "=== $NS ==="
  kubectl-homelab exec -n $NS invoicetron-db-0 -- \
    psql -U invoicetron -d invoicetron -c "SELECT count(*) FROM invoices;"
done
```

---

## Step 10: Configure Cloudflare Tunnel

### 10.1 Add Tunnel Route

1. Cloudflare Zero Trust → Networks → Tunnels → homelab → Public Hostname
2. Add public hostname:
   - Subdomain: `invoicetron`
   - Domain: `rommelporras.com`
   - Type: HTTP
   - URL: `invoicetron.invoicetron-prod.svc.cluster.local:3000`

### 10.2 Update cloudflared Network Policy

Already included in `manifests/cloudflare/networkpolicy.yaml`:

```yaml
# Invoicetron namespace (invoicetron.rommelporras.com)
- toEndpoints:
  - matchLabels:
      k8s:io.kubernetes.pod.namespace: invoicetron-prod
  toPorts:
  - ports:
    - port: "3000"
      protocol: TCP
```

> **Critical:** The namespace must be `invoicetron-prod` (exact match), not `invoicetron`. CiliumNetworkPolicy uses exact namespace names. A mismatch causes 502 through Cloudflare Tunnel.

If not already applied:
```bash
kubectl-homelab apply -f manifests/cloudflare/networkpolicy.yaml
```

### 10.3 Configure Cloudflare Access

1. Cloudflare Zero Trust → Access → Applications → Add application → Self-hosted
2. Application name: **Invoicetron**
3. Application domain: `invoicetron.rommelporras.com`
4. Attach the **Allow Admin** policy (reuse existing — email OTP with your addresses)
5. Session duration: 24 hours

Verify:
```bash
# Should return 302 to Cloudflare Access login
curl -sI https://invoicetron.rommelporras.com | head -5
```

---

## Step 11: Set ADDITIONAL_TRUSTED_ORIGINS (Prod Only)

Better Auth validates request origins against the build-time URL. Since prod is accessed via both `invoicetron.rommelporras.com` (public) and `invoicetron.k8s.rommelporras.com` (internal), the internal URL must be added as a trusted origin:

```bash
kubectl-homelab set env deployment/invoicetron -n invoicetron-prod \
  ADDITIONAL_TRUSTED_ORIGINS="https://invoicetron.k8s.rommelporras.com"
```

> **Note:** Use `kubectl set env`, not `kubectl apply`. Applying the manifest reverts the CI/CD image to the placeholder.

Dev does not need this because the build-time URL matches the access URL.

---

## 1Password Items

| Item | Fields | Vault |
|------|--------|-------|
| Invoicetron Dev | `postgres-password`, `better-auth-secret`, `database-url` | Kubernetes |
| Invoicetron Prod | `postgres-password`, `better-auth-secret`, `database-url` | Kubernetes |

---

## Verification Checklist

- [ ] Namespaces `invoicetron-dev` and `invoicetron-prod` exist with baseline PSS
- [ ] PostgreSQL StatefulSet running in both namespaces (invoicetron-db-0 ready)
- [ ] PostgreSQL PVCs bound and healthy in Longhorn
- [ ] Invoicetron Deployment running in both namespaces
- [ ] Secrets created (`invoicetron-db`, `invoicetron-app`, `gitlab-registry`) in both namespaces
- [ ] HTTPRoutes resolving: invoicetron.k8s.rommelporras.com, invoicetron.dev.k8s.rommelporras.com
- [ ] GitLab CI/CD pipeline passes all stages
- [ ] Login works on all 3 URLs (public, internal prod, internal dev)
- [ ] Data migrated and verified
- [ ] Cloudflare Tunnel routing invoicetron.rommelporras.com to prod
- [ ] Cloudflare Access email OTP configured
- [ ] Backup CronJob tested manually
- [ ] Push mirror to GitHub working

---

## Rollback

```bash
# 1. Quick rollback — restart old VM
ssh wawashi@reverse-mountain "cd /home/wawashi/invoicetron && docker compose up -d"
# Revert Cloudflare Tunnel route to VM IP in dashboard

# 2. App rollback only (DB is fine)
kubectl-homelab rollout undo deployment/invoicetron -n invoicetron-prod

# 3. Restore from backup
kubectl-homelab cp backup.sql invoicetron-prod/invoicetron-db-0:/tmp/
kubectl-homelab exec -n invoicetron-prod invoicetron-db-0 -- \
  psql -U invoicetron -d invoicetron -f /tmp/backup.sql

# 4. Full teardown
kubectl-homelab delete namespace invoicetron-dev
kubectl-homelab delete namespace invoicetron-prod
# Remove Cloudflare Tunnel route and Access application manually
```

---

## Files Reference

| File | Purpose |
|------|---------|
| manifests/invoicetron/deployment.yaml | App Deployment + ClusterIP Service |
| manifests/invoicetron/postgresql.yaml | PostgreSQL StatefulSet + headless Service |
| manifests/invoicetron/rbac.yaml | ServiceAccount, Role, RoleBinding for CI/CD |
| manifests/invoicetron/secret.yaml | Placeholder (1Password imperative) |
| manifests/invoicetron/backup-cronjob.yaml | Daily pg_dump CronJob + 2Gi PVC |
| manifests/gateway/routes/invoicetron-dev.yaml | HTTPRoute for dev (internal) |
| manifests/gateway/routes/invoicetron-prod.yaml | HTTPRoute for prod (internal) |
| manifests/cloudflare/networkpolicy.yaml | Updated with invoicetron-prod egress |

---

## Key Learnings

| Topic | Lesson |
|-------|--------|
| Private registry | Private GitLab projects need `imagePullSecrets` (deploy token with `read_registry` scope) |
| envFrom vs env | K8s secret keys use hyphens (`database-url`); tools expect underscores (`DATABASE_URL`). Use explicit `env` with `valueFrom.secretKeyRef` |
| PostgreSQL 18 mount | Mount at `/var/lib/postgresql` (parent), not `/var/lib/postgresql/data` |
| Hex-only passwords | Passwords with `/` break Prisma URL parsing. Use `openssl rand -hex 20` |
| POSTGRES_PASSWORD timing | Only read on first init (empty data dir). Changing secret requires `ALTER USER` inside the pod |
| kubectl apply vs set image | Manifest has placeholder image. CI/CD uses `kubectl set image`. Applying manifest reverts it |
| CiliumNetworkPolicy namespaces | Must use exact namespace name (`invoicetron-prod`, not `invoicetron`) |
| Better Auth baseURL | Don't hardcode `NEXT_PUBLIC_APP_URL` in auth client. Let it use `window.location.origin` for multi-URL support |
| ADDITIONAL_TRUSTED_ORIGINS | Server-side env var for Better Auth to accept requests from non-canonical URLs |
| 1Password CLI sessions | `op read` returns empty if session expired. Always `eval $(op signin)` first |
