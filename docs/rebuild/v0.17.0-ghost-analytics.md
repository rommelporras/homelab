# v0.17.0 — Ghost Web Analytics (Tinybird)

> **Release:** v0.17.0
> **Phase:** 4.12.1 (Ghost Web Analytics)
> **Goal:** Add native web analytics to Ghost blog via Tinybird
> **Prerequisite:** [v0.11.0-ghost-blog.md](v0.11.0-ghost-blog.md) completed (Ghost prod running)

---

## Overview

Adds cookie-free, privacy-preserving web analytics to Ghost blog. Uses Ghost's native Tinybird integration with a TrafficAnalytics proxy that enriches page hit data before forwarding to Tinybird's event ingestion API.

- **Proxy Image:** `ghost/traffic-analytics:1.0.72`
- **Port:** 3000/TCP
- **Memory:** 128Mi request / 256Mi limit (container uses ~145MB idle)
- **Namespace:** `ghost-prod` (alongside Ghost + MySQL)
- **Public URL:** `blog-api.rommelporras.com` (Cloudflare Tunnel)

---

## Step 1: Create Tinybird Account

1. Sign up at [tinybird.co](https://www.tinybird.co)
2. Select **US-East** region (AWS, no Asia-Pacific available)
3. Create a workspace for Ghost analytics

---

## Step 2: Deploy Ghost Analytics Template

```bash
# Install Tinybird CLI
pip install tinybird-cli

# Authenticate
tb auth --token <your-admin-token>

# Clone and deploy Ghost template
git clone https://github.com/tinybirdco/ghost-tracker.git /tmp/ghost-tracker
cd /tmp/ghost-tracker
tb push
```

This creates the required datasources and API endpoints in Tinybird.

---

## Step 3: Create 1Password Item

Create item "Ghost Tinybird" in the Kubernetes vault with fields:

| Field | Value | Source |
|-------|-------|--------|
| workspace-id | Tinybird workspace ID | Tinybird dashboard → Settings |
| admin-token | Tinybird admin token | Tinybird dashboard → Auth Tokens |
| tracker-token | Tinybird tracker token | Tinybird dashboard → Auth Tokens (append-only) |
| api-url | Tinybird API base URL | `https://api.us-east.aws.tinybird.co` |

---

## Step 4: Create Kubernetes Secret

```bash
eval $(op signin)

kubectl-homelab create secret generic ghost-tinybird \
  --from-literal=workspace-id="$(op read 'op://Kubernetes/Ghost Tinybird/workspace-id')" \
  --from-literal=admin-token="$(op read 'op://Kubernetes/Ghost Tinybird/admin-token')" \
  --from-literal=tracker-token="$(op read 'op://Kubernetes/Ghost Tinybird/tracker-token')" \
  --from-literal=api-url="$(op read 'op://Kubernetes/Ghost Tinybird/api-url')" \
  -n ghost-prod
```

---

## Step 5: Deploy TrafficAnalytics Proxy

```bash
kubectl-homelab apply -f manifests/ghost-prod/analytics-deployment.yaml
kubectl-homelab apply -f manifests/ghost-prod/analytics-service.yaml
```

### Verify

```bash
# Check pod is running (not CrashLoopBackOff)
kubectl-homelab get pods -n ghost-prod -l app=ghost-analytics

# Check logs — should show "Server listening at http://..."
kubectl-homelab logs -n ghost-prod -l app=ghost-analytics
```

> **Note:** If the pod CrashLoops with zero logs, it's likely OOM. The container needs ~145MB at idle. Ensure memory limit is at least 256Mi.

---

## Step 6: Update Ghost Deployment

The Ghost deployment needs Tinybird env vars using the `__` double-underscore convention for nested config:

```bash
kubectl-homelab apply -f manifests/ghost-prod/ghost-deployment.yaml
```

Key env vars added:

| Env Var | Purpose |
|---------|---------|
| `analytics__url` | Internal URL to TrafficAnalytics proxy |
| `analytics__enabled` | Enable analytics feature |
| `tinybird__tracker__endpoint` | Browser-facing POST URL for page hits |
| `tinybird__tracker__datasource` | Tinybird datasource name |
| `tinybird__workspaceId` | Required for Ghost config validation |
| `tinybird__adminToken` | Required for Ghost config validation |
| `tinybird__stats__endpoint` | Ghost admin reads stats from here |
| `tinybird__stats__endpointBrowser` | Browser-side stats endpoint |

### Verify

```bash
# Ghost pod should restart with new env vars
kubectl-homelab get pods -n ghost-prod -l app=ghost

# Check Ghost admin → Settings → Web analytics
# Toggle should show as enabled (not "requires configuration")
```

---

## Step 7: Configure Cloudflare Tunnel Hostname

Ghost's `ghost-stats.js` sends POST requests from the browser directly to the tracker endpoint. This requires a public URL for the TrafficAnalytics proxy.

1. In Cloudflare Zero Trust → Networks → Tunnels:
   - Add public hostname: `blog-api.rommelporras.com`
   - Service: `http://ghost-analytics.ghost-prod.svc.cluster.local:3000`

2. In Cloudflare DNS:
   - Add CNAME: `blog-api` → `<tunnel-uuid>.cfargotunnel.com` (Proxied)

> **Important:** Do NOT use multi-level subdomains like `analytics.blog.rommelporras.com` — Cloudflare free SSL only covers one level of subdomain.

---

## Step 8: Update CiliumNetworkPolicy

The cloudflared egress policy needs port 3000 added for the ghost-prod namespace:

```bash
kubectl-homelab apply -f manifests/cloudflare/networkpolicy.yaml
```

The ghost-prod section should include both ports:

```yaml
# Ghost prod namespace (blog.rommelporras.com, blog-api.rommelporras.com)
- toEndpoints:
  - matchLabels:
      k8s:io.kubernetes.pod.namespace: ghost-prod
  toPorts:
  - ports:
    - port: "2368"        # Ghost
      protocol: TCP
    - port: "3000"        # TrafficAnalytics
      protocol: TCP
```

---

## Step 9: Verify End-to-End

```bash
# Test the public endpoint
curl -I https://blog-api.rommelporras.com

# Check TrafficAnalytics logs for real page hits (not just health checks)
kubectl-homelab logs -n ghost-prod -l app=ghost-analytics --tail=20

# Visit blog.rommelporras.com from a different device/network
# Check Ghost admin → Dashboard for unique visitor count
```

If DNS doesn't resolve locally, purge AdGuard DNS cache.

---

## Verification Checklist

- [ ] TrafficAnalytics pod running: `kubectl-homelab get pods -n ghost-prod -l app=ghost-analytics`
- [ ] Ghost "Web analytics" toggle enabled in admin (Settings → Web analytics)
- [ ] `blog-api.rommelporras.com` returns 200
- [ ] Analytics logs show real page hit POSTs
- [ ] Ghost admin dashboard shows unique visitor count
- [ ] CiliumNetworkPolicy allows cloudflared → ghost-prod:3000

---

## Troubleshooting

### CrashLoopBackOff with zero logs

Container OOM. Check `kubectl-homelab describe pod <pod> -n ghost-prod` for `OOMKilled`. Increase memory limit to 256Mi.

### Ghost shows "requires configuration" for web analytics

Ghost checks `_isValidTinybirdConfig()` which requires:
- `tinybird__tracker__endpoint` (required)
- `tinybird__workspaceId` + `tinybird__adminToken` (for JWT mode)

Verify env vars use `__` double-underscore notation, NOT flat names like `TINYBIRD_ADMIN_TOKEN`.

### 502 Bad Gateway on blog-api.rommelporras.com

CiliumNetworkPolicy blocks cloudflared → ghost-prod:3000. Add port 3000 to the ghost-prod egress rule in `manifests/cloudflare/networkpolicy.yaml`.

### TLS handshake failure

Using a two-level subdomain like `analytics.blog.rommelporras.com`. Cloudflare free SSL only covers `*.rommelporras.com`. Switch to a single-level subdomain.

### No traffic in analytics

1. Check browser dev tools (Network tab) for `ghost-stats.min.js` and POST to `blog-api.rommelporras.com`
2. Ad blockers may block requests — test in incognito or from mobile data
3. Check TrafficAnalytics pod logs for incoming requests

---

## Rollback

```bash
# Remove TrafficAnalytics
kubectl-homelab delete -f manifests/ghost-prod/analytics-deployment.yaml
kubectl-homelab delete -f manifests/ghost-prod/analytics-service.yaml

# Revert Ghost deployment (remove Tinybird env vars)
# Revert cloudflare/networkpolicy.yaml (remove port 3000)
# Remove blog-api.rommelporras.com from Cloudflare Tunnel
# Delete CNAME record
# Delete secret: kubectl-homelab delete secret ghost-tinybird -n ghost-prod
```

---

## Next Steps

- [v0.18.0-firefox-browser.md](v0.18.0-firefox-browser.md) — Containerized Firefox browser with KasmVNC
