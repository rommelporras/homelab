# v0.24.0 — Tailscale Operator (Subnet Router)

> **Release:** v0.24.0
> **Phase:** 4.10 (Tailscale Operator)
> **Goal:** Enable secure remote access to all homelab services via Tailscale mesh VPN
> **Prerequisite:** [v0.21.0-karakeep.md](v0.21.0-karakeep.md) completed, AdGuard DNS operational (10.10.30.53)

---

## Overview

Deploys Tailscale Kubernetes Operator v1.94.1 with a Connector CRD that advertises the entire `10.10.30.0/24` subnet to the tailnet. All existing K8s services become accessible from any Tailscale-connected device via WireGuard tunnel — zero per-service manifests needed.

Traffic flow:
```
Phone/Laptop → WireGuard tunnel → Connector Pod (subnet route)
  → AdGuard DNS (10.10.30.53) → Cilium Gateway (10.10.30.20) → Service
```

Includes Cilium socketLB compatibility fix, operator-only CiliumNetworkPolicies, PrometheusRule alerts, and Homepage widget.

---

## Step 1: Tailscale Admin Console Setup

### 1a. Configure ACL Policy

Admin Console → Access Controls → Edit policy (JSON editor). Add to existing HuJSON:

```jsonc
{
  "tagOwners": {
    "tag:k8s-operator": [],
    "tag:k8s": ["tag:k8s-operator"]
  },
  "autoApprovers": {
    "routes": {
      "10.10.30.0/24": ["tag:k8s"]
    }
  }
}
```

### 1b. Create OAuth Client

Settings → Trust credentials → New credential:
- Scopes: Devices Core (R&W), Auth Keys (R&W), Services (Write)
- Tag: `tag:k8s-operator`

### 1c. Store in 1Password

```bash
eval $(op signin)

op item create \
  --vault "Kubernetes" \
  --category "API Credential" \
  --title "Tailscale K8s Operator" \
  "client-id=<CLIENT_ID>" \
  "client-secret=<CLIENT_SECRET>"

# Verify
op read "op://Kubernetes/Tailscale K8s Operator/client-id" >/dev/null && echo "ID OK"
op read "op://Kubernetes/Tailscale K8s Operator/client-secret" >/dev/null && echo "Secret OK"
```

---

## Step 2: Cilium Compatibility Fix

**BLOCKER:** Must be done BEFORE installing operator.

```bash
# socketLB.hostNamespaceOnly: true is already in helm/cilium/values.yaml
helm-homelab upgrade cilium cilium/cilium \
  --namespace kube-system \
  --version 1.18.6 \
  -f helm/cilium/values.yaml

# Verify
kubectl-homelab -n kube-system rollout status daemonset/cilium --timeout=120s
```

---

## Step 3: Apply Namespace and Network Policies

```bash
kubectl-homelab apply -f manifests/tailscale/namespace.yaml
kubectl-homelab apply -f manifests/tailscale/networkpolicy.yaml
```

---

## Step 4: Install Tailscale Operator

```bash
helm-homelab repo add tailscale https://pkgs.tailscale.com/helmcharts --force-update
helm-homelab repo update

eval $(op signin)

helm-homelab upgrade --install tailscale-operator tailscale/tailscale-operator \
  --namespace tailscale \
  --version 1.94.1 \
  -f helm/tailscale-operator/values.yaml \
  --set-string oauth.clientId="$(op read 'op://Kubernetes/Tailscale K8s Operator/client-id')" \
  --set-string oauth.clientSecret="$(op read 'op://Kubernetes/Tailscale K8s Operator/client-secret')" \
  --wait

# Verify
kubectl-homelab -n tailscale get pods
# Should show operator pod Running
```

---

## Step 5: Deploy Connector (Subnet Router)

```bash
kubectl-homelab apply -f manifests/tailscale/connector.yaml

# Verify
kubectl-homelab -n tailscale get pods
# Should show operator + connector proxy pod (ts-homelab-network-*)
```

Verify in Tailscale admin console:
- Machines → `homelab-subnet` should appear with tag:k8s
- Subnets → `10.10.30.0/24` should be auto-approved

---

## Step 6: Configure Tailscale DNS

In Tailscale Admin Console → DNS:
1. Remove any dead global nameservers
2. Add global nameserver: `10.10.30.53`
3. Toggle "Override DNS servers" → ON

---

## Step 7: Apply Monitoring Alerts

```bash
kubectl-homelab apply -f manifests/monitoring/tailscale-alerts.yaml

# Verify
kubectl-homelab -n monitoring get prometheusrule tailscale-alerts
```

---

## Step 8: Homepage Widget

Generate a Tailscale API access token (90-day expiry) at:
Admin Console → Settings → Keys → API access tokens

Store in 1Password and patch Homepage secret:

```bash
kubectl-homelab -n home patch secret homepage-secrets --type merge \
  -p "{\"stringData\":{\"HOMEPAGE_VAR_TAILSCALE_DEVICE\":\"<DEVICE_ID>\",\"HOMEPAGE_VAR_TAILSCALE_KEY\":\"$(op read 'op://Kubernetes/Tailscale K8s Operator/api-token')\"}}"

kubectl-homelab apply -k manifests/home/homepage/
kubectl-homelab -n home rollout restart deploy/homepage
```

---

## Step 9: Test Mobile Access

1. Connect phone to Tailscale (capybara-interval.ts.net)
2. Open `https://portal.k8s.rommelporras.com` — should load Homepage
3. Test other services (Grafana, Longhorn, AdGuard, Ghost, Karakeep)
4. Verify ad-blocking works (ads blocked on test sites)

---

## Verification

```bash
# Operator and connector pods
kubectl-homelab -n tailscale get pods

# Alerts registered
kubectl-homelab -n monitoring get prometheusrule tailscale-alerts

# Homepage widget
curl -sk https://portal.k8s.rommelporras.com | head -5
```

Tailscale admin console:
- `tailscale-operator` device visible
- `homelab-subnet` device with 10.10.30.0/24 subnet approved
- Global nameserver: 10.10.30.53

---

## Rollback

```bash
# Remove Connector
kubectl-homelab delete connector homelab-network

# Uninstall operator
helm-homelab uninstall tailscale-operator -n tailscale

# Delete namespace
kubectl-homelab delete namespace tailscale

# Revert DNS in Tailscale admin console
# Remove 10.10.30.53, add public DNS (1.1.1.1) if needed
```
