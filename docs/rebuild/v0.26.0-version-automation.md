# v0.26.0 — Version Automation & Upgrade Runbooks

> **Release:** v0.26.0
> **Phase:** 4.27 (Version Automation & Upgrade Runbooks)
> **Goal:** Automated version tracking for container images, Helm charts, and Kubernetes version — plus upgrade/rollback runbook for all component types
> **Prerequisite:** [v0.25.0-arr-companions.md](v0.25.0-arr-companions.md) completed, all services running

---

## Overview

Three tools cover the full version tracking surface:

```
Version Tracking
├── version-checker (Deployment, monitoring namespace)
│   ├── Scans all running container images for newer versions
│   ├── Tracks Kubernetes version drift
│   ├── Exposes Prometheus metrics → Grafana dashboard + alerts
│   └── LinuxServer.io images use match-regex annotations
│
├── Renovate Bot (GitHub App, SaaS)
│   ├── Scans manifests/ for container image tags
│   ├── Creates PRs for image updates (dependency dashboard approval)
│   ├── Groups minor/patch weekly, separates major bumps
│   └── Ignores byparr (no semver tags), private registry images
│
├── Nova CronJob (CronJob, monitoring namespace)
│   ├── Runs weekly Sunday 08:00 PHT (00:00 UTC)
│   ├── Checks Helm chart drift (installed vs latest)
│   └── Sends Discord embed to #versions channel
│
└── Upgrade Runbook (docs/context/Upgrades.md)
    ├── Pre-upgrade checklist (etcd backup, node health)
    ├── Procedures for each component type
    ├── Risk matrix and emergency rollback
    └── Service-specific warnings
```

---

## Step 0: Pin :latest Images (Prerequisite)

Version tracking tools need semver tags to compare. Pin all `:latest` images first.

Find current versions running in the cluster:

```bash
# LinuxServer.io images store version in package_info
kubectl-homelab exec -n arr-stack deploy/bazarr -- cat /app/bazarr/package_info
kubectl-homelab exec -n arr-stack deploy/radarr -- cat /app/radarr/package_info
kubectl-homelab exec -n arr-stack deploy/sonarr -- cat /app/sonarr/package_info
kubectl-homelab exec -n browser deploy/firefox -- cat /build_version
```

Update each deployment manifest — change image tag and imagePullPolicy:

```yaml
# Before
image: lscr.io/linuxserver/bazarr:latest
imagePullPolicy: Always

# After
image: lscr.io/linuxserver/bazarr:v1.5.5-ls338
imagePullPolicy: IfNotPresent
```

Add version-checker match-regex annotation to pod templates (inside `spec.template.metadata.annotations`):

```yaml
annotations:
  match-regex.version-checker.io/bazarr: "^v?\\d+\\.\\d+\\.\\d+-ls\\d+$"
```

**Files to update:**
- `manifests/arr-stack/bazarr/deployment.yaml`
- `manifests/arr-stack/radarr/deployment.yaml`
- `manifests/arr-stack/sonarr/deployment.yaml`
- `manifests/browser/deployment.yaml`

**Note:** byparr (`ghcr.io/thephaseless/byparr`) only publishes `latest`/`main`/`nightly` tags — no semver releases. Added to Renovate ignore list instead.

Apply and verify:

```bash
kubectl-homelab apply \
  -f manifests/arr-stack/bazarr/deployment.yaml \
  -f manifests/arr-stack/radarr/deployment.yaml \
  -f manifests/arr-stack/sonarr/deployment.yaml \
  -f manifests/browser/deployment.yaml

# Verify all pods restart with pinned tags
kubectl-homelab -n arr-stack rollout status deploy/bazarr deploy/radarr deploy/sonarr
kubectl-homelab -n browser rollout status deploy/firefox
```

---

## Step 1: Install Renovate Bot

1. Go to https://github.com/apps/renovate and install on the `homelab` repository
2. Register with Mend (required), select "Renovate Only"
3. Choose "Scan and Alert" mode
4. Close the auto-generated onboarding PR (our `renovate.json` is already in the repo)

Apply `renovate.json` at repo root:

```bash
# renovate.json is committed to git — Renovate reads it from the repo
git push  # Renovate picks up config on next scan
```

Verify:
- Renovate creates a "Dependency Dashboard" issue in the repo
- Dashboard lists discovered dependencies from `manifests/`

---

## Step 2: Deploy version-checker

```bash
kubectl-homelab apply \
  -f manifests/monitoring/version-checker-rbac.yaml \
  -f manifests/monitoring/version-checker-deployment.yaml \
  -f manifests/monitoring/version-checker-servicemonitor.yaml \
  -f manifests/monitoring/version-checker-alerts.yaml \
  -f manifests/monitoring/version-checker-dashboard-configmap.yaml
```

Verify:

```bash
# Pod running
kubectl-homelab -n monitoring get pods -l app=version-checker

# Metrics exposed (from inside the pod)
kubectl-homelab -n monitoring exec deploy/version-checker -- \
  wget -qO- http://localhost:8080/metrics | grep version_checker_is_latest_version
kubectl-homelab -n monitoring exec deploy/version-checker -- \
  wget -qO- http://localhost:8080/metrics | grep version_checker_is_latest_kube_version
```

**Note:** The Grafana dashboard needs ~1 hour for the first scrape to populate data.

---

## Step 3: Create Discord Webhook

1. Create `#versions` channel in Discord (under Notification group)
2. Create webhook: Server Settings → Integrations → Create Webhook → select channel
3. Store in 1Password:

```bash
eval $(op signin)
op item create \
  --vault "Kubernetes" \
  --category login \
  --title "Discord Webhook Versions" \
  "credential=<webhook-url>"
```

4. Create K8s Secret:

```bash
kubectl-homelab -n monitoring create secret generic discord-webhook \
  --from-literal=webhook-url="$(op read 'op://Kubernetes/Discord Webhook Versions/credential')"
```

5. Test webhook:

```bash
curl -X POST "$(op read 'op://Kubernetes/Discord Webhook Versions/credential')" \
  -H "Content-Type: application/json" \
  -d '{"content": "Test - Version check webhook working"}'
```

---

## Step 4: Deploy Version Check CronJob

```bash
kubectl-homelab apply \
  -f manifests/monitoring/version-check-rbac.yaml \
  -f manifests/monitoring/version-check-script.yaml \
  -f manifests/monitoring/version-check-cronjob.yaml
```

Test with manual run:

```bash
kubectl-homelab -n monitoring create job --from=cronjob/version-check version-check-manual
kubectl-homelab -n monitoring logs job/version-check-manual -f
```

Expected output: "Discord notification sent successfully (HTTP 204)"

Verify Discord `#versions` channel receives the Helm chart drift embed.

---

## Step 5: Install Nova CLI (Local)

```bash
curl -sL https://github.com/FairwindsOps/nova/releases/download/v3.11.10/nova_3.11.10_linux_amd64.tar.gz -o /tmp/nova.tar.gz
tar xzf /tmp/nova.tar.gz -C /tmp nova && chmod +x /tmp/nova && mv /tmp/nova ~/.local/bin/nova
```

Test:

```bash
KUBECONFIG=~/.kube/homelab.yaml nova find --helm --format table --show-old
```

---

## Step 6: Verify Upgrade Runbook

`docs/context/Upgrades.md` is created as part of this release. It covers:

- Pre-upgrade checklist (etcd backup, node health, PVC status)
- Upgrade/rollback for: Helm charts, raw manifests, kubeadm, kube-vip, Longhorn, Cilium
- Risk matrix (Low → Highest)
- Service-specific warnings (Ghost, GitLab, Jellyfin, PostgreSQL, Meilisearch, ARR)
- Emergency rollback procedures

---

## Verification Checklist

```bash
# version-checker running
kubectl-homelab -n monitoring get pods -l app=version-checker

# CronJob exists
kubectl-homelab -n monitoring get cronjob version-check

# Prometheus metrics
kubectl-homelab -n monitoring exec deploy/version-checker -- \
  wget -qO- http://localhost:8080/metrics | head -5

# Nova CLI
KUBECONFIG=~/.kube/homelab.yaml nova version

# Renovate Dashboard issue exists on GitHub
gh issue list --label renovate --repo rommelporras/homelab
```

---

## Rollback

```bash
# Remove version-checker
kubectl-homelab delete deployment,service,servicemonitor,configmap -l app=version-checker -n monitoring
kubectl-homelab delete prometheusrule version-checker-alerts -n monitoring
kubectl-homelab delete clusterrole,clusterrolebinding version-checker

# Remove CronJob
kubectl-homelab delete cronjob version-check -n monitoring
kubectl-homelab delete configmap version-check-script -n monitoring
kubectl-homelab delete clusterrole,clusterrolebinding version-check-cronjob
kubectl-homelab delete serviceaccount version-check-cronjob -n monitoring
kubectl-homelab delete secret discord-webhook -n monitoring

# Renovate: disable via GitHub App settings (no cluster changes)
# Nova CLI: rm ~/.local/bin/nova
```
