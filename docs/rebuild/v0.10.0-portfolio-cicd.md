# v0.10.0 — Portfolio CI/CD

> **Release:** v0.10.0
> **Phase:** 4.7
> **Goal:** First app deployment via GitLab CI/CD with multi-environment promotion
> **Prerequisite:** [v0.8.0-gitlab.md](v0.8.0-gitlab.md) completed

---

## Overview

This release migrates the portfolio site from a Proxmox VM (Docker Compose) to Kubernetes with a full CI/CD pipeline. Three environments (dev, staging, prod) use GitFlow branching with artifact promotion.

**Stack:** Next.js 16 + Bun + nginx (static export)

**Architecture:**
```
feature/* → develop → [Build image] → deploy:dev (auto)
                                           │
                                    deploy:staging (manual)
                                           │
                              develop → main (merge MR)
                                           │
                                    deploy:prod (auto)
```

**Environments:**

| Environment | Internal URL | Public URL |
|-------------|-------------|------------|
| Dev | portfolio.dev.k8s.rommelporras.com | — |
| Staging | portfolio.stg.k8s.rommelporras.com | beta.rommelporras.com |
| Prod | portfolio.k8s.rommelporras.com | www.rommelporras.com |

---

## Step 1: Import Portfolio to GitLab

```
GitLab → New Project → Import project → GitHub
Select: rommelporras/portfolio
Imported to: 0xwsh/portfolio

Enable Container Registry:
Project → Settings → General → Visibility → Container Registry: Enabled

Make project Public for anonymous registry pulls:
Project → Settings → General → Visibility → Public
```

Configure GitHub push mirroring (SSH):

```
Project → Settings → Repository → Mirroring repositories

Git repository URL: ssh://git@github.com/rommelporras/portfolio.git
Mirror direction: Push
Authentication method: SSH public key
Only mirror protected branches: Yes

Add GitLab's SSH public key to GitHub:
GitHub repo → Settings → Deploy keys → Add deploy key
Title: GitLab homelab push mirror
Allow write access: Yes
```

---

## Step 2: Create Namespaces

```bash
kubectl-homelab create namespace portfolio-dev
kubectl-homelab create namespace portfolio-staging
kubectl-homelab create namespace portfolio-prod

# Apply pod security baseline
kubectl-homelab label namespace portfolio-dev pod-security.kubernetes.io/enforce=baseline
kubectl-homelab label namespace portfolio-staging pod-security.kubernetes.io/enforce=baseline
kubectl-homelab label namespace portfolio-prod pod-security.kubernetes.io/enforce=baseline
```

---

## Step 3: Create RBAC for CI/CD

**manifests/portfolio/rbac.yaml** — apply to each namespace:

```yaml
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: gitlab-deploy
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: gitlab-deploy
rules:
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch", "patch", "update"]
- apiGroups: ["apps"]
  resources: ["replicasets"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: gitlab-deploy
subjects:
- kind: ServiceAccount
  name: gitlab-deploy
roleRef:
  kind: Role
  name: gitlab-deploy
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: Secret
metadata:
  name: gitlab-deploy-token
  annotations:
    kubernetes.io/service-account.name: gitlab-deploy
type: kubernetes.io/service-account-token
```

> **Note:** `list` and `watch` on deployments are required for `kubectl rollout status`. `replicasets` resource is needed for rollout status to track replica progress.

```bash
kubectl-homelab apply -f manifests/portfolio/rbac.yaml -n portfolio-dev
kubectl-homelab apply -f manifests/portfolio/rbac.yaml -n portfolio-staging
kubectl-homelab apply -f manifests/portfolio/rbac.yaml -n portfolio-prod
```

Extract tokens for GitLab CI/CD variables:

```bash
kubectl-homelab get secret gitlab-deploy-token -n portfolio-dev \
  -o jsonpath='{.data.token}' | base64 -d | tr -d '\n'

kubectl-homelab get secret gitlab-deploy-token -n portfolio-staging \
  -o jsonpath='{.data.token}' | base64 -d | tr -d '\n'

kubectl-homelab get secret gitlab-deploy-token -n portfolio-prod \
  -o jsonpath='{.data.token}' | base64 -d | tr -d '\n'
```

Add to GitLab CI/CD variables (`Project → Settings → CI/CD → Variables`):

| Variable | Environment | Visibility | Protect? |
|----------|-------------|-----------|----------|
| KUBE_API_URL | All | Masked and hidden | No |
| KUBE_TOKEN | dev | Masked and hidden | No |
| KUBE_TOKEN | staging | Masked and hidden | No |
| KUBE_TOKEN | production | Masked and hidden | Yes |

- `KUBE_API_URL`: `https://10.10.30.10:6443`
- `KUBE_TOKEN`: Token from each namespace's `gitlab-deploy-token`

---

## Step 4: Deploy Application

**manifests/portfolio/deployment.yaml** — apply to each namespace:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: portfolio
  labels:
    app: portfolio
spec:
  replicas: 2
  selector:
    matchLabels:
      app: portfolio
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: portfolio
    spec:
      containers:
      - name: portfolio
        image: registry.k8s.rommelporras.com/0xwsh/portfolio:latest
        ports:
        - containerPort: 80
          name: http
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
          failureThreshold: 3
---
apiVersion: v1
kind: Service
metadata:
  name: portfolio
  labels:
    app: portfolio
spec:
  type: ClusterIP
  selector:
    app: portfolio
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: http
```

```bash
kubectl-homelab apply -f manifests/portfolio/deployment.yaml -n portfolio-dev
kubectl-homelab apply -f manifests/portfolio/deployment.yaml -n portfolio-staging
kubectl-homelab apply -f manifests/portfolio/deployment.yaml -n portfolio-prod
```

---

## Step 5: Create HTTPRoutes

**manifests/gateway/routes/portfolio-dev.yaml:**

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: portfolio
  namespace: portfolio-dev
spec:
  parentRefs:
    - name: homelab-gateway
      namespace: default
      sectionName: https
  hostnames:
    - "portfolio.dev.k8s.rommelporras.com"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: portfolio
          port: 80
```

**manifests/gateway/routes/portfolio-staging.yaml:**

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: portfolio
  namespace: portfolio-staging
spec:
  parentRefs:
    - name: homelab-gateway
      namespace: default
      sectionName: https
  hostnames:
    - "portfolio.stg.k8s.rommelporras.com"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: portfolio
          port: 80
```

**manifests/gateway/routes/portfolio-prod.yaml:**

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: portfolio
  namespace: portfolio-prod
spec:
  parentRefs:
    - name: homelab-gateway
      namespace: default
      sectionName: https
  hostnames:
    - "portfolio.k8s.rommelporras.com"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: portfolio
          port: 80
```

```bash
kubectl-homelab apply -f manifests/gateway/routes/portfolio-dev.yaml
kubectl-homelab apply -f manifests/gateway/routes/portfolio-staging.yaml
kubectl-homelab apply -f manifests/gateway/routes/portfolio-prod.yaml
```

DNS is covered by the existing AdGuard wildcard: `*.k8s.rommelporras.com → 10.10.30.20`

---

## Step 6: Configure Cloudflare Tunnel

Add public hostnames in Cloudflare Zero Trust Dashboard:

```
Networks → Tunnels → (tunnel) → Public Hostname

Staging:
  Subdomain: beta
  Domain: rommelporras.com
  Type: HTTP
  URL: portfolio.portfolio-staging.svc:80

Production:
  Subdomain: www
  Domain: rommelporras.com
  Type: HTTP
  URL: portfolio.portfolio-prod.svc:80
```

Update CiliumNetworkPolicy to allow tunnel egress to portfolio namespaces:

```yaml
# In manifests/cloudflare/networkpolicy.yaml, add:
# Portfolio namespaces (staging + prod only, dev is internal)
- toEndpoints:
  - matchLabels:
      k8s:io.kubernetes.pod.namespace: portfolio-staging
  - matchLabels:
      k8s:io.kubernetes.pod.namespace: portfolio-prod
  toPorts:
  - ports:
    - port: "80"
      protocol: TCP
```

```bash
kubectl-homelab apply -f manifests/cloudflare/networkpolicy.yaml
```

---

## Step 7: Configure Portfolio Repository

The portfolio repo needs a Dockerfile and `.gitlab-ci.yml`:

**Dockerfile** (multi-stage: Bun build + nginx serve):

```dockerfile
FROM oven/bun:1 AS deps
WORKDIR /app
COPY package.json bun.lock ./
RUN bun install --frozen-lockfile --production

FROM oven/bun:1 AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN bun run build

FROM nginx:alpine
COPY nginx.conf /etc/nginx/nginx.conf
COPY --from=builder /app/out /usr/share/nginx/html
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget -qO- http://127.0.0.1/health || exit 1
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

The `.gitlab-ci.yml` pipeline runs: validate → test → build → deploy (per environment). See the portfolio repo for the full pipeline.

---

## Step 8: Test Pipeline

```bash
# Push to develop to trigger build + auto deploy to dev
cd /home/wsl/personal/portfolio
git push origin develop

# Verify dev deployment
kubectl-homelab get pods -n portfolio-dev
curl -sk https://portfolio.dev.k8s.rommelporras.com

# Manually promote to staging (GitLab UI → Pipelines → play button)
# Verify staging
kubectl-homelab get pods -n portfolio-staging
curl -I https://beta.rommelporras.com

# Merge develop → main for production
git checkout main && git merge develop --no-edit && git push origin main
# Verify production
kubectl-homelab get pods -n portfolio-prod
curl -I https://www.rommelporras.com
```

---

## Verification Checklist

- [ ] GitLab repository with Container Registry enabled
- [ ] GitHub push mirror working
- [ ] Three namespaces created with pod security baseline
- [ ] RBAC configured with environment-scoped tokens
- [ ] Deployments running in all three namespaces (2 replicas each)
- [ ] HTTPRoutes resolving for all environments
- [ ] Pipeline passes all stages on develop branch
- [ ] Auto-deploy to dev works
- [ ] Manual staging promotion works
- [ ] Production deploy works on main merge
- [ ] `beta.rommelporras.com` → staging via Cloudflare Tunnel
- [ ] `www.rommelporras.com` → prod via Cloudflare Tunnel

---

## Rollback

```bash
# Quick rollback
kubectl-homelab rollout undo deployment/portfolio -n portfolio-prod

# Image-based rollback
kubectl-homelab set image deployment/portfolio \
  portfolio=registry.k8s.rommelporras.com/0xwsh/portfolio:<previous-tag> \
  -n portfolio-prod

# Emergency fallback to PVE VM
ssh reverse-mountain "cd /home/wawashi/portfolio && docker compose up -d"
# Revert Cloudflare tunnel route to VM IP in dashboard
```

---

## Files Reference

| File | Purpose |
|------|---------|
| `manifests/portfolio/deployment.yaml` | Deployment + Service (apply per namespace) |
| `manifests/portfolio/rbac.yaml` | ServiceAccount, Role, RoleBinding, Token |
| `manifests/gateway/routes/portfolio-dev.yaml` | HTTPRoute for dev |
| `manifests/gateway/routes/portfolio-staging.yaml` | HTTPRoute for staging |
| `manifests/gateway/routes/portfolio-prod.yaml` | HTTPRoute for prod |
| `manifests/cloudflare/networkpolicy.yaml` | Updated CiliumNetworkPolicy with portfolio egress |

---

## Key Learnings

| Topic | Lesson |
|-------|--------|
| Artifact promotion | Same Docker image promoted through environments — no rebuild per env |
| RBAC scoping | Environment-scoped ServiceAccount tokens for least privilege |
| Rolling updates | `maxSurge: 1, maxUnavailable: 0` ensures zero-downtime deploys |
| Registry auth | Making GitLab project public avoids imagePullSecret complexity |
| CiliumNetworkPolicy | Tunnel needs explicit egress to each namespace it serves |
| Manual gates | Corporate pattern: auto-deploy to dev, manual promote to staging, auto to prod on merge |

---

## Next Steps

- Deploy Ghost blog platform (Phase 4.12)
- Add HTTP probes for web services using blackbox exporter
