# v0.3.0 â€” Storage Infrastructure

> **Release:** v0.3.0
> **Phase:** 3.1-3.4
> **Goal:** Longhorn distributed storage with 2x replication
> **Prerequisite:** [v0.2.0-bootstrap.md](v0.2.0-bootstrap.md) completed

---

## Overview

This release installs distributed storage:
- Longhorn for dynamic PVC provisioning
- 2x replication across nodes for HA
- ~400GB usable capacity per node

---

## Component Versions

| Component | Version |
|-----------|---------|
| Longhorn | 1.10.1 |

---

## Step 1: Prepare Storage Directory (All Nodes)

```bash
# Create Longhorn data directory on all nodes
for node in k8s-cp1 k8s-cp2 k8s-cp3; do
    echo "=== Preparing $node ==="
    ssh wawashi@$node.home.rommelporras.com "sudo mkdir -p /var/lib/longhorn && sudo chmod 700 /var/lib/longhorn"
    ssh wawashi@$node.home.rommelporras.com "df -h /var/lib/longhorn"
done
```

Expected: ~400GB free on each node's NVMe.

---

## Step 2: Verify iSCSI (All Nodes)

```bash
# Verify open-iscsi is running (installed in v0.2.0)
for node in k8s-cp1 k8s-cp2 k8s-cp3; do
    echo "=== $node ==="
    ssh wawashi@$node.home.rommelporras.com "systemctl is-active iscsid"
done
# Should show "active" for all nodes
```

---

## Step 3: Remove Control-Plane Taints

Allow workloads to run on control plane nodes (homelab only):

```bash
for node in k8s-cp1 k8s-cp2 k8s-cp3; do
    kubectl-homelab taint nodes $node node-role.kubernetes.io/control-plane:NoSchedule- || true
done

# Verify no taints
kubectl-homelab describe nodes | grep Taints
# Should show: Taints: <none>
```

---

## Step 4: Install Longhorn

```bash
# Add Helm repo
helm-homelab repo add longhorn https://charts.longhorn.io
helm-homelab repo update

# Create namespace with privileged PSS
kubectl-homelab create namespace longhorn-system
kubectl-homelab label namespace longhorn-system pod-security.kubernetes.io/enforce=privileged

# Install Longhorn with version pinning
helm-homelab install longhorn longhorn/longhorn \
    --namespace longhorn-system \
    --version 1.10.1 \
    --values helm/longhorn/values.yaml

# Wait for deployment
kubectl-homelab -n longhorn-system rollout status deploy/longhorn-driver-deployer
```

---

## Step 5: Wait for All Pods

```bash
# Watch pods come up (23 pods expected)
kubectl-homelab -n longhorn-system get pods -w

# Or wait for specific deployments
kubectl-homelab -n longhorn-system rollout status deploy/longhorn-ui
kubectl-homelab -n longhorn-system rollout status deploy/csi-attacher
kubectl-homelab -n longhorn-system rollout status deploy/csi-provisioner
```

---

## Step 6: Verify Longhorn Installation

```bash
# All pods running
kubectl-homelab -n longhorn-system get pods
# Should show 23 pods all Running

# All nodes schedulable
kubectl-homelab -n longhorn-system get nodes.longhorn.io
# NAME      READY   ALLOWSCHEDULING   SCHEDULABLE   AGE
# k8s-cp1   True    true              True          2m
# k8s-cp2   True    true              True          2m
# k8s-cp3   True    true              True          2m

# StorageClass is default
kubectl-homelab get storageclass
# NAME                 PROVISIONER          RECLAIMPOLICY   VOLUMEBINDINGMODE   AGE
# longhorn (default)   driver.longhorn.io   Delete          Immediate           2m
```

---

## Step 7: Test Storage

### Create Test PVC

```bash
kubectl-homelab apply -f - <<EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-pvc
  namespace: default
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: longhorn
  resources:
    requests:
      storage: 1Gi
EOF

# Verify PVC is Bound
kubectl-homelab get pvc test-pvc
# STATUS should be Bound
```

### Create Test Pod

```bash
kubectl-homelab apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
  namespace: default
spec:
  containers:
  - name: test
    image: busybox
    command: ["sh", "-c", "echo 'Hello Longhorn!' > /data/test.txt && sleep 3600"]
    volumeMounts:
    - name: data
      mountPath: /data
  volumes:
  - name: data
    persistentVolumeClaim:
      claimName: test-pvc
EOF

# Wait for pod to be running
kubectl-homelab get pod test-pod -w

# Verify data written
kubectl-homelab exec test-pod -- cat /data/test.txt
# Should show: Hello Longhorn!
```

### Verify Replication

```bash
# Check replicas (should show 2 on different nodes)
kubectl-homelab -n longhorn-system get replicas.longhorn.io

# Or access Longhorn UI
kubectl-homelab -n longhorn-system port-forward svc/longhorn-frontend 8080:80
# Open http://localhost:8080 and check Volume tab
```

### Cleanup Test Resources

```bash
kubectl-homelab delete pod test-pod
kubectl-homelab delete pvc test-pvc
```

---

## Verification

```bash
echo "=== Longhorn Pods ==="
kubectl-homelab -n longhorn-system get pods | head -10

echo ""
echo "=== Longhorn Nodes ==="
kubectl-homelab -n longhorn-system get nodes.longhorn.io

echo ""
echo "=== Storage Class ==="
kubectl-homelab get storageclass

echo ""
echo "=== Disk Usage per Node ==="
for node in k8s-cp1 k8s-cp2 k8s-cp3; do
    echo "=== $node ==="
    ssh wawashi@$node.home.rommelporras.com "df -h /var/lib/longhorn"
done
```

---

## Checklist

- [ ] /var/lib/longhorn created on all nodes
- [ ] iscsid running on all nodes
- [ ] Control-plane taints removed
- [ ] Longhorn Helm chart installed (v1.10.1)
- [ ] All 23 Longhorn pods running
- [ ] All 3 nodes show Ready/Schedulable
- [ ] StorageClass "longhorn" is default
- [ ] Test PVC bound successfully
- [ ] Test pod can write data
- [ ] 2x replication verified

---

## Storage Capacity Reference

```
Per Node:
  NVMe Total:           512GB
  OS + etcd + images:   ~100GB
  Available for LH:     ~400GB

Cluster Total (3 nodes):
  Raw capacity:         ~1200GB
  With 2x replication:  ~600GB usable
```

---

## Troubleshooting

### PVC Stuck in Pending

```bash
# Check events
kubectl-homelab describe pvc <pvc-name>

# Common causes:
# - StorageClass doesn't exist
# - No schedulable nodes
# - Insufficient disk space
```

### Node Shows Unschedulable

```bash
# Check if path exists and has space
ssh k8s-cp1.home.rommelporras.com "df -h /var/lib/longhorn"

# Check node conditions
kubectl-homelab -n longhorn-system describe node.longhorn.io k8s-cp1
```

### Longhorn UI Access

```bash
# Port forward
kubectl-homelab -n longhorn-system port-forward svc/longhorn-frontend 8080:80
# Open http://localhost:8080
```

---

## Next Steps

Proceed to [v0.4.0-observability.md](v0.4.0-observability.md) to install Gateway API, monitoring, logging, and UPS monitoring.
