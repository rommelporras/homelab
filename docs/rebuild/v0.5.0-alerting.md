# v0.5.0 ‚Äî Alertmanager Notifications

> **Release:** v0.5.0
> **Phase:** 3.9
> **Goal:** Configure Alertmanager with Discord and Email notifications
> **Prerequisite:** [v0.4.0-observability.md](v0.4.0-observability.md) completed

---

## Overview

This release configures Alertmanager to send notifications:
- **Discord #incidents** ‚Äî Critical alerts (action required)
- **Discord #status** ‚Äî Warnings, info, resolved alerts
- **Email** ‚Äî Critical alerts only (3 recipients for redundancy)

---

## Prerequisites

### 1Password Items Required

Create these items in the **Kubernetes** vault before starting:

| Item Name | Type | Fields |
|-----------|------|--------|
| Discord Webhook Incidents | API Credential | `credential` (webhook URL) |
| Discord Webhook Status | API Credential | `credential` (webhook URL) |
| iCloud SMTP | Login | `username`, `password`, `server`, `port` |

### Discord Setup

1. Create category: **Notifications**
2. Create channels:
   - `#incidents` ‚Äî "Critical alerts - action required"
   - `#status` ‚Äî "Informational updates, warnings, resolved"
3. Create webhooks in each channel (Settings ‚Üí Integrations ‚Üí Webhooks)

### iCloud SMTP

1. Go to https://appleid.apple.com
2. Sign In & Security ‚Üí App-Specific Passwords
3. Generate password named "Alertmanager Homelab"
4. SMTP settings:
   - Server: `smtp.mail.me.com`
   - Port: `587`
   - Username: Your `@icloud.com` email (NOT custom domain)
   - Security: STARTTLS

---

## Step 1: Store Credentials in 1Password

```bash
# Verify 1Password session
op account get || eval $(op signin)

# Verify items exist
op read "op://Kubernetes/Discord Webhook Incidents/credential" >/dev/null && echo "Incidents webhook OK"
op read "op://Kubernetes/Discord Webhook Status/credential" >/dev/null && echo "Status webhook OK"
op read "op://Kubernetes/iCloud SMTP/username" >/dev/null && echo "SMTP username OK"
op read "op://Kubernetes/iCloud SMTP/password" >/dev/null && echo "SMTP password OK"
```

---

## Step 2: Test Webhooks Manually

```bash
# Test #incidents webhook
curl -H "Content-Type: application/json" \
  -d '{"content": "üî¥ Test incident from homelab cluster"}' \
  "$(op read 'op://Kubernetes/Discord Webhook Incidents/credential')"

# Test #status webhook
curl -H "Content-Type: application/json" \
  -d '{"content": "‚ÑπÔ∏è Test status update from homelab cluster"}' \
  "$(op read 'op://Kubernetes/Discord Webhook Status/credential')"
```

---

## Step 3: Test SMTP

```bash
python3 << 'EOF'
import smtplib
import subprocess

username = subprocess.run(['op', 'read', 'op://Kubernetes/iCloud SMTP/username'],
                         capture_output=True, text=True).stdout.strip()
password = subprocess.run(['op', 'read', 'op://Kubernetes/iCloud SMTP/password'],
                         capture_output=True, text=True).stdout.strip()

print(f"Testing SMTP with: {username}")
server = smtplib.SMTP('smtp.mail.me.com', 587, timeout=10)
server.starttls()
server.login(username, password)
print("‚úÖ SMTP authentication successful!")
server.quit()
EOF
```

---

## Step 4: Upgrade Prometheus Stack

Use the upgrade script which reads secrets from 1Password:

```bash
./scripts/upgrade-prometheus.sh
```

Or manually:

```bash
# Create temp secrets file
DISCORD_INCIDENTS_WEBHOOK=$(op read "op://Kubernetes/Discord Webhook Incidents/credential")
DISCORD_STATUS_WEBHOOK=$(op read "op://Kubernetes/Discord Webhook Status/credential")
SMTP_USERNAME=$(op read "op://Kubernetes/iCloud SMTP/username")
SMTP_PASSWORD=$(op read "op://Kubernetes/iCloud SMTP/password")
GRAFANA_PASSWORD=$(op read "op://Kubernetes/Grafana/password")

cat > /tmp/alertmanager-secrets.yaml << EOF
grafana:
  adminPassword: "${GRAFANA_PASSWORD}"

alertmanager:
  config:
    global:
      smtp_auth_username: "${SMTP_USERNAME}"
      smtp_auth_password: "${SMTP_PASSWORD}"
    receivers:
      - name: 'discord-incidents-email'
        discord_configs:
          - webhook_url: "${DISCORD_INCIDENTS_WEBHOOK}"
            title: 'üî¥ {{ .Status | toUpper }}: {{ .CommonLabels.alertname }}'
            message: |
              {{ range .Alerts }}
              **{{ .Labels.alertname }}** ({{ .Labels.severity }})
              {{ .Annotations.summary }}
              {{ if .Annotations.description }}{{ .Annotations.description }}{{ end }}
              {{ end }}
        email_configs:
          - to: 'critical@rommelporras.com, r3mmel023@gmail.com, rommelcporras@gmail.com'
            send_resolved: true
            headers:
              Subject: '[{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}'
      - name: 'discord-status'
        discord_configs:
          - webhook_url: "${DISCORD_STATUS_WEBHOOK}"
            title: '{{ if eq .Status "firing" }}‚ö†Ô∏è{{ else }}‚úÖ{{ end }} {{ .Status | toUpper }}: {{ .CommonLabels.alertname }}'
            message: |
              {{ range .Alerts }}
              **{{ .Labels.alertname }}** ({{ .Labels.severity }})
              {{ .Annotations.summary }}
              {{ if .Annotations.description }}{{ .Annotations.description }}{{ end }}
              {{ end }}
      - name: 'null'
EOF

helm-homelab upgrade prometheus oci://ghcr.io/prometheus-community/charts/kube-prometheus-stack \
    --namespace monitoring \
    --version 81.0.0 \
    --values helm/prometheus/values.yaml \
    --values /tmp/alertmanager-secrets.yaml

rm -f /tmp/alertmanager-secrets.yaml
```

---

## Step 5: Verify Configuration

```bash
# Wait for rollout
kubectl-homelab -n monitoring rollout status statefulset/alertmanager-prometheus-kube-prometheus-alertmanager

# Check config loaded
kubectl-homelab -n monitoring logs -l app.kubernetes.io/name=alertmanager --tail=20 | grep -i "loading configuration"

# Verify receivers
kubectl-homelab -n monitoring exec alertmanager-prometheus-kube-prometheus-alertmanager-0 -- \
  cat /etc/alertmanager/config_out/alertmanager.env.yaml | grep -A2 "receivers:"
```

---

## Step 6: Test Alert Routing

```bash
# Apply test alerts
kubectl-homelab apply -f manifests/monitoring/test-alert.yaml

# Wait ~2 minutes for alerts to fire, then check routing
kubectl-homelab -n monitoring exec alertmanager-prometheus-kube-prometheus-alertmanager-0 -- \
  wget -qO- 'http://localhost:9093/api/v2/alerts' | jq '.[] | select(.labels.alertname | startswith("TestAlert")) | {alertname: .labels.alertname, receiver: .receivers[0].name}'

# Expected:
# TestAlertCritical ‚Üí discord-incidents-email
# TestAlertWarning ‚Üí discord-status

# Delete test alerts
kubectl-homelab delete -f manifests/monitoring/test-alert.yaml
```

---

## Alert Routing Summary

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      Alertmanager                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                     ‚îÇ                     ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇSilenced ‚îÇ          ‚îÇ Critical  ‚îÇ         ‚îÇWarning/ ‚îÇ
   ‚îÇ(kubeadm)‚îÇ          ‚îÇ           ‚îÇ         ‚îÇ  Info   ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                     ‚îÇ                    ‚îÇ
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ  null   ‚îÇ          ‚îÇ#incidents ‚îÇ         ‚îÇ #status ‚îÇ
   ‚îÇreceiver ‚îÇ          ‚îÇ + Email   ‚îÇ         ‚îÇ  only   ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Email Recipients (Critical only):**
- critical@rommelporras.com
- r3mmel023@gmail.com
- rommelcporras@gmail.com

---

## Silenced Alerts

These alerts are routed to `null` (false positives from kubeadm):

| Alert | Reason |
|-------|--------|
| `KubeProxyDown` | kube-proxy metrics not exposed |
| `etcdInsufficientMembers` | etcd metrics not scraped |
| `etcdMembersDown` | etcd metrics not scraped |
| `TargetDown` (kube-*) | Control plane bound to localhost |

See `docs/todo/deferred.md` for future fix instructions.

---

## Troubleshooting

### Discord not receiving alerts

```bash
# Check Alertmanager logs
kubectl-homelab -n monitoring logs -l app.kubernetes.io/name=alertmanager | grep -i discord

# Test webhook directly
curl -H "Content-Type: application/json" \
  -d '{"content": "Manual test"}' \
  "$(op read 'op://Kubernetes/Discord Webhook Incidents/credential')"
```

### Email not being sent

```bash
# Check SMTP errors
kubectl-homelab -n monitoring logs -l app.kubernetes.io/name=alertmanager | grep -i smtp

# Common issues:
# - Wrong username (must be @icloud.com, not custom domain)
# - App-specific password expired
# - TLS handshake failure
```

---

## Files Reference

| File | Purpose |
|------|---------|
| `helm/prometheus/values.yaml` | Alertmanager config (routes, receivers) |
| `scripts/upgrade-prometheus.sh` | Upgrade script with 1Password integration |
| `manifests/monitoring/test-alert.yaml` | Test alerts for verification |

---

## Next Steps

- [v0.6.0-home-services.md](v0.6.0-home-services.md) ‚Äî Home Services & Dead Man's Switch
