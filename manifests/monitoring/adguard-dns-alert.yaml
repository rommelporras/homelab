# AdGuard DNS alert rule
# Phase 4.8.1: Alert when DNS probe fails (L2 lease misalignment)
#
# This catches the failure mode where:
#   - AdGuard pod is running and healthy
#   - But L2 lease is held by a different node
#   - externalTrafficPolicy: Local drops all traffic
#
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: adguard-dns-alerts
  namespace: monitoring
  labels:
    # Required for Prometheus Operator to discover this rule
    release: prometheus
    app.kubernetes.io/part-of: kube-prometheus-stack
spec:
  groups:
  - name: adguard-dns
    rules:
    - alert: AdGuardDNSUnreachable
      # job label comes from Probe's jobName field
      expr: probe_success{job="adguard-dns"} == 0
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "AdGuard DNS is unreachable"
        description: "External DNS probe to 10.10.30.53 has failed for 2+ minutes. Likely L2 lease on wrong node."
        runbook: |
          1. Check pod node:
             kubectl-homelab get pods -n home -l app=adguard-home -o wide

          2. Check L2 lease holder:
             kubectl-homelab get leases -n kube-system cilium-l2announce-home-adguard-dns -o jsonpath='{.spec.holderIdentity}'

          3. If pod node != lease holder, delete lease to force re-election:
             kubectl-homelab delete lease -n kube-system cilium-l2announce-home-adguard-dns

          4. Verify DNS resolution restored:
             dig @10.10.30.53 google.com
