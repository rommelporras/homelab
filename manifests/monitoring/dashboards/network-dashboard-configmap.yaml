# Grafana Dashboard - Network Throughput (1GbE vs 2.5GbE Decision)
# Monitors NIC utilization across cluster nodes to determine if 2.5GbE upgrade is justified
# Data source: node_network_* metrics from node-exporter (via kube-prometheus-stack)
# Auto-provisioned via grafana_dashboard label
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: network-dashboard
  namespace: monitoring
  annotations:
    grafana_folder: "Homelab"
  labels:
    grafana_dashboard: "1"
    app.kubernetes.io/name: grafana
    app.kubernetes.io/part-of: kube-prometheus-stack
data:
  network-throughput.json: |
    {
      "annotations": {
        "list": []
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "links": [],
      "panels": [
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
          },
          "id": 1,
          "title": "NIC Utilization",
          "description": "NIC utilization as percentage of link speed \u2014 used to determine if 2.5GbE upgrade is needed",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "min": 0,
              "max": 100,
              "noValue": "N/A",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 50
                  },
                  {
                    "color": "orange",
                    "value": 80
                  },
                  {
                    "color": "red",
                    "value": 95
                  }
                ]
              }
            }
          },
          "gridPos": {
            "h": 6,
            "w": 24,
            "x": 0,
            "y": 1
          },
          "id": 2,
          "options": {
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ]
            },
            "orientation": "auto",
            "showThresholdLabels": false,
            "showThresholdMarkers": true
          },
          "title": "NIC Utilization % (Current)",
          "description": "Current NIC utilization as percentage of 1GbE link speed (125 MB/s). >80% sustained = consider 2.5GbE upgrade.",
          "type": "gauge",
          "targets": [
            {
              "expr": "sum by () ((rate(node_network_receive_bytes_total{instance=\"10.10.30.11:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.11:9100\", device=\"eno1\"}[5m])) / 125000000 * 100)",
              "legendFormat": "cp1",
              "instant": true,
              "range": false,
              "refId": "A"
            },
            {
              "expr": "sum by () ((rate(node_network_receive_bytes_total{instance=\"10.10.30.12:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.12:9100\", device=\"eno1\"}[5m])) / 125000000 * 100)",
              "legendFormat": "cp2",
              "instant": true,
              "range": false,
              "refId": "B"
            },
            {
              "expr": "sum by () ((rate(node_network_receive_bytes_total{instance=\"10.10.30.13:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.13:9100\", device=\"eno1\"}[5m])) / 125000000 * 100)",
              "legendFormat": "cp3",
              "instant": true,
              "range": false,
              "refId": "C"
            }
          ]
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "noValue": "N/A",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "orange",
                    "value": 80
                  },
                  {
                    "color": "red",
                    "value": 95
                  }
                ]
              }
            }
          },
          "gridPos": {
            "h": 4,
            "w": 12,
            "x": 0,
            "y": 7
          },
          "id": 3,
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "justifyMode": "center",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ]
            },
            "textMode": "auto"
          },
          "title": "Peak Utilization (24h)",
          "description": "Maximum NIC utilization in the last 24 hours. Shows the highest point per node — if consistently high, consider 2.5GbE upgrade.",
          "type": "stat",
          "targets": [
            {
              "expr": "max by () (max_over_time(((rate(node_network_receive_bytes_total{instance=\"10.10.30.11:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.11:9100\", device=\"eno1\"}[5m])) / 125000000 * 100)[24h:5m]))",
              "legendFormat": "cp1",
              "instant": true,
              "range": false,
              "refId": "A"
            },
            {
              "expr": "max by () (max_over_time(((rate(node_network_receive_bytes_total{instance=\"10.10.30.12:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.12:9100\", device=\"eno1\"}[5m])) / 125000000 * 100)[24h:5m]))",
              "legendFormat": "cp2",
              "instant": true,
              "range": false,
              "refId": "B"
            },
            {
              "expr": "max by () (max_over_time(((rate(node_network_receive_bytes_total{instance=\"10.10.30.13:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.13:9100\", device=\"eno1\"}[5m])) / 125000000 * 100)[24h:5m]))",
              "legendFormat": "cp3",
              "instant": true,
              "range": false,
              "refId": "C"
            }
          ]
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "unit": "short",
              "noValue": "0",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "orange",
                    "value": 5
                  },
                  {
                    "color": "red",
                    "value": 20
                  }
                ]
              }
            }
          },
          "gridPos": {
            "h": 4,
            "w": 12,
            "x": 12,
            "y": 7
          },
          "id": 4,
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "justifyMode": "center",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ]
            },
            "textMode": "auto"
          },
          "title": "Time Above 80% (24h)",
          "description": "Number of 5-minute intervals where NIC utilization exceeded 80% in the last 24 hours. High values indicate sustained saturation. 0 = healthy.",
          "type": "stat",
          "targets": [
            {
              "expr": "max by () (count_over_time(((rate(node_network_receive_bytes_total{instance=\"10.10.30.11:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.11:9100\", device=\"eno1\"}[5m])) / 125000000 * 100 > 80)[24h:5m])) or vector(0)",
              "legendFormat": "cp1",
              "instant": true,
              "range": false,
              "refId": "A"
            },
            {
              "expr": "max by () (count_over_time(((rate(node_network_receive_bytes_total{instance=\"10.10.30.12:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.12:9100\", device=\"eno1\"}[5m])) / 125000000 * 100 > 80)[24h:5m])) or vector(0)",
              "legendFormat": "cp2",
              "instant": true,
              "range": false,
              "refId": "B"
            },
            {
              "expr": "max by () (count_over_time(((rate(node_network_receive_bytes_total{instance=\"10.10.30.13:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.13:9100\", device=\"eno1\"}[5m])) / 125000000 * 100 > 80)[24h:5m])) or vector(0)",
              "legendFormat": "cp3",
              "instant": true,
              "range": false,
              "refId": "C"
            }
          ]
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "min": 0,
              "max": 100,
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 15,
                "lineWidth": 2
              }
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "80% Threshold"
                },
                "properties": [
                  {
                    "id": "custom.lineStyle",
                    "value": {
                      "fill": "dash",
                      "dash": [
                        10,
                        10
                      ]
                    }
                  },
                  {
                    "id": "custom.fillOpacity",
                    "value": 0
                  },
                  {
                    "id": "custom.lineWidth",
                    "value": 1
                  },
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "red",
                      "mode": "fixed"
                    }
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 11
          },
          "id": 13,
          "title": "NIC Utilization % Over Time",
          "description": "NIC utilization as percentage of 1GbE link speed over time. Dashed red line at 80% — sustained traffic above this threshold indicates a 2.5GbE upgrade may be needed.",
          "type": "timeseries",
          "targets": [
            {
              "expr": "sum by () ((rate(node_network_receive_bytes_total{instance=\"10.10.30.11:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.11:9100\", device=\"eno1\"}[5m])) / 125000000 * 100)",
              "legendFormat": "cp1",
              "refId": "A"
            },
            {
              "expr": "sum by () ((rate(node_network_receive_bytes_total{instance=\"10.10.30.12:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.12:9100\", device=\"eno1\"}[5m])) / 125000000 * 100)",
              "legendFormat": "cp2",
              "refId": "B"
            },
            {
              "expr": "sum by () ((rate(node_network_receive_bytes_total{instance=\"10.10.30.13:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.13:9100\", device=\"eno1\"}[5m])) / 125000000 * 100)",
              "legendFormat": "cp3",
              "refId": "C"
            },
            {
              "expr": "vector(80)",
              "legendFormat": "80% Threshold",
              "refId": "D"
            }
          ]
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 19
          },
          "id": 10,
          "title": "Throughput",
          "description": "Network throughput in Mbps across all cluster nodes",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "unit": "Mbits",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 15,
                "lineWidth": 2,
                "stacking": {
                  "mode": "none"
                }
              }
            }
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 20
          },
          "id": 11,
          "title": "Total Throughput (Mbps)",
          "description": "Combined RX + TX throughput per node physical NIC. 1GbE max = 1000 Mbps.",
          "type": "timeseries",
          "targets": [
            {
              "expr": "sum by () ((rate(node_network_receive_bytes_total{instance=\"10.10.30.11:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.11:9100\", device=\"eno1\"}[5m])) * 8 / 1000000)",
              "legendFormat": "cp1",
              "refId": "A"
            },
            {
              "expr": "sum by () ((rate(node_network_receive_bytes_total{instance=\"10.10.30.12:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.12:9100\", device=\"eno1\"}[5m])) * 8 / 1000000)",
              "legendFormat": "cp2",
              "refId": "B"
            },
            {
              "expr": "sum by () ((rate(node_network_receive_bytes_total{instance=\"10.10.30.13:9100\", device=\"eno1\"}[5m]) + rate(node_network_transmit_bytes_total{instance=\"10.10.30.13:9100\", device=\"eno1\"}[5m])) * 8 / 1000000)",
              "legendFormat": "cp3",
              "refId": "C"
            }
          ]
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "unit": "Mbits",
              "custom": {
                "drawStyle": "line",
                "fillOpacity": 15,
                "lineWidth": 2,
                "stacking": {
                  "mode": "normal"
                }
              }
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byRegexp",
                  "options": ".*TX.*"
                },
                "properties": [
                  {
                    "id": "custom.transform",
                    "value": "negative-Y"
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byRegexp",
                  "options": "cp1.*"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "green",
                      "mode": "fixed"
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byRegexp",
                  "options": "cp2.*"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "blue",
                      "mode": "fixed"
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byRegexp",
                  "options": "cp3.*"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "orange",
                      "mode": "fixed"
                    }
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 20
          },
          "id": 12,
          "title": "RX vs TX per Node (Mbps)",
          "description": "Receive (positive) vs Transmit (negative) traffic per node. Stacked view shows total bandwidth direction.",
          "type": "timeseries",
          "targets": [
            {
              "expr": "sum by () (rate(node_network_receive_bytes_total{instance=\"10.10.30.11:9100\", device=\"eno1\"}[5m]) * 8 / 1000000)",
              "legendFormat": "cp1 RX",
              "refId": "A"
            },
            {
              "expr": "sum by () (rate(node_network_transmit_bytes_total{instance=\"10.10.30.11:9100\", device=\"eno1\"}[5m]) * 8 / 1000000)",
              "legendFormat": "cp1 TX",
              "refId": "B"
            },
            {
              "expr": "sum by () (rate(node_network_receive_bytes_total{instance=\"10.10.30.12:9100\", device=\"eno1\"}[5m]) * 8 / 1000000)",
              "legendFormat": "cp2 RX",
              "refId": "C"
            },
            {
              "expr": "sum by () (rate(node_network_transmit_bytes_total{instance=\"10.10.30.12:9100\", device=\"eno1\"}[5m]) * 8 / 1000000)",
              "legendFormat": "cp2 TX",
              "refId": "D"
            },
            {
              "expr": "sum by () (rate(node_network_receive_bytes_total{instance=\"10.10.30.13:9100\", device=\"eno1\"}[5m]) * 8 / 1000000)",
              "legendFormat": "cp3 RX",
              "refId": "E"
            },
            {
              "expr": "sum by () (rate(node_network_transmit_bytes_total{instance=\"10.10.30.13:9100\", device=\"eno1\"}[5m]) * 8 / 1000000)",
              "legendFormat": "cp3 TX",
              "refId": "F"
            }
          ]
        }
      ],
      "schemaVersion": 39,
      "tags": [
        "network",
        "infrastructure"
      ],
      "templating": {
        "list": []
      },
      "refresh": "30s",
      "time": {
        "from": "now-24h",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "Asia/Manila",
      "title": "Network Throughput (1GbE vs 2.5GbE)",
      "uid": "network-throughput"
    }
